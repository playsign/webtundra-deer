/** Copyright realXtend project - http://realxtend.org/

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
*/

var define = define || function define(moduleName, deps, module) {
    if (module !== undefined)
        console.warn("You are trying to define a module " + moduleName + " not supported in the Meshmoon WebRocket SDK build");
};

function BitArray(e,t){t===undefined&&(t=0),this.size=e,this.field=new Array(~~((e-1)/BitArray.ELEMENT_WIDTH)+1);for(var n=0;n<this.field.length;n++)this.field[n]=t==0?0:(t<<BitArray.ELEMENT_WIDTH)-1}(function(e){function o(e){return!s||/\B\$super\b/.test(e.toString())}function u(t,n,r){r===e?delete t[n]:t[n]=r}function a(t,n){return Object.prototype.hasOwnProperty.call(t,n)?t[n]:e}function f(e){i=!0;var t=new e;return i=!1,t}var t="1.4",n=this,r=n.Class,i=!1,s=function(){$super()}.toString().indexOf("$super")>0,l=function(){};l.$noConflict=function(){try{u(n,"Class",r)}catch(e){n.Class=r}return l},l.$classyVersion=t,l.$extend=function(t){var r=this.prototype,s=f(this);if(t.__include__)for(var c=0,h=t.__include__.length;c!=h;++c){var p=t.__include__[c];for(var d in p){var v=a(p,d);v!==e&&(s[d]=p[d])}}t.__classvars__=t.__classvars__||{};if(s.__classvars__)for(var m in s.__classvars__)if(!t.__classvars__[m]){var v=a(s.__classvars__,m);t.__classvars__[m]=v}for(var d in t){var v=a(t,d);if(d==="__include__"||v===e)continue;s[d]=typeof v=="function"&&o(v)?function(e,t){return function(){var n=a(this,"$super");this.$super=r[t];try{return e.apply(this,arguments)}finally{u(this,"$super",n)}}}(v,d):v}var g=function(){if(i)return;var e=n===this?f(arguments.callee):this;return e.__init__&&e.__init__.apply(e,arguments),e.$class=g,e};for(var m in t.__classvars__){var v=a(t.__classvars__,m);v!==e&&(g[m]=v)}return g.prototype=s,g.constructor=g,g.$extend=l.$extend,g.$withData=l.$withData,g},l.$withData=function(t){var n=f(this);for(var r in t){var i=a(t,r);i!==e&&(n[r]=i)}return n},n.Class=l})();var TundraSDK={framework:{client:null,network:null,scene:null,renderer:null,frame:null,events:null,asset:null,input:null,ui:null,console:null},plugins:[],registerPlugin:function(e){if(e===undefined||e===null)return;e._setFramework(this.framework),this.plugins.push(e)},plugin:function(e){for(var t=0;t<this.plugins.length;t++)if(this.plugins[t].name===e)return this.plugins[t];return null},browser:{isChrome:navigator!==undefined?navigator.userAgent.indexOf("Chrome")>-1:!1,isExplorer:navigator!==undefined?navigator.userAgent.indexOf("MSIE")>-1:!1,isFirefox:navigator!==undefined?navigator.userAgent.indexOf("Firefox")>-1:!1,isSafari:navigator!==undefined?navigator.userAgent.indexOf("Safari")>-1:!1,isOpera:navigator!==undefined?navigator.userAgent.indexOf("Presto")>-1||navigator.userAgent.indexOf("Opera")>-1||navigator.userAgent.indexOf("OPR/")>-1:!1},debugOnCheckFail:!1,throwOnCheckFail:!1,checkDefined:function(){if(!TundraSDK.debugOnCheckFail&&!TundraSDK.throwOnCheckFail)return;for(var e=0;e<arguments.length;e++)if(arguments[e]===undefined)if(TundraSDK.debugOnCheckFail)debugger;else if(TundraSDK.throwOnCheckFail)throw"undefined value, arg #"+e},check:function(){if(!TundraSDK.debugOnCheckFail&&!TundraSDK.throwOnCheckFail)return;for(var e=0;e<arguments.length;e++)if(arguments[e]!==!0)if(TundraSDK.debugOnCheckFail)debugger;else if(TundraSDK.throwOnCheckFail)throw"untrue value"+arguments[e]+", arg #"+e}};window.TundraSDK=TundraSDK;var _hackLogLevelPending=null,TundraLogger=Class.$extend({__init__:function(e){this.name=e,this.prefix="["+e+"]:"},_createArguments:function(e,t){var n=[].slice.call(e);return n.splice(0,0,this.prefix),t===!0&&n.splice(0,0,this._callerLine()),n},_createArgumentsString:function(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n];Array.isArray(r)?t.push("["+r.join(", ")+"]"):typeof r=="object"?t.push(JSON.stringify(r)):t.push(r.toString())}return t.join(" ")},_callerLineLink:function(e){e===undefined&&(e=4);var t=(new Error).stack.split("\n")[e];return t=t.substring(t.indexOf("at ")+3),t.substring(t.lastIndexOf("(")+1,t.length-1)},info:function(){log.info.apply(null,this._createArguments(arguments))},infoC:function(){var e=this._createArguments(arguments);log.info.apply(null,e),TundraSDK.framework.console!=null&&TundraSDK.framework.console.logInfo(this._createArgumentsString(e))},warn:function(){log.warn.apply(null,this._createArguments(arguments))},warnC:function(){var e=this._createArguments(arguments);log.warn.apply(null,e),TundraSDK.framework.console!=null&&TundraSDK.framework.console.logWarning(this._createArgumentsString(e))},error:function(){log.error.apply(null,this._createArguments(arguments))},errorC:function(){var e=this._createArguments(arguments);log.error.apply(null,e),TundraSDK.framework.console!=null&&TundraSDK.framework.console.logError(this._createArgumentsString(e))},debug:function(){log.debug.apply(null,this._createArguments(arguments))},trace:function(){log.trace.apply(null,this._createArguments(arguments))}}),TundraLogging={Level:{TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},loggers:[],getLogger:function(e){for(var t=0;t<this.loggers.length;t++)if(this.loggers[t].name===e)return this.loggers[t];var n=new TundraLogger(e);return this.loggers.push(n),n},enableAll:function(){log.enableAll()},disableAll:function(){log.disableAll()},setLevel:function(e){log.setLevel(e),log.debug("[Logging]: Setting log level to",this.levelString(e))},levelString:function(e){if(typeof e=="string")return e;if(typeof e=="number")for(var t in TundraLogging.Level)if(e===TundraLogging.Level[t])return t;return"Invalid loglevel "+e.toString()}},CoreStringUtils={startsWith:function(e,t,n){return n===!0?e.toLowerCase().indexOf(t.toLowerCase())===0:e.indexOf(t)===0},endsWith:function(e,t,n){var r=e.length-t.length;return n===!0?r>-1&&e.toLowerCase().substring(r)===t.toLowerCase():r>-1&&e.substring(r)===t},trim:function(e){return e.trim?e.trim():e.replace(/^\s+/,"").replace(/\s+$/,"")},trimLeft:function(e){return e.trimLeft?e.trimLeft():e.replace(/^\s+/,"")},trimStringLeft:function(e,t){var n=t.length;while(e.length>0&&e.substring(0,n)===t)e=e.substring(n);return e},trimRight:function(e){return e.trimRight?e.trimRight():e.replace(/\s+$/,"")},trimStringRight:function(e,t){var n=t.length;while(e.length>0&&e.substring(e.length-n)===t)e=e.substring(0,e.length-n);return e},readLine:function(e,t,n,r){n===undefined&&(n=!1),r===undefined&&(r=!1);var i=null,s=e.indexOf("\n"),o=e.indexOf("\r\n"),u=n===!0?e.indexOf("	"):-1,a=t!=null?e.indexOf(t):-1;if(i==null||s!==-1&&s<i)i=s;if(i==null||o!==-1&&o<i)i=o;if(i==null||u!==-1&&u<i)i=u;if(i==null||a!==-1&&a<i)i=a;var f=i!==-1?e.substring(0,i):"";return r===!0&&(f=this.trim(f)),f},extension:function(e){return e.substring(e.lastIndexOf(".")).toLowerCase()},removeComments:function(e){if(e==null||e.length===0)return e;var t=e.indexOf("/*");if(t!==-1){var n=e.indexOf("*/",t+2);while(t!==-1&&n!==-1){var r=e.substring(0,t),i=e.substring(n+2);e=r+i,t=e.indexOf("/*"),t!==-1&&(n=e.indexOf("*/",t+2))}}var s=/^\s*\/\/.*/gm;return s.test(e)&&(e=e.replace(s,"")),e}},IRenderSystem=Class.$extend({__init__:function(e){this.name=e},__classvars__:{register:function(e){var t=new this;return e.registerRenderSystem(t)?t:null}},_load:function(e){TundraLogging.getLogger("IRenderSystem").info("Loading "+this.name+" render system"),this.load(e)},load:function(e){},_unload:function(){TundraLogging.getLogger("IRenderSystem").info("Unloading "+this.name+" render system"),this.unload()},unload:function(){},postInitialize:function(){},setActiveCamera:function(e){TundraLogging.getLogger("IRenderSystem").warn("setActiveCamera() not implemented.")},activeCamera:function(){return TundraLogging.getLogger("IRenderSystem").warn("activeCamera() not implemented."),null},activeCameraEntity:function(){return TundraLogging.getLogger("IRenderSystem").warn("activeCameraEntity() not implemented."),null},createSceneNode:function(){return TundraLogging.getLogger("IRenderSystem").warn("createSceneNode() not implemented."),null},updateSceneNode:function(e,t){TundraLogging.getLogger("IRenderSystem").warn("updateSceneNode() not implemented.")},raycastAllFrom:function(e,t,n){return TundraLogging.getLogger("IRenderSystem").warn("raycastAllFrom() not implemented."),null},raycastFrom:function(e,t,n){return TundraLogging.getLogger("IRenderSystem").warn("raycastFrom() not implemented."),null},raycastAll:function(e,t,n){return TundraLogging.getLogger("IRenderSystem").warn("raycastAll() not implemented."),null},raycast:function(e,t,n){return TundraLogging.getLogger("IRenderSystem").warn("raycast() not implemented."),null}}),IDomIntegration=Class.$extend({__init__:function(e){this.name=e},__classvars__:{register:function(e){var t=new this;return e.registerDomIntegration(t)?t:null}},_load:function(){TundraSDK.framework.client.log.info("Loading "+this.name+" DOM integration system"),this.load()},load:function(){},_unload:function(){TundraSDK.framework.client.log.info("Unloading "+this.name+" DOM integration system"),this.unload()},unload:function(){}});define("lib/three",function(){});var EasingCurve=Class.$extend({__init__:function(e,t){this.p0=new THREE.Vector2(0,0),this.p1=e||new THREE.Vector2(0,.5),this.p2=t||new THREE.Vector2(1,.5),this.p3=new THREE.Vector2(1,1)},getTime:function(e){e=Math.min(Math.max(e,0),1);var t=this.p0.clone().lerp(this.p1,e),n=this.p1.clone().lerp(this.p2,e),r=this.p2.clone().lerp(this.p3,e);return t.lerp(n,e),n.lerp(r,e),t.lerp(n,e).x}}),IApplication=Class.$extend({__init__:function(e){e==null&&(TundraSDK.framework.client.log.warn("[IApplication]: Constructor called without a valid application name!",!0),e="Unknown Application"),TundraSDK.framework.client.log.info("Starting "+e+" application"),this.log=TundraLogging.getLogger(e),this.framework=TundraSDK.framework,this.name=e,this.assetRef=IApplication.assetRef,this.entity=IApplication.entity,this.component=IApplication.component,this.eventSubscriptions=[],this.startupApplication=IApplication.startupApplication;try{IApplication.parentScriptAsset!==undefined&&IApplication.parentScriptAsset!==null&&IApplication.parentScriptAsset._setApplication(this)}catch(t){console.error("[IApplication]: Failed to register "+this.name+": "+t),t.stack!==undefined&&console.error(t)}},__classvars__:{entity:null,component:null,assetRef:null,startupApplication:null,parentScriptAsset:null,_setupStatic:function(e,t,n,r,i){IApplication.assetRef=n,IApplication.entity=e,IApplication.component=t,IApplication.startupApplication=r,IApplication.parentScriptAsset=i},_resetStatic:function(){IApplication.entity=null,IApplication.component=null,IApplication.assetRef=null,IApplication.startupApplication=null,IApplication.parentScriptAsset=null}},_onScriptDestroyed:function(){this.onScriptDestroyed(),this.name=null,this.assetRef=null,this.entity=null,this.component=null,this.startupApplication=null,this.framework=null,this.unsubscribeEvents()},onScriptDestroyed:function(){},subscribeEvent:function(e){this.eventSubscriptions.push(e)},unsubscribeEvents:function(){for(var e=0;e<this.eventSubscriptions.length;e++)TundraSDK.framework.events.unsubscribe(this.eventSubscriptions[e]);this.eventSubscriptions=[]}});window.IApplication=IApplication;var ICameraApplication=IApplication.$extend({__init__:function(e,t){t===undefined&&(t=!0),t===!0&&this.$super(e),this.cameraEntity=null,this.cameraApplicationState={applicationName:"",animateActivation:!1,animationT:0,animationDuration:2,animationStartTransform:null,animationEndTransform:null,previousCameraEntity:null,onUpdateSub:null,animationStart:null,animationStop:null,easing:new EasingCurve}},__classvars__:{cameraApplicationTooltip:null,showCameraApplicationInfoTooltipEnabled:!0,showCameraApplicationInfoTooltip:function(e,t){var n=TundraSDK.plugin("LoginScreenPlugin");if(n!=null&&n.isLoadingScreenVisible())return;if(!ICameraApplication.showCameraApplicationInfoTooltipEnabled)return;t===undefined&&(t=2e3),ICameraApplication.cameraApplicationTooltip==null&&(ICameraApplication.cameraApplicationTooltip=$("<div/>",{id:"webtundra-camera-application-tooltip"}),ICameraApplication.cameraApplicationTooltip.css(ICameraApplication.cameraTooltipCSS),ICameraApplication.cameraApplicationTooltip.position({my:"center top",at:"center-100 top+10",of:TundraSDK.framework.client.container}),ICameraApplication.cameraApplicationTooltip.hide(),TundraSDK.framework.ui.addWidgetToScene(ICameraApplication.cameraApplicationTooltip),ICameraApplication.cameraApplicationTooltip.fadeIn());var r=e+" Camera";ICameraApplication.overrideCameraApplicationInfoTooltipText&&(r=ICameraApplication.overrideCameraApplicationInfoTooltipText(r)),ICameraApplication.cameraApplicationTooltip.text(r),ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId!==undefined&&clearTimeout(ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId),ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId=setTimeout(function(){ICameraApplication.cameraApplicationTooltip!=null&&(ICameraApplication.cameraApplicationTooltip.fadeOut(function(){$(this).remove()}),ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId=undefined,ICameraApplication.cameraApplicationTooltip=null)},t)},overrideCameraApplicationInfoTooltipText:function(e){return e},cameraTooltipCSS:{border:"1px solid grey","text-align":"center","min-width":200,"border-radius":4,padding:3,"padding-left":5,"padding-right":5,position:"absolute",width:"auto","font-family":"Arial","font-size":"14pt","font-weight":"bold",color:"color: rgb(56,56,56)","background-color":"rgba(248, 248, 248, 0.85)"}},_onScriptDestroyed:function(){this.$super(),this.resetCameraApplication()},startCameraApplication:function(e,t,n,r){if(e===undefined){console.error("[ICameraApplication]: createCameraEntity must pass applicationName eg. 'Avatar' and entity name eg. 'AvatarCamera'!");return}return r===undefined&&(r=!0),this.cameraEntity==null&&(this.cameraApplicationState.applicationName=e,this.cameraEntity=TundraSDK.framework.scene.createLocalEntity(["Name","Placeable","Camera"]),this.cameraEntity.name=t,n!==undefined&&typeof n=="number"&&(this.cameraEntity.camera.verticalFov=n),this.subscribeEvent(TundraSDK.framework.renderer.onActiveCameraChanged(this,this._onActiveCameraChanged)),r===!0&&TundraSDK.framework.client.registerCameraApplication(e,this)),this.cameraEntity},resetCameraApplication:function(){this._subCameraAnimationFrameUpdates(!0),this.cameraEntity=null},animateBeforeActivation:function(e){typeof e=="boolean"&&(this.cameraApplicationState.animateActivation=e)},_subCameraAnimationFrameUpdates:function(e){e===undefined&&(e=!1),this.cameraApplicationState.onUpdateSub!=null&&TundraSDK.framework.events.unsubscribe(this.cameraApplicationState.onUpdateSub),e===!1?this.cameraApplicationState.onUpdateSub=TundraSDK.framework.frame.onUpdate(this,this._onCameraAnimationUpdate):this.cameraEntity!=null&&this.cameraEntity.camera!=null&&(this.cameraEntity.camera._animating=!1)},_onCameraStepAnimation:function(e){var t=this.cameraApplicationState,n=t.animationStart.pos.clone();n.lerp(t.animationStop.pos.clone(),e);var r=t.animationStart.rot.clone();r.slerp(t.animationStop.rot.clone(),e),r.normalize(),this.cameraEntity.placeable.setPosition(n),this.cameraEntity.placeable.setRotation(r),e>=1&&this.cameraEntity.placeable.setRotation(t.animationStop.rotDegrees)},_onCameraAnimationUpdate:function(e){var t=this.cameraApplicationState;if(!(t.animationT<t.animationDuration)){this._onCameraStepAnimation(1),this._subCameraAnimationFrameUpdates(!0),this.onCameraActived(this.cameraEntity,t.previousCameraEntity),t.animationT=0,t.previousCameraEntity=null,t.animationStart=null,t.animationStop=null;return}var n=t.easing.getTime(t.animationT/t.animationDuration);this._onCameraStepAnimation(n),t.animationT+=e},_activateCameraApplication:function(){this.cameraEntity!=null&&this.cameraEntity.camera!=null&&this.cameraEntity.camera.setActive()},_onActiveCameraChanged:function(e,t){if(e===undefined||e===null)return;e===this.cameraEntity.camera?this._onCameraActived(this.cameraEntity,t!==undefined?t.parentEntity:undefined):t===this.cameraEntity.camera&&(this._subCameraAnimationFrameUpdates(!0),this.onCameraDeactived(this.cameraEntity,e.parentEntity))},_onCameraActived:function(e,t){ICameraApplication.showCameraApplicationInfoTooltip(this.cameraApplicationState.applicationName);if(this.cameraApplicationState.animateActivation===!1||t==null||t.placeable==null||e.placeable==null)this.onCameraActived(e,t);else{if(typeof e.placeable.parentRef!="string"||typeof t.placeable.parentRef!="string"||e.placeable.parentRef!==""||t.placeable.parentRef!==""){this.onCameraActived(e,t);return}this.cameraApplicationState.animationT=0,this.cameraApplicationState.previousCameraEntity=t,this.cameraApplicationState.animationStart={pos:t.placeable.worldPosition(),rot:t.placeable.worldOrientation()},this.cameraApplicationState.animationStop={pos:e.placeable.worldPosition(),rot:e.placeable.worldOrientation(),rotDegrees:e.placeable.transform.rot.clone()},e.placeable.setPosition(this.cameraApplicationState.animationStart.pos),e.placeable.setRotation(this.cameraApplicationState.animationStart.rot),e.camera._animating=!0,this._subCameraAnimationFrameUpdates(!1)}},onCameraActived:function(e,t){},onCameraDeactived:function(e,t){}});window.ICameraApplication=ICameraApplication,BitArray.ELEMENT_WIDTH=24,BitArray.prototype.set=function(e,t){t==1?this.field[~~(e/BitArray.ELEMENT_WIDTH)]|=1<<e%BitArray.ELEMENT_WIDTH:this.field[~~(e/BitArray.ELEMENT_WIDTH)]&1<<e%BitArray.ELEMENT_WIDTH&&(this.field[~~(e/BitArray.ELEMENT_WIDTH)]^=1<<e%BitArray.ELEMENT_WIDTH)},BitArray.prototype.get=function(e){return(this.field[~~(e/BitArray.ELEMENT_WIDTH)]&1<<e%BitArray.ELEMENT_WIDTH)>0?1:0},BitArray.prototype.each=function(e){for(var t=0;t<this.size;t++)e(this.get(t),t)},BitArray.prototype.toString=function(){var e=this.field.map(function(e){var t=e.toString(2);return t=(new Array(BitArray.ELEMENT_WIDTH-t.length+1)).join("0")+t,t}).reverse().join("");return e.split("").reverse().join("").slice(0,this.size)};var DataDeserializer=Class.$extend({__init__:function(e,t,n){this.bytePos=0,this.bitPos=0,e!==undefined&&this.setBuffer(e,t,n)},__classvars__:{floatReadDataView:new DataView(new ArrayBuffer(4)),doubleReadDataView:new DataView(new ArrayBuffer(8)),readByteFromBits:function(e,t){var n=0;for(var r=0;r<8;++r){var i=e.get(t+r);i===1?n|=1<<r:n&=~(1<<r)}return n}},setBuffer:function(e,t,n){n===undefined?this.data=new DataView(e,t):this.data=new DataView(e,t,n),this.bytePos=0,this.bitPos=0},readUint8Array:function(e){var t=new Uint8Array(this.data.buffer,this.bytePos,e);return this.bytePos+=e,t},bytesRead:function(){return this.bytePos},readBytes:function(){return this.bytesRead()},bytesLeft:function(){return this.bytePos>=this.data.byteLength?0:this.data.byteLength-this.bytePos},bitsLeft:function(){return this.bytePos>=this.data.byteLength?0:(this.data.byteLength-this.bytePos)*8-this.bitPos},skipBytes:function(e){this.bytePos+=e},readBoolean:function(){return this.readU8()>0},readBool:function(){return this.readBoolean()},readUtf8CharCode:function(){var e,t,n,r,i;return e=this.readU8(),e<128?e:e<224?(t=this.readU8(),t&63|(e&31)<<6):e<240?(t=this.readU8(),n=this.readU8(),n&63|(t&63)<<6|(e&15)<<12):e<248?(t=this.readU8(),n=this.readU8(),r=this.readU8(),r&63|(n&63)<<6|(t&63)<<12|(e&7)<<18):e<252?(t=this.readU8(),n=this.readU8(),r=this.readU8(),i=this.readU8(),i&63|(r&63)<<6|(n&63)<<12|(t&63)<<18|(e&3)<<24):(t=this.readU8(),n=this.readU8(),r=this.readU8(),i=this.readU8(),char6=this.readU8(),char6&63|(i&63)<<6|(r&63)<<12|(n&63)<<18|(t&63)<<24|(e&1)<<30)},readStringUntil:function(e,t){var n="";while(this.bytesLeft()>0){var r=this.readU8(),i=String.fromCharCode(r);if(t!==undefined&&r===t)break;if(e!==undefined&&i===e)break;n+=i}return n},readString:function(e,t){typeof t!="boolean"&&(t=!1);var n="";if(e>0){var r=this.bytePos+e;if(t)while(this.bytePos<r)n+=String.fromCharCode(this.readUtf8CharCode(r-this.bytePos));else while(this.bytePos<r)n+=String.fromCharCode(this.readU8())}return n},readStringU8:function(e){return this.readString(this.readU8(),e)},readStringU16:function(e){return this.readString(this.readU16(),e)},readStringU32:function(e){return this.readString(this.readU32(),e)},readS8:function(){if(this.bitPos===0){var e=this.data.getInt8(this.bytePos);return this.bytePos+=1,e}var t=this.readBits(8);return t>=128&&(t-=256),t},readU8:function(){if(this.bitPos===0){var e=this.data.getUint8(this.bytePos);return this.bytePos+=1,e}return this.readBits(8)},readS16:function(){if(this.bitPos===0){var e=this.data.getInt16(this.bytePos);return this.bytePos+=2,e}var t=this.readBits(16);return t>=32768&&(t-=65536),t},readU16:function(){if(this.bitPos===0){var e=this.data.getUint16(this.bytePos,!0);return this.bytePos+=2,e}return this.readBits(16)},readS32:function(){if(this.bitPos===0){var e=this.data.getInt32(this.bytePos,!0);return this.bytePos+=4,e}var t=this.readBits(32);return t>=2147483648&&(t-=4294967296),t},readU32:function(){if(this.bitPos===0){var e=this.data.getUint32(this.bytePos,!0);return this.bytePos+=4,e}return this.readBits(32)},readFloat32:function(){if(this.bitPos===0){var e=this.data.getFloat32(this.bytePos,!0);return this.bytePos+=4,e}return DataDeserializer.floatReadDataView.setUint32(0,this.readBits(32),!0),DataDeserializer.floatReadDataView.getFloat32(0,!0)},readFloat64:function(){if(this.bitPos===0){var e=this.data.getFloat64(this.bytePos,!0);return this.bytePos+=8,e}return DataDeserializer.doubleReadDataView.setUint32(0,this.readBits(32),!0),DataDeserializer.doubleReadDataView.setUint32(4,this.readBits(32),!0),DataDeserializer.doubleReadDataView.getFloat64(0,!0)},readFloat32Vector3:function(){return{x:this.readFloat32(),y:this.readFloat32(),z:this.readFloat32()}},readFloat32Vector4:function(){return{x:this.readFloat32(),y:this.readFloat32(),z:this.readFloat32(),w:this.readFloat32()}},readVLE:function(){var e=this.readU8();if((e&128)===0)return e;e&=127;var t=this.readU8();if((t&128)===0)return e|t<<7;t&=127;var n=this.readU16();return e|t<<7|n<<14},readBit:function(){return this.readBits(1)},readBits:function(e){var t=0,n=0,r=this.data.getUint8(this.bytePos);while(e>0)r&1<<this.bitPos&&(t|=1<<n),n++,e--,this.bitPos++,this.bitPos>7&&(this.bitPos=0,this.bytePos++,e>0&&(r=this.data.getUint8(this.bytePos)));return t},readBitArray:function(e){var t=0,n=new BitArray(e*8,0);for(var r=0;r<e;++r){var i=this.readU8();for(var s=0;s<8;++s){var o=(~~i&1<<s)>0?1:0;n.set(t,o),t++}}return n},readUnsignedFixedPoint:function(e,t){var n=this.readBits(e+t);return n/(1<<t)},readSignedFixedPoint:function(e,t){return this.readUnsignedFixedPoint(e,t)-(1<<e-1)},readQuantizedFloat:function(e,t,n){var r=this.readBits(n);return e+r*(t-e)/((1<<n)-1)},readNormalizedVector2D:function(e){var t=this.readQuantizedFloat(-Math.PI,Math.PI,e);return{x:Math.cos(t),y:Math.sin(t)}},readVector2D:function(e,t,n){var r=this.readBits(e+t);if(r!==0){var i=r/(1<<t),s=this.readQuantizedFloat(-Math.PI,Math.PI,n);return{x:Math.cos(s)*i,y:Math.sin(s)*i}}return{x:0,y:0}},readNormalizedVector3D:function(e,t){var n=this.readQuantizedFloat(-Math.PI,Math.PI,e),r=this.readQuantizedFloat(-Math.PI/2,Math.PI/2,t),i=Math.cos(r);return{x:i*Math.sin(n),y:-Math.sin(r),z:i*Math.cos(n)}},readVector3D:function(e,t,n,r){var i=this.readBits(n+r);if(i!==0){var s=i/(1<<r),o=this.readQuantizedFloat(-Math.PI,Math.PI,e),u=this.readQuantizedFloat(-Math.PI/2,Math.PI/2,t),a=Math.cos(u);return{x:a*Math.sin(o)*s,y:-Math.sin(u)*s,z:a*Math.cos(o)*s}}return{x:0,y:0,z:0}},readArithmeticEncoded2:function(e,t,n){var r=[],i=this.readBits(e);return r[1]=i%n,r[0]=Math.floor(i/n),r},readArithmeticEncoded3:function(e,t,n,r){var i=[],s=this.readBits(e);return val3=s%r,s=Math.floor(s/r),i[1]=s%n,i[0]=Math.floor(s/n),i},readArithmeticEncoded4:function(e,t,n,r,i){var s=[],o=this.readBits(e);return s[3]=o%i,o=Math.floor(o/i),s[2]=o%r,o=Math.floor(o/r),s[1]=o%n,s[0]=Math.floor(o/n),s},readArithmeticEncoded5:function(e,t,n,r,i,s){var o=[],u=this.readBits(e);return o[4]=u%s,u=Math.floor(u/s),o[3]=u%i,u=Math.floor(u/i),o[2]=u%r,u=Math.floor(u/r),o[1]=u%n,o[0]=Math.floor(u/n),o}}),INetworkMessageHandler=Class.$extend({__init__:function(e){this.name=e},canHandle:function(e){return!1},handle:function(e,t){return!1}}),DataSerializer=Class.$extend({__init__:function(e,t){typeof e!="number"&&(TundraSDK.framework.client.logWarning("[DataSerializer]: You are creating a data serializer with undefined size! Initializing size to 0 bytes."),e=0),t=typeof t=="number"?t:DataSerializer.ArrayType.Uint8;if(t===DataSerializer.ArrayType.Uint8)this.array=new Uint8Array(e);else if(t===DataSerializer.ArrayType.Uint16)this.array=new Uint16Array(e);else if(t===DataSerializer.ArrayType.Uint32)this.array=new Uint32Array(e);else if(t===DataSerializer.ArrayType.Float32)this.array=new Float32Array(e);else{if(t!==DataSerializer.ArrayType.Float64){TundraSDK.framework.client.logError("[DataSerializer]: Unknown 'arrayType' "+t+". Use on of the supported ones from DataSerializer.ArrayType");return}this.array=new Float64Array(e)}this.data=new DataView(this.array.buffer),this.bytePos=0,this.bitPos=0,this.type=t},__classvars__:{floatWriteDataView:new DataView(new ArrayBuffer(4)),doubleWriteDataView:new DataView(new ArrayBuffer(8)),ArrayType:{Uint8:0,Uint16:1,Uint32:2,Float32:3,Float64:4},utf8StringByteSize:function(e){var t=0;for(var n=0,r=e.length;n<r;++n)t+=DataSerializer.utf8CharCodeByteSize(e.charCodeAt(n));return t},utf8CharCodeByteSize:function(e){return e<128?1:e<2048?2:e<65536?3:e<2097152?4:e<67108864?5:6},vleHeaderSizeBytes:function(e){return e<128?1:e<16384?2:4}},getBuffer:function(){return this.array.buffer},filledBytes:function(){return this.bitPos===0?this.bytePos:this.bytePos+1},filledBits:function(){return this.bytePos*8+this.bitPos},capacity:function(){return this.data.byteLength},bytesLeft:function(){return this.bytePos>=this.data.byteLength?0:this.data.byteLength-this.bytePos},bitsLeft:function(){return this.bytePos>=this.data.byteLength?0:(this.data.byteLength-this.bytePos)*8-this.bitPos},skipBytes:function(e){this.bytePos+=e},writeBoolean:function(e){this.writeU8(e===!0?1:0)},writeUint8Array:function(e){for(var t=0,n=e.length;t<n;++t)this.writeU8(e[t])},writeUtf8Char:function(e){e<128?this.writeU8(e):e<2048?(this.writeU8(192|e>>6&31),this.writeU8(128|e&63)):e<65536?(this.writeU8(224|e>>12&15),this.writeU8(128|e>>6&63),this.writeU8(128|e&63)):e<2097152?(this.writeU8(240|e>>18&7),this.writeU8(128|e>>12&63),this.writeU8(128|e>>6&63),this.writeU8(128|e&63)):e<67108864?(this.writeU8(248|e>>24&3),this.writeU8(128|e>>18&63),this.writeU8(128|e>>12&63),this.writeU8(128|e>>6&63),this.writeU8(128|e&63)):(this.writeU8(252|e>>30&1),this.writeU8(128|e>>24&63),this.writeU8(128|e>>18&63),this.writeU8(128|e>>12&63),this.writeU8(128|e>>6&63),this.writeU8(128|e&63))},writeStringWithHeader:function(e,t,n){typeof n!="boolean"&&(n=!1);var r=n?DataSerializer.utf8StringByteSize(t):t.length;e==1?this.writeU8(r):e==2?this.writeU16(r):e==4?this.writeU32(r):this.writeVLE(r);var i=0,s=t.length;if(n)for(;i<s;++i)this.writeUtf8Char(t.charCodeAt(i));else for(;i<s;++i)this.writeU8(t.charCodeAt(i))},writeStringVLE:function(e,t){this.writeStringWithHeader(0,e,t)},writeStringU8:function(e,t){this.writeStringWithHeader(1,e,t)},writeStringU16:function(e,t){this.writeStringWithHeader(2,e,t)},writeStringU32:function(e,t){this.writeStringWithHeader(4,e,t)},writeS8:function(e){this.bitPos===0?(this.data.setInt8(this.bytePos,e),this.bytePos+=1):this.writeBits(e,8)},writeU8:function(e){this.bitPos===0?(this.data.setUint8(this.bytePos,e),this.bytePos+=1):this.writeBits(e,8)},writeS16:function(e){this.bitPos===0?(this.data.setInt16(this.bytePos,e,!0),this.bytePos+=2):this.writeBits(e,16)},writeU16:function(e){this.bitPos===0?(this.data.setUint16(this.bytePos,e,!0),this.bytePos+=2):this.writeBits(e,16)},writeS32:function(e){this.bitPos===0?(this.data.setIn32(this.bytePos,e,!0),this.bytePos+=4):this.writeBits(e,32)},writeU32:function(e){this.bitPos===0?(this.data.setUint32(this.bytePos,e,!0),this.bytePos+=4):this.writeBits(e,32)},writeFloat32:function(e){this.bitPos===0?(this.data.setFloat32(this.bytePos,e,!0),this.bytePos+=4):(DataSerializer.floatWriteDataView.setFloat32(0,e,!0),this.writeBits(DataSerializer.floatWriteDataView.getUint32(0,!0),32))},writeFloat64:function(e){this.bitPos===0?(this.data.setFloat64(this.bytePos,e,!0),this.bytePos+=8):(DataSerializer.doubleWriteDataView.setFloat64(0,e,!0),this.writeBits(DataSerializer.doubleWriteDataView.getUint32(0,!0),32),this.writeBits(DataSerializer.doubleWriteDataView.getUint32(4,!0),32))},writeVLE:function(e){e<128?this.writeU8(e):e<16384?(this.writeU8(e&127|128),this.writeU8(e>>7)):(this.writeU8(e&127|128),this.writeU8(e>>7&127|128),this.writeU16(e>>14))},writeBits:function(e,t){var n=0,r=this.data.getUint8(this.bytePos);while(t>0)e&1<<n?r|=1<<this.bitPos:r&=255-(1<<this.bitPos),n++,t--,this.bitPos++,this.bitPos>7&&(this.bitPos=0,this.data.setUint8(this.bytePos,r),this.bytePos++,t>0&&(r=this.data.getUint8(this.bytePos)));this.bitPos!==0&&this.data.setUint8(this.bytePos,r)},writeUnsignedFixedPoint:function(e,t,n){var r=1<<e,i=(1<<e+t)-1,s=n<=0?0:n>=r?i:n*(1<<t);return this.writeBits(s,e+t),s},writeSignedFixedPoint:function(e,t,n){return this.writeUnsignedFixedPoint(e,t,n+(1<<e-1))},writeQuantizedFloat:function(e,t,n,r){var i=Math.floor((Math.min(Math.max(r,e),t)-e)*((1<<n)-1)/(t-e));return this.writeBits(i,n),i},writeNormalizedVector2D:function(e,t,n){this.writeQuantizedFloat(-Math.PI,Math.PI,n,atan2(t,e))},writeVector2D:function(e,t,n,r,i){var s=Math.sqrt(e*e+t*t),o=this.writeUnsignedFixedPoint(n,r,s);if(o!==0){var u=Math.atan2(t,e);return this.writeQuantizedFloat(-Math.PI,Math.PI,i,u),n+r+i}return n+r},writeNormalizedVector3D:function(e,t,n,r,i){var s=Math.atan2(e,n),o=Math.asin(-t);this.writeQuantizedFloat(-Math.PI,Math.PI,r,s),this.writeQuantizedFloat(-Math.PI/2,Math.PI/2,i,o)},writeVector3D:function(e,t,n,r,i,s,o){var u=Math.sqrt(e*e+t*t+n*n),a=this.writeUnsignedFixedPoint(s,o,u);if(a!==0){var f=Math.atan2(e,n),l=Math.asin(-t/u);return this.writeQuantizedFloat(-Math.PI,Math.PI,r,f),this.writeQuantizedFloat(-Math.PI/2,Math.PI/2,i,l),s+o+r+i}return s+o},writeArithmeticEncoded2:function(e,t,n,r,i){this.writeBits(t*i+r,e)},writeArithmeticEncoded3:function(e,t,n,r,i,s,o){this.writeBits((t*i+r)*o+s,e)},writeArithmeticEncoded4:function(e,t,n,r,i,s,o,u,a){this.writeBits(((t*i+r)*o+s)*a+u,e)},writeArithmeticEncoded5:function(e,t,n,r,i,s,o,u,a,f,l){this.writeBits((((t*i+r)*o+s)*a+u)*l+f,e)}}),INetworkMessage=Class.$extend({__init__:function(e,t){this.id=e,this.name=t!==undefined?t:INetworkMessage.Ids[e]},__classvars__:{id:0,name:"",Ids:{100:"LoginMessage",101:"LoginReplyMessage",102:"ClientJoinedMessage",103:"ClientLeftMessage",110:"CreateEntityMessage",111:"CreateComponentsMessage",112:"CreateAttributesMessage",113:"EditAttributesMessage",114:"RemoveAttributesMessage",115:"RemoveComponentsMessage",116:"RemoveEntityMessage",117:"CreateEntityReplyMessage",118:"CreateComponentsReplyMessage",119:"RigidBodyUpdateMessage",120:"EntityActionMessage",121:"AssetDiscoveryMessage",122:"AssetDeletedMessage"}},getBuffer:function(){return this.ds!==undefined&&this.ds!==null&&this.ds instanceof DataSerializer?this.ds.getBuffer():null},deserialize:function(e){this.ds=e},serialize:function(e){this.ds=new DataSerializer(e)}}),ObserverPositionMessage=INetworkMessage.$extend({__init__:function(){this.$super(ObserverPositionMessage.id,"ObserverPositionMessage")},__classvars__:{id:105,name:"ObserverPositionMessage"},serialize:function(e,t){this.$super(29),this.ds.writeU16(this.id),this.ds.writeVLE(0);var n=2,r=3;this.ds.writeArithmeticEncoded2(8,n,3,r,4),this.ds.writeFloat32(e.x),this.ds.writeFloat32(e.y),this.ds.writeFloat32(e.z);var i=Math.acos(t.w)*2,s=Math.sin(i/2),o={};Math.abs(s)>1e-5?(s=1/s,o.x=t.x*s,o.y=t.y*s,o.z=t.z*s):(i=0,o.x=1,o.y=0,o.z=0),i>=Math.PI&&(o.x=-o.x,o.y=-o.y,o.z=-o.z,i=2*Math.PI-i),this.ds.writeQuantizedFloat(0,Math.PI,10,i),this.ds.writeNormalizedVector3D(o.x,o.y,o.z,11,10)}}),Network=Class.$extend({__init__:function(e){this.log=TundraLogging.getLogger("Network"),this.messageHandlers=[],this.priorityUpdatePeriod=1,this.lastObserverSendTime=0,this.lastObserverPosition=new THREE.Vector3,this.lastObserverOrientation=new THREE.Quaternion},__classvars__:{components:{1:"EC_Avatar",21:"EC_RttTarget",2:"EC_Billboard",23:"EC_RigidBody",5:"EC_Script",24:"EC_VolumeTrigger",6:"EC_Sound",25:"EC_DynamicComponent",7:"EC_SoundListener",26:"EC_Name",8:"EC_EnvironmentLight",27:"EC_ParticleSystem",9:"EC_Fog",28:"EC_Highlight",10:"EC_Sky",29:"EC_HoveringText",11:"EC_Terrain",30:"EC_TransformGizmo",12:"EC_WaterPlane",31:"EC_Material",13:"EC_InputMapper",33:"EC_ProximityTrigger",14:"EC_AnimationController",34:"EC_PlanarMirror",15:"EC_Camera",35:"EC_WidgetCanvas",16:"EC_Light",36:"EC_WebView",17:"EC_Mesh",37:"EC_MediaPlayer",18:"EC_OgreCompositor",38:"EC_SkyX",19:"EC_OgreCustomObject",39:"EC_Hydrax",20:"EC_Placeable",40:"EC_LaserPointer",41:"EC_SlideShow",52:"EC_GraphicsViewCanvas",42:"EC_WidgetBillboard",108:"EC_StencilGlow",43:"EC_PhysicsMotor"},protocolVersion:{Original:1,CustomComponents:2,HierarchicScene:3,WebClientRigidBodyMessage:4}},registerMessageHandler:function(e){if(!(e instanceof INetworkMessageHandler)){this.log.error("registerMessageHandler called with a non INetworkMessageHandler object:",hadler);return}this.messageHandlers.push(e)},send:function(e){if(TundraSDK.framework.client.websocket===null){this.log.error("Cannot send message, no active WebSocket connection!");return}if(!(e instanceof INetworkMessage)){this.log.error("Cannot send message, given object is not an instance of INetworkMessage!");return}var t=e.getBuffer();t!==null?TundraSDK.framework.client.websocket.send(t):this.log.error("Cannot send message as it's buffer is null! Are you sure it's an outgoing message and serialize() has been called?"),delete e,e=null},receive:function(e){var t=new DataDeserializer(e,0),n=t.readU16();for(var r=0;r<this.messageHandlers.length;r++)if(this.messageHandlers[r].canHandle(n)){this.messageHandlers[r].handle(n,t);return}var i=new INetworkMessage(n);this.log.warn("Received an unhandled network message",i.name,i.id)},updateObserver:function(e){if(TundraSDK.framework.client.websocket!=null)if(this.lastObserverSendTime==0||e-this.lastObserverSendTime>=this.priorityUpdatePeriod*1e3){var t=TundraSDK.framework.scene.entityById(TundraSDK.framework.client.observerEntityId);if(t!=null&&t.placeable!=null){var n=t.placeable.worldPosition(),r=t.placeable.worldOrientation();if(this.lastObserverSendTime==0||!this.lastObserverPosition.equals(n)||!this.lastObserverOrientation.equals(r)){this.lastObserverPosition.copy(n),this.lastObserverOrientation.copy(r);var i=new ObserverPositionMessage;i.serialize(n,r),this.send(i),this.lastObserverSendTime=e}}}}}),EventSubscription=Class.$extend({__init__:function(e,t){this.channel=e,this.id=t}}),EventAPI=Class.$extend({__init__:function(e){this.signals={}},send:function(e,t,n,r,i,s,o,u,a,f,l){var c=typeof e=="string"?e:e.channel,h=this.signals[c];if(h===undefined)return;if(!this._hasActiveListeners(h))return;t===undefined?h.dispatch():n===undefined?h.dispatch(t):r===undefined?h.dispatch(t,n):i===undefined?h.dispatch(t,n,r):s===undefined?h.dispatch(t,n,r,i):o===undefined?h.dispatch(t,n,r,i,s):u===undefined?h.dispatch(t,n,r,i,s,o):a===undefined?h.dispatch(t,n,r,i,s,o,u):f===undefined?h.dispatch(t,n,r,i,s,o,u,a):l===undefined?h.dispatch(t,n,r,i,s,o,u,a,f):h.dispatch(t,n,r,i,s,o,u,a,f,l)},subscribe:function(e,t,n){var r=this.signals[e];r===undefined&&(r=new signals.Signal,r._eventapi_priority=-1,r._eventapi_id=-1,r._eventapi_subscribers={},this.signals[e]=r),r._eventapi_priority++,r._eventapi_id++;var i=r.add(n,t,r._eventapi_priority);return r._eventapi_subscribers[r._eventapi_id]=r._bindings.length-1,new EventSubscription(e,r._eventapi_id)},unsubscribe:function(e,t){var n=undefined,r=undefined;e instanceof EventSubscription?(n=e.channel,r=e.id,e.id=undefined):(n=e,r=t);if(n===undefined||n===null)return!1;if(r===undefined||r===null)return!1;var i=this.signals[n];if(i===undefined)return!1;var s=i._eventapi_subscribers[r];return s!==undefined&&i._bindings[s]!==undefined&&(i._bindings[s]._destroy(),i._bindings[s].active=!1,i._eventapi_subscribers[r]=undefined,this._hasActiveListeners(i)||(i.dispose(),i=undefined,delete this.signals[n])),!0},remove:function(e){var t=this.signals[e];t!==undefined&&(t.dispose(),t=undefined,delete this.signals[e])},_numActiveListeners:function(e){var t=0;for(var n=e.getNumListeners()-1;n>=0;n--)e._bindings[n].active&&t++;return t},_hasActiveListeners:function(e){for(var t=e.getNumListeners()-1;t>=0;t--)if(e._bindings[t].active)return!0;return!1}}),ConsoleAPI=Class.$extend({__init__:function(e){this.commands=[],TundraSDK.framework.client.onLogInfo(this,this.logInfo),TundraSDK.framework.client.onLogWarning(this,this.logWarning),TundraSDK.framework.client.onLogError(this,this.logError),this.registerCommand("help","Prints all available console commands",null,this,this.help)},help:function(){if(this.commands.length<=0)return;var e=0;for(var t=0;t<this.commands.length;++t)this.commands[t].name.length>e&&(e=this.commands[t].name.length);var n="";for(var t=0;t<this.commands.length;++t){var r=this.commands[t];if(r.name===undefined||r.name===null)continue;var i=r.name;while(i.length<e)i+=" ";n+="  "+i+(r.description!==""?" - "+r.description:"")+"<br/>";if(r.parameterDescription!==""){var s="";while(s.length<e)s+=" ";n+=s+"     <span style='color:black;'>"+r.parameterDescription+"</span><br/>"}}var o=TundraSDK.framework.client;if(o.ui.console==null)return;var u=o.ui.console.html();o.ui.console.html(u+"<span style='color:brown;'>"+n+"</span>"),o.ui.console.is(":visible")&&o.ui.console.animate({scrollTop:o.ui.console.prop("scrollHeight")},{queue:!1,duration:350})},commandSuggestion:function(e){var t=e.toLowerCase();for(var n=0;n<this.commands.length;++n)if(this.commands[n].name.toLowerCase()===t)return null;for(var n=0;n<this.commands.length;++n)if(this.commands[n].name.toLowerCase().indexOf(t)===0)return this.commands[n].name;return null},getCommandData:function(e){var t=e.toLowerCase();for(var n=0;n<this.commands.length;++n)if(this.commands[n].name.toLowerCase()===t)return this.commands[n];return null},registerCommand:function(e,t,n,r,i){if(typeof e!="string")return TundraSDK.framework.client.logError("[ConsoleAPI]: registerCommand 'name' parameter must be a non empty string!",!0),null;var s=this.getCommandData(e);if(s!=null)return this.subscribeCommand(e,r,i);if(t===undefined||t===null)t="";if(n===undefined||n===null)n="";var o=this.commands.length;return this.commands.push({channel:"ConsoleAPI."+o,index:o,name:e,description:t,parameterDescription:n}),this.subscribeCommand(e,r,i)},subscribeCommand:function(e,t,n){if(n===undefined||n===null)return null;var r=this.getCommandData(e);return r!=null?TundraSDK.framework.events.subscribe(r.channel,t,n):null},executeCommandRaw:function(e){e=CoreStringUtils.trim(e);var t=e,n="";e.indexOf("(")!=-1&&(t=CoreStringUtils.trim(e.substring(0,e.indexOf("("))),n=CoreStringUtils.trim(e.substring(e.indexOf("(")+1))),n===""&&e.indexOf(" ")!=-1&&(t=CoreStringUtils.trim(e.substring(0,e.indexOf(" "))),n=CoreStringUtils.trim(e.substring(e.indexOf(" ")+1))),n.indexOf(")")!=-1&&(n=n.substring(0,n.indexOf(")"))),t=CoreStringUtils.trim(t),n=n!==""?CoreStringUtils.trim(n).split(","):[];var r=this.executeCommand(t,n);return r||TundraSDK.framework.client.logError("Could not find console command '"+t+"'"),r},executeCommand:function(e,t){var n=this.getCommandData(e);return n!=null&&TundraSDK.framework.events.send(n.channel,t),n!=null},logInfo:function(e){var t=TundraSDK.framework.client;if(t.ui!=null&&t.ui.console!=null){var n=t.ui.console.html();t.ui.console.html(n+e+"<br />"),t.ui.console.is(":visible")&&t.ui.console.animate({scrollTop:t.ui.console.prop("scrollHeight")},{queue:!1,duration:350})}},logWarning:function(e){var t=TundraSDK.framework.client;if(t.ui!=null&&t.ui.console!=null){var n=t.ui.console.html();t.ui.console.html(n+"<span style='color: rgb(119,101,0);'>"+e+"</span><br />"),t.ui.console.is(":visible")&&t.ui.console.animate({scrollTop:t.ui.console.prop("scrollHeight")},{queue:!1,duration:350})}},logError:function(e){var t=TundraSDK.framework.client;if(t.ui!=null&&t.ui.console!=null){var n=t.ui.console.html();t.ui.console.html(n+"<span style='color: red;'>"+e+"</span><br />"),t.ui.console.is(":visible")&&t.ui.console.animate({scrollTop:t.ui.console.prop("scrollHeight")},{queue:!1,duration:350})}}}),AttributeChange=Class.$extend({__init__:function(){},__classvars__:{Default:0,Disconnected:1,LocalOnly:2,Replicate:3}}),Color=Class.$extend({__init__:function(e,t,n,r){this.r=e||0,this.g=t||0,this.b=n||0,this.a=r||0},__classvars__:{fromString:function(e){if(/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.test(e)){var t=/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.exec(e),n=parseInt(t[1]),r=parseInt(t[2]),i=parseInt(t[3]);return n>1&&(n=Math.min(255,n)/255),r>1&&(r=Math.min(255,r)/255),i>1&&(i=Math.min(255,i)/255),new Color(n,r,i)}if(/^\#([0-9a-f]{6})$/i.test(e)){var t=/^\#([0-9a-f]{6})$/i.exec(e);return Color.fromHex(parseInt(t[1],16))}return console.error("[Color]: fromString() string format not supported:",e),null},fromHex:function(e){e=Math.floor(e);var t=(e>>16&255)/255,n=(e>>8&255)/255,r=(e&255)/255;return new Color(t,n,r)}},clone:function(){return new Color(this.r,this.g,this.b,this.a)},setRGBA:function(e,t,n,r){this.r=e||this.r,this.g=t||this.g,this.b=n||this.b,this.a=r||this.a},toThreeColor:function(){var e=new THREE.Color;return e.setRGB(this.r,this.g,this.b),e},toHex:function(){},toString:function(){return"rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")"}}),Transform=Class.$extend({__init__:function(e,t,n){this.log=TundraLogging.getLogger("Transform"),e!==undefined&&!(e instanceof THREE.Vector3)&&this.log.warn("Constructor 'pos' parameter is not a THREE.Vector3",e),t!==undefined&&!(e instanceof THREE.Vector3)&&this.log.warn("Constructor 'rot' parameter is not a THREE.Vector3",t),n!==undefined&&!(e instanceof THREE.Vector3)&&this.log.warn("Constructor 'scale' parameter is not a THREE.Vector3",n),this._pos=e instanceof THREE.Vector3?e:new THREE.Vector3(0,0,0),this._rot=t instanceof THREE.Vector3?t:new THREE.Vector3(0,0,0),this._scale=n instanceof THREE.Vector3?n:new THREE.Vector3(1,1,1),this._rotEuler=new THREE.Euler(THREE.Math.degToRad(this._rot.x),THREE.Math.degToRad(this._rot.y),THREE.Math.degToRad(this._rot.z),"ZYX"),Object.defineProperties(this,{pos:{get:function(){return this._pos},set:function(e){this.setPosition(e)}},rot:{get:function(){return this._rot},set:function(e){this.setRotation(e)}},scale:{get:function(){return this._scale},set:function(e){this.setScale(e)}}})},lookAt:function(e,t){this._orientationMatrix===undefined&&(this._orientationMatrix=new THREE.Matrix4),this._orientationMatrix.makeTranslation(0,0,0),this._orientationMatrix.lookAt(e,t,TundraSDK.framework.renderer.axisY),this.setRotation((new THREE.Quaternion).setFromRotationMatrix(this._orientationMatrix))},orientation:function(){this._updateEuler();var e=new THREE.Quaternion;return e.setFromEuler(this._rotEuler,!1),e},_updateEuler:function(){this._rotEuler.set(THREE.Math.degToRad(this._rot.x%360),THREE.Math.degToRad(this._rot.y%360),THREE.Math.degToRad(this._rot.z%360))},euler:function(){return this._updateEuler(),this._rotEuler.clone()},setPosition:function(e,t,n){e instanceof THREE.Vector3?this._pos.copy(e):typeof e=="number"&&typeof t=="number"&&typeof n=="number"?(this._pos.x=e,this._pos.y=t,this._pos.z=n):this.log.error("setPosition must be called with a single Three.Vector3 or x,y,z with type of number.",e,t,n)},setRotation:function(e,t,n){e instanceof THREE.Vector3?this._rot.copy(e):e instanceof THREE.Quaternion?(this._rotEuler.setFromQuaternion(e.normalize(),undefined,!1),this._rot.x=THREE.Math.radToDeg(this._rotEuler.x)%360,this._rot.y=THREE.Math.radToDeg(this._rotEuler.y)%360,this._rot.z=THREE.Math.radToDeg(this._rotEuler.z)%360):e instanceof THREE.Euler?(this._rot.x=THREE.Math.radToDeg(e.x)%360,this._rot.y=THREE.Math.radToDeg(e.y)%360,this._rot.z=THREE.Math.radToDeg(e.z)%360):typeof e=="number"&&typeof t=="number"&&typeof n=="number"?(this._rot.x=e,this._rot.y=t,this._rot.z=n):this.log.error("setRotation must be called with a single Three.Vector3, THREE.Quaternion or x,y,z with type of number.",e,t,n)},setScale:function(e,t,n){return e instanceof THREE.Vector3?this._scale.copy(e):typeof e=="number"&&typeof t=="number"&&typeof n=="number"?(this._scale.x=e,this._scale.y=t,this._scale.z=n):this.log.error("setScale must be called with a single Three.Vector3 or x,y,z with type of number.",e,t,n),!1},clone:function(){return new Transform(this.pos.clone(),this.rot.clone(),this.scale.clone())},toString:function(e){e===undefined&&(e=!1);var t=this.pos.x+" "+this.pos.y+" "+this.pos.z+" | "+this.rot.x+" "+this.rot.y+" "+this.rot.z+" | "+this.scale.x+" "+this.scale.y+" "+this.scale.z;return e||(t="Transform("+t+")"),t}}),Attribute=Class.$extend({__init__:function(e,t,n,r,i){this.owner=e,this.index=t,this.name=n,this.id=undefined,this.value=r,this.typeId=i,this.typeName=Attribute.toTypeName(i),this.sizeBytes=Attribute.sizeInBytes(i),this.headerSizeBytes=Attribute.headerSizeInBytes(i)},__classvars__:{None:0,String:1,Int:2,Real:3,Color:4,Float2:5,Float3:6,Float4:7,Bool:8,UInt:9,Quat:10,AssetReference:11,AssetReferenceList:12,EntityReference:13,QVariant:14,QVariantList:15,Transform:16,QPoint:17,typeNames:function(){var e=[];for(var t=0;t<Attribute.typeNameList.length;++t)e.push(Attribute.typeNameList[t]);return e},typeIds:function(){var e=[];for(var t=0;t<Attribute.typIdList.length;++t)e.push(Attribute.typIdList[t]);return e},toTypeName:function(e){if(typeof e!="number")return TundraLogging.getLogger("Attribute").error("toTypeName function called with non number 'typeId'",e),null;switch(e){case 1:return"String";case 2:return"Int";case 3:return"Real";case 4:return"Color";case 5:return"Float2";case 6:return"Float3";case 7:return"Float4";case 8:return"Bool";case 9:return"Uint";case 10:return"Quat";case 11:return"AssetReference";case 13:return"EntityReference";case 12:return"AssetReferenceList";case 15:return"QVariantList";case 14:return"QVariant";case 16:return"Transform";case 17:return"QPoint"}return null},toTypeId:function(e){if(typeof e!="string")return TundraLogging.getLogger("Attribute").error("toTypeId function called with non string 'typeName'",e),null;var t=e.toLowerCase();return t==="string"?1:t==="int"?2:t==="eeal"?3:t==="color"?4:t==="float2"?5:t==="float3"?6:t==="float4"?7:t==="bool"?8:t==="uint"?9:t==="quat"?10:t==="assetreference"?11:t==="entityreference"?12:t==="assetreferencelist"?13:t==="qvariantlist"?14:t==="qvariant"?15:t==="transform"?16:t==="qpoint"?17:null},typeNameList:["String","Int","Real","Color","Float2","Float3","Float4","Bool","Uint","Quat","EntityReference","AssetReferenceList","QVariantList","QVariant","Transform","QPoint"],typIdList:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],sizeInBytes:function(e){switch(e){case 1:return undefined;case 2:return 4;case 3:return 4;case 4:return 16;case 5:return 8;case 6:return 12;case 7:return 16;case 8:return 1;case 9:return 4;case 10:return 16;case 11:case 13:case 12:case 15:case 14:return undefined;case 16:return 36;case 17:return 8}return TundraLogging.getLogger("Attribute").error("Unknown attribute type id "+e+". Cannot resolve size in bytes!"),undefined},headerSizeInBytes:function(e){switch(e){case 1:return 2;case 11:case 13:return 1;case 12:case 15:return 1;case 14:return 1}return 0},defaultValueForType:function(e){switch(e){case 1:return"";case 2:case 9:return 0;case 3:return 0;case 4:return new Color;case 5:case 17:return new THREE.Vector2(0,0);case 6:return new THREE.Vector3(0,0,0);case 7:return new THREE.Vector4(0,0,0,0);case 8:return!1;case 10:return new THREE.Quaternion;case 11:case 13:case 14:return"";case 12:case 15:return[];case 16:return new Transform}return TundraLogging.getLogger("Attribute").error("defaultValueForType() Unknown attribute type id "+e),null}},_reset:function(){this.owner=null,this.index=null,this.name=null,this.id=null,this.value=null,this.typeId=null,this.typeName=null,this.sizeBytes=null,this.headerSizeBytes=null},toString:function(){return"index="+this.index+" name="+this.name+" typeId="+this.typeId+" typeName="+this.typeName+" size="+this.sizeBytes+" header="+this.headerSizeBytes+" value="+this.value.toString()},get:function(){return this.value},getClone:function(){if(typeof this.value.getClone=="function")return this.value.getClone();if(typeof this.value.clone=="function")return this.value.clone();var e=typeof this.value;if(e==="string"||e==="boolean"||e==="number")return this.value;if(Array.isArray(this.value)){var t=new Array;for(var n=0;n<this.value.length;n++)t.push(this.value[n]);return t}return TundraLogging.getLogger("Attribute").warn("getClone() not implemented for type",this.typeName,e),TundraLogging.getLogger("Attribute").warn(this),this.value},set:function(e,t){if(t===undefined||t===null)t=AttributeChange.Default;return typeof t!="number"?(TundraLogging.getLogger("Attribute").error("set called with non-number change type: "+t),!1):(t===AttributeChange.Default&&(t=this.owner!=null&&this.owner.replicated?AttributeChange.Replicate:AttributeChange.LocalOnly),this.value=e,this.owner!=null&&t!==AttributeChange.Disconnected&&this.owner._attributeChanged(this,t),!0)},onChanged:function(e,t){return this.owner==null||!this.owner.hasParentEntity()?(TundraLogging.getLogger("Attribute").error("Cannot subscribe onChanged, parent component or parent entity not set!"),null):TundraSDK.framework.events.subscribe("Scene.AttributeChanged."+this.owner.parentEntity.id.toString()+"."+this.owner.id.toString()+"."+this.index.toString(),e,t)},headerFromBinary:function(e){if(this.headerSizeBytes>0){if(this.headerSizeBytes===1)return e.readU8();if(this.headerSizeBytes===2)return e.readU16()}return undefined},dataFromBinary:function(e,t){switch(this.typeId){case 1:this.set(e.readString(t,!0),AttributeChange.LocalOnly);break;case 11:case 13:case 14:this.set(e.readString(t),AttributeChange.LocalOnly);break;case 2:this.set(e.readS32(),AttributeChange.LocalOnly);break;case 3:this.set(e.readFloat32(),AttributeChange.LocalOnly);break;case 4:this.value.r=e.readFloat32(),this.value.g=e.readFloat32(),this.value.b=e.readFloat32(),this.value.a=e.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 5:this.value.x=e.readFloat32(),this.value.y=e.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 6:this.value.x=e.readFloat32(),this.value.y=e.readFloat32(),this.value.z=e.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 7:this.value.x=e.readFloat32(),this.value.y=e.readFloat32(),this.value.z=e.readFloat32(),this.value.w=e.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 8:this.set(e.readBoolean(),AttributeChange.LocalOnly);break;case 9:this.set(e.readU32(),AttributeChange.LocalOnly);break;case 10:this.value.x=e.readFloat32(),this.value.y=e.readFloat32(),this.value.z=e.readFloat32(),this.value.w=e.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 12:case 15:this.value=[];for(var n=0;n<t;++n)this.value.push(e.readStringU8());this.set(this.value,AttributeChange.LocalOnly);break;case 16:this.value.pos.x=e.readFloat32(),this.value.pos.y=e.readFloat32(),this.value.pos.z=e.readFloat32(),this.value.rot.x=e.readFloat32(),this.value.rot.y=e.readFloat32(),this.value.rot.z=e.readFloat32(),this.value.scale.x=e.readFloat32(),this.value.scale.y=e.readFloat32(),this.value.scale.z=e.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 17:this.value.x=e.readS32(),this.value.y=e.readS32(),this.set(this.value,AttributeChange.LocalOnly)}},fromBinary:function(e){var t=this.sizeBytes!==undefined?this.sizeBytes:this.headerFromBinary(e);if(t===undefined){TundraLogging.getLogger("Attribute").error("Size and header size of '"+this.name+"' seems to be unknown, did you mess up the IComponent.declareAttribute() calls?");return}this.dataFromBinary(e,t)}}),IComponent=Class.$extend({__init__:function(e,t,n,r){this.log=TundraLogging.getLogger(IComponent.propertyName(n,!1)),this.id=e,this.typeId=t,this.typeName=n,this.name=r,this.replicated=!0,this.local=!1,this.temporary=!1,this.parentEntity=null,this.parentScene=null,this.notImplemented=!1,this.attributes={},this.attributeCount=0,this.attributeIndexes={},this.blockSignals=!1},__classvars__:{ensureComponentNamePrefix:function(e){return e.substring(0,3).toLowerCase()==="ec_"?e:"EC_"+e},propertyName:function(e,t){t===undefined&&(t=!0);var n=e;return n.substring(0,3).toLowerCase()==="ec_"&&(n=n.substring(3)),t&&(n=n.substring(0,1).toLowerCase()+n.substring(1)),n},propertyNameLowerCase:function(e){return this.propertyName().toLowerCase()}},_reset:function(){this.reset(),this.attributeIndexes={},this.attributeCount=0,this.blockSignals=!1;for(var e in this.attributes){var t=this.attributes[e];t!==undefined&&t!==null&&t._reset(),t=null}this.attrs={},this.parentEntity=null,this.parentScene=null},hasParentEntity:function(){return this.parentEntity!==null},hasParentScene:function(){return this.parentScene!==null},reset:function(){},_update:function(){this.update()},update:function(){},onAttributeChanged:function(e,t){return this.parentEntity==null||this.parentEntity.id<0?(console.log("ERROR: Entity.onAttributeChanged called on a non initialized component! No valid parent entity!"),null):TundraSDK.framework.events.subscribe("Scene.AttributeChanged."+this.parentEntity.id.toString()+"."+this.id.toString(),e,t)},toString:function(){return this.id+" "+this.typeName+(this.name.length>0?" name = "+this.name:"")},isDynamic:function(){return!1},setParent:function(e){this.parentEntity=e!==undefined?e:null,this.parentScene=e!==undefined?e.parentScene:null},declareAttribute:function(e,t,n,r){var i=new Attribute(this,e,t,n,r);this.attributes[t]=i,this.attributeIndexes[e]=t,this.attributeCount=Object.keys(this.attributes).length;if(this[t]===undefined){var s={};s[t]={get:function(){return i.getClone()},set:function(e){i.set(e)},configurable:this.isDynamic()},Object.defineProperties(this,s)}},setAttribute:function(e,t,n){var r=this.attributes[e];r!==undefined&&r.set(t,n)},attributeById:function(e){return e===undefined||e===null?undefined:this.attributes[e]},attribute:function(e){return this.attributeById(e)},getAttribute:function(e){return this.attributeById(e)},hasAttribute:function(e){return this.attribute(e)!==undefined},attributeByIndex:function(e){return this.attributeById(this.attributeIndexes[e])},getAttributeByIndex:function(e){return this.attributeByIndex(e)},deserializeFromBinary:function(e){if(this.attributeCount<=0&&!this.isDynamic())return-1;this.blockSignals=!0;try{this.isDynamic()?this._deserializeFromBinaryDynamic(e):this._deserializeFromBinaryStatic(e)}catch(t){TundraSDK.framework.client.logError("[Attribute]: deserializeFromBinary exception: "+t)}this.blockSignals=!1},_deserializeFromBinaryStatic:function(e){for(var t=0;t<this.attributeCount;++t){var n=this.attributeByIndex(t);n.fromBinary(e)}},_deserializeFromBinaryDynamic:function(e){if(e.readLimitBytes!==undefined){var t=e.readBytes();while(e.readBytes()-t<e.readLimitBytes){var n=e.readU8(),r=e.readU8(),i=e.readStringU8();this.declareAttribute(n,i,Attribute.defaultValueForType(r),r),this.deserializeAttributeFromBinary(n,e)}}else console.error("[Attribute]: DataDeserializer for parsing dynamic component structure does not have 'readLimitBytes' property. This information is needed to know when to stop parsing.")},deserializeAttributeFromBinary:function(e,t){if(this.attributeCount<=0)return;var n=this.attributeByIndex(e);n!==undefined&&n!==null&&n.fromBinary(t)},createAttributeFromBinary:function(e,t){if(!this.isDynamic()){TundraSDK.framework.client.logError("[IComponent]: createAttributeFromBinary called to a non dynamic component!",!0);return}var n=t.readU8(),r=t.readStringU8();this.declareAttribute(e,r,Attribute.defaultValueForType(n),n),this.deserializeAttributeFromBinary(e,t),typeof this._attributeAdded=="function"&&this._attributeAdded(e)},_attributeChanged:function(e,t){if(this.blockSignals)return;if(this.parentEntity==null||this.parentEntity.parentScene==null){TundraSDK.framework.client.logError("[IComponent]: Cannot send attribute update event, parent entity or scene is null!",!0);return}if(e===undefined||e===null)return;this.attributeChanged(e.index,e.name,e.get()),this.parentEntity!==null&&this.parentEntity.parentScene!==null&&this.parentEntity.parentScene._publishAttributeChanged(this.parentEntity,e)},attributeChanged:function(e,t,n){}}),EntityAction=Class.$extend({__init__:function(){this.name=undefined,this.executionTypeName=undefined,this.executionType=EntityAction.Invalid,this.parameters=[],this.entity=undefined,this.entityId=undefined},__classvars__:{Invalid:0,Local:1,Server:2,Peers:4}}),EntityActionMessage=INetworkMessage.$extend({__init__:function(){this.$super(EntityActionMessage.id,"EntityActionMessage"),this.entityAction=new EntityAction},__classvars__:{id:120,name:"EntityActionMessage",staticNumBytes:9},deserialize:function(e){this.entityAction.entityId=e.readU32(),this.entityAction.name=e.readStringU8(),this.entityAction.executionType=e.readU8();var t=e.readU8();for(var n=0;n<t;++n)this.entityAction.parameters[n]=e.readString(e.readVLE());delete e},serialize:function(e){if(e.entityId===undefined&&e.entity===undefined){TundraSDK.framework.client.logError("[EntityActionMessage]: serialize() called with entity action that does not have entityId or entity set!");return}var t=DataSerializer.utf8StringByteSize(e.name);t+=e.parameters.length*4;for(var n=0,r=e.parameters.length;n<r;++n)t+=DataSerializer.utf8StringByteSize(e.parameters[n]);this.$super(EntityActionMessage.staticNumBytes+t),this.ds.writeU16(this.id),this.ds.writeU32(e.entityId!==undefined?e.entityId:e.entity.id),this.ds.writeStringU8(e.name),this.ds.writeU8(e.executionType),this.ds.writeU8(e.parameters.length);for(var n=0,r=e.parameters.length;n<r;++n)this.ds.writeStringVLE(e.parameters[n])}}),Entity=Class.$extend({__init__:function(){this.log=TundraLogging.getLogger("Entity"),this.id=-1,Object.defineProperties(this,{name:{get:function(){return this.getName()},set:function(e){this.setName(e)}},description:{get:function(){return this.getDescription()},set:function(e){this.setDescription(e)}},group:{get:function(){return this.getGroup()},set:function(e){this.setGroup(e)}}}),this.replicated=!0,this.local=!1,this.temporary=!1,this.parentScene=null,this.components=[]},__classvars__:{ExecType:{Invalid:0,Local:1,Server:2,Peers:4,0:"Invalid",1:"Local",2:"Server",4:"Peers"}},_nextLocalComponentId:function(){for(var e=1e5;e<2e5;++e)if(this.getComponentById(e)==null)return e;return-1},_nextReplicatedComponentId:function(){for(var e=1;e<1e5;++e)if(this.getComponentById(e)==null)return e;return-1},setId:function(e){this.id=e},getName:function(){var e=this.getComponent("EC_Name");return e!=null?e.getName():""},setName:function(e,t){var n=this.getOrCreateComponent("EC_Name",undefined,t);n.setName(e,t)},getDescription:function(){var e=this.getComponent("EC_Name");return e!=null?e.getDescription():""},setDescription:function(e,t){var n=this.getOrCreateComponent("EC_Name",undefined,t);n.setDescription(e,t)},getGroup:function(){var e=this.getComponent("EC_Name");return e!=null?e.getGroup():""},setGroup:function(e,t){var n=this.getOrCreateComponent("EC_Name",undefined,t);n.setGroup(e,t)},onAboutToBeRemoved:function(e,t){return this.parentScene==null||this.id<0?(this.log.error("onAboutToBeRemoved called on a non initialized entity!"),null):TundraSDK.framework.events.subscribe("Entity.AboutToBeRemoved."+this.id.toString(),e,t)},onComponentCreated:function(e,t){return this.parentScene==null||this.id<0?(this.log.error("onComponentCreated called on a non initialized entity!"),null):TundraSDK.framework.events.subscribe("Scene.ComponentCreated."+this.id.toString(),e,t)},onComponentRemoved:function(e,t){return this.parentScene==null||this.id<0?(this.log.error("onComponentRemoved called on a non initialized entity!"),null):TundraSDK.framework.events.subscribe("Scene.ComponentRemoved."+this.id.toString(),e,t)},onEntityAction:function(e,t){return this.parentScene==null||this.id<0?(this.log.error("onEntityAction called on a non initialized entity!"),null):TundraSDK.framework.events.subscribe("Scene.EntityAction."+this.id.toString(),e,t)},reset:function(){TundraSDK.framework.events.send("Entity.AboutToBeRemoved."+this.id.toString(),this);var e=null,t=[];for(var n=0;n<this.components.length;n++)this.components[n]!=null&&this.components[n].typeName!=="EC_Placeable"?t.push(this.components[n].id):this.components[n]!=null&&this.components[n].typeName==="EC_Placeable",e=this.components[n].id;for(var n=0;n<t.length;n++)this.removeComponent(t[n]);e!=null&&this.removeComponent(e),this.components=[],TundraSDK.framework.events.remove("Entity.AboutToBeRemoved."+this.id.toString()),TundraSDK.framework.events.remove("Scene.EntityAction."+this.id.toString())},toString:function(){return this.id+(this.name.length>0?" name = "+this.name:"")},setParent:function(e){this.parentScene=e},update:function(){var e=this.getComponent("EC_Placeable");e!=null&&e.update();for(var t=0;t<this.components.length;++t){if(this.components[t]==null)continue;(e==null||e.id!==this.components[t].id)&&this.components[t]._update()}},exec:function(e,t,n){if(typeof e=="string"){var r=e.toLowerCase();if(r==="local")e=1;else if(r==="server")e=2;else{if(r!=="peers"){this.log.error("exec(): Error cannot convert string exec type "+e+" no a valid Entity.ExecType!");return}e=4}}if(e!=1&&e!=2&&e!=4){this.log.error("exec(): Invalid Entity.ExecType input parameter: "+e);return}var i={};i.entity=this,i.executionType=e,i.name=t,i.parameters=[];if(n!=null)for(var s=0;s<n.length;s++)i.parameters.push(n[s].toString());if(i.executionType===1)this.parentScene!=null&&this.parentScene._publishEntityAction(i);else if(TundraSDK.framework.client.websocket!=null){var o=new EntityActionMessage;o.serialize(i),TundraSDK.framework.network.send(o)}},addComponent:function(e){if(e===undefined||e===null)return!1;for(var t=this.components.length-1;t>=0;t--)if(this.components[t]!=null&&this.components[t].id===e.id)return!1;var n=IComponent.propertyName(e.typeName);return e.typeName!==""&&n!=="name"&&(this[n]=e,n!==n.toLowerCase()&&(this[n.toLowerCase()]=e)),this.components.push(e),e.setParent(this),e._update(),this.parentScene!=null&&this.parentScene._publishComponentCreated(this,e),!0},removeComponent:function(e){for(var t=this.components.length-1;t>=0;t--)if(this.components[t]!=null&&this.components[t].id===e){var n=this.components[t];return n!=null&&(this.parentScene!=null&&this.parentScene._publishComponentRemoved(this,n),n._reset()),this.components.splice(t,1),n=null,!0}return!1},removeComponentByName:function(e,t){var n=IComponent.ensureComponentNamePrefix(e);for(var r=this.components.length-1;r>=0;r--)if(this.components[r].typeName===n){if(t!=null&&this.components[r].name!==t)continue;var i=this.components[r];return i!=null&&(TundraSDK.framework.events.send("Scene.ComponentRemoved."+this.id.toString(),this,i),i._reset()),this.components.splice(r,1),i=null,!0}return!1},component:function(e,t){t===undefined&&(t=null);if(typeof e!="string")return this.log.error("getComponent called with non-string type name for Entity: "+this.toString()),null;var n=IComponent.ensureComponentNamePrefix(e);for(var r=this.components.length-1;r>=0;r--)if(this.components[r]!=null&&this.components[r].typeName===n){if(t==null)return this.components[r];if(this.components[r].name===t)return this.components[r]}return null},getComponent:function(e,t){return this.component(e,t)},componentById:function(e){for(var t=this.components.length-1;t>=0;t--)if(this.components[t]!=null&&this.components[t].id===e)return this.components[t];return null},getComponentById:function(e){return this.componentById(e)},createLocalComponent:function(e,t){return t===undefined&&(t=null),this.createComponent(e,t,AttributeChange.LocalOnly)},createComponent:function(e,t,n){if(this.parentScene==null)return this.log.error("Cannot create component, parent scene is null for Entity: "+this.toString()),null;if(n===undefined||n===null)n=AttributeChange.Default;typeof n!="number"&&(this.log.warn("createComponent called with non AttributeChange.Type change mode, defaulting to AttributeChange.Default."),n=AttributeChange.Default),n!==AttributeChange.LocalOnly&&(n===AttributeChange.Default?n=AttributeChange.LocalOnly:(this.log.warn("createComponent called with localOnly != AttributeChange.LocalOnly. Creating replicated components is not supported at the moment, defaulting to LocalOnly."),n=AttributeChange.LocalOnly));var r=IComponent.ensureComponentNamePrefix(e),i=this.parentScene.createComponent(r,t);return i!=null&&(n==AttributeChange.LocalOnly||n==AttributeChange.Disconnected||n==AttributeChange.Default?i.replicated=!1:i.replicated=!0,i.local=!i.replicated,i.id=i.replicated?this._nextReplicatedComponentId():this._nextLocalComponentId()),this.addComponent(i),i},getOrCreateLocalComponent:function(e,t){return t===undefined&&(t=null),this.getOrCreateComponent(e,t,AttributeChange.LocalOnly)},getOrCreateComponent:function(e,t,n){t===undefined&&(t=null),n===undefined&&(n=null);var r=this.getComponent(e,t);return r==null&&(r=this.createComponent(e,t,n)),r}}),Scene=Class.$extend({__init__:function(e){this.log=TundraLogging.getLogger("Scene"),this.entities=[],this.id=1},__classvars__:{registeredComponents:{},registeredComponentsList:function(){var e=[];for(var t in Scene.registeredComponents)e.push(Scene.registeredComponents[t]);return e},registeredComponent:function(e){if(typeof e=="string"){var t=IComponent.ensureComponentNamePrefix(e);for(var n in Scene.registeredComponents)if(Scene.registeredComponents[n].typeName===t){e=n;break}}return Scene.registeredComponents[e]},registerComponent:function(e,t,n){return t=IComponent.ensureComponentNamePrefix(t),this.registeredComponents[e]!==undefined?(TundraLogging.getLogger("Scene").error("Component with type id",e,"("+this.registeredComponents[e].typeName+") already registered!"),!1):(this.registeredComponents[e]={typeId:e,typeName:t,prototype:n},TundraSDK.framework.scene!=null&&TundraSDK.framework.scene._logComponentRegistration(this.registeredComponents[e]),!0)},componentPropertyNames:function(){var e=[];for(var t in Network.components)e.push(IComponent.propertyName(Network.components[t]));return e}()},toString:function(){return"id="+this.id+" entities="+this.entities.length},postInitialize:function(){this.postInitialized=!0;var e=Scene.registeredComponentsList();for(var t=0;t<e.length;t++)this._logComponentRegistration(e[t]);TundraSDK.framework.console.registerCommand("dumpScene","Dumps the scene to browsers developer console","(string) Optional entity name if you want to print a single entity",this,this.onDumpScene)},_logComponentRegistration:function(e){if(TundraSDK.framework.scene!=null&&TundraSDK.framework.scene.postInitialized===!0){var t=e.prototype.implementationName!==undefined?e.prototype.implementationName+" ":"";TundraSDK.framework.scene.log.debug("Registered "+t+e.typeName)}},onDumpScene:function(e){if(this.entities.length===0){this.log.info("Current scene has no entities");return}this.log.info("");var t=!1,n=e[0];for(var r=0;r<this.entities.length;r++){var i=this.entities[r],s=n!==undefined?n===i.name:!0;if(!s)continue;t=!0,this.log.info(i.id+" "+i.name);for(var o=0;o<i.components.length;o++){var u=i.components[o];this.log.info("  "+u.id+" "+u.typeName);if(!u.isDynamic())for(var a=0;a<u.attributeCount;a++)this.log.info("    "+u.getAttributeByIndex(a).toString());else for(var f in u.attributeIndexes){var l=u.getAttributeByIndex(f);l!==undefined&&l!==null&&this.log.info("    "+l.toString())}}}!t&&n!==undefined&&this.log.error("Failed to find entity '"+n+"'")},_onEntityNameChanged:function(e,t,n){for(var r=this.entities.length-1;r>=0;r--){var i=this.entities[r],s=i.placeable!=null?i.placeable.parentRef:undefined;s!==undefined&&s!==null&&(n!==""&&s!==""&&s===n&&i.placeable.removeParent(),t!==""&&s===t&&i.placeable.checkParent())}},onReset:function(e,t){return TundraSDK.framework.events.subscribe("Scene.Reset",e,t)},onEntityCreated:function(e,t){return TundraSDK.framework.events.subscribe("Scene.EntityCreated",e,t)},onEntityRemoved:function(e,t){return TundraSDK.framework.events.subscribe("Scene.EntityRemoved",e,t)},onComponentCreated:function(e,t){return TundraSDK.framework.events.subscribe("Scene.ComponentCreated",e,t)},onComponentRemoved:function(e,t){return TundraSDK.framework.events.subscribe("Scene.ComponentRemoved",e,t)},onAttributeChanged:function(e,t){return TundraSDK.framework.events.subscribe("Scene.AttributeChanged",e,t)},onEntityAction:function(e,t){return TundraSDK.framework.events.subscribe("Scene.EntityAction",e,t)},_publishEntityCreated:function(e){if(e==null){console.log("ERROR: Scene trying to publish EntityCreated with null entity!");return}TundraSDK.framework.events.send("Scene.EntityCreated",e)},_publishEntityRemoved:function(e){if(e==null){console.log("ERROR: Scene trying to publish EntityRemoved with null entity!");return}TundraSDK.framework.events.send("Scene.EntityRemoved",e);var t=e.id.toString();TundraSDK.framework.events.remove("Scene.ComponentCreated."+t),TundraSDK.framework.events.remove("Scene.ComponentRemoved."+t),TundraSDK.framework.events.remove("Scene.AttributeChanged."+t),TundraSDK.framework.events.remove("Scene.EntityAction."+t)},_publishComponentCreated:function(e,t){if(e==null){console.log("ERROR: Scene trying to publish ComponentCreated with null entity!");return}if(t==null){console.log("ERROR: Scene trying to publish ComponentCreated with null component!");return}TundraSDK.framework.events.send("Scene.ComponentCreated",e,t),TundraSDK.framework.events.send("Scene.ComponentCreated."+e.id.toString(),e,t)},_publishComponentRemoved:function(e,t){if(e==null){console.log("ERROR: Scene trying to publish ComponentRemoved with null entity!");return}if(t==null){console.log("ERROR: Scene trying to publish ComponentRemoved with null component!");return}TundraSDK.framework.events.send("Scene.ComponentRemoved",e,t),TundraSDK.framework.events.send("Scene.ComponentRemoved."+e.id.toString(),e,t)},_publishEntityAction:function(e){if(e==null){console.log("ERROR: Scene trying to publish EntityAction with null entity action object!");return}if(e.entity==null){console.log("ERROR: Scene trying to publish EntityAction with null entity in the action object!");return}TundraSDK.framework.events.send("Scene.EntityAction",e),TundraSDK.framework.events.send("Scene.EntityAction."+e.entity.id.toString(),e)},_publishAttributeChanged:function(e,t){if(e==null){console.log("ERROR: Scene trying to publish AttributeChanged with null entity!");return}if(t.owner==null){console.log("ERROR: Scene trying to publish AttributeChanged with null component!");return}var n=e.id.toString(),r=t.owner.id.toString(),i=t.index,s=t.getClone();TundraSDK.framework.events.send("Scene.AttributeChanged",e,t.owner,t.index,t.name,s),TundraSDK.framework.events.send("Scene.AttributeChanged."+n,e,t.owner,t.index,t.name,s),TundraSDK.framework.events.send("Scene.AttributeChanged."+n+"."+r,e,t.owner,t.index,t.name,s),TundraSDK.framework.events.send("Scene.AttributeChanged."+n+"."+r+"."+i,s)},_initComponentProperties:function(e){for(var t=Scene.componentPropertyNames.length-1;t>=0;t--){var n=Scene.componentPropertyNames[t];if(n==="name")continue;e[n]=null,n!==n.toLowerCase()&&(e[n.toLowerCase()]=null)}},nextFreeIdLocal:function(){for(var e=1e5;e<2e5;++e)if(this.entityById(e)==null)return e;return-1},nextFreeId:function(){for(var e=1;e<1e5;++e)if(this.entityById(e)==null)return e;return-1},reset:function(){this.id=1;while(this.entities.length>0){var e=this.entities[0];e!=null&&e.reset(),this.entities.splice(0,1)}this.entities=[],TundraSDK.framework.events.remove("Scene.EntityCreated"),TundraSDK.framework.events.remove("Scene.EntityRemoved"),TundraSDK.framework.events.remove("Scene.ComponentCreated"),TundraSDK.framework.events.remove("Scene.ComponentRemoved"),TundraSDK.framework.events.remove("Scene.EntityAction"),TundraSDK.framework.events.send("Scene.Reset",this)},update:function(e){},createLocalEntity:function(e,t,n){if(e===undefined||e===null)e=[];if(t===undefined||t===null)t=AttributeChange.LocalOnly;if(n===undefined||n===null||typeof n!="boolean")n=!1;return this.createEntity(this.nextFreeIdLocal(),e,t,!1,n)},createEntity:function(e,t,n,r,i){if(e===undefined||e===null||typeof e!="number")e=0;if(t===undefined||t===null)t=[];if(n===undefined||n===null)n=AttributeChange.Default;typeof n!="number"&&(this.log.warn("createEntity called with non AttributeChange.Type change mode, defaulting to AttributeChange.Default."),n=AttributeChange.Default),n!=AttributeChange.LocalOnly&&(n=AttributeChange.LocalOnly);if(r===undefined||r===null||typeof r!="boolean")r=!0;if(i===undefined||i===null||typeof i!="boolean")i=!0;var s=new Entity;s.replicated=r,s.local=!s.replicated,s.setId(e!=0?e:s.replicated?this.nextFreeId():this.nextFreeIdLocal()),this._initComponentProperties(s),this.addEntity(s);for(var o=0;o<t.length;++o)var u=IComponent.ensureComponentNamePrefix(t[o]),a=s.createComponent(u,null,i?AttributeChange.Replicate:AttributeChange.LocalOnly);return t.length>0&&s.update(),s},addEntity:function(e){return this.entities.push(e),e.setParent(this),e.update(),this._publishEntityCreated(e),!0},removeEntity:function(e){for(var t=this.entities.length-1;t>=0;t--)if(this.entities[t].id===e){var n=this.entities[t];return n!=null&&(this._publishEntityRemoved(n),n.reset()),this.entities.splice(t,1),n=null,!0}return!1},entityById:function(e){for(var t=this.entities.length-1;t>=0;t--)if(this.entities[t].id===e)return this.entities[t];return null},entityByName:function(e){for(var t=this.entities.length-1;t>=0;t--)if(this.entities[t].name===e)return this.entities[t];return null},entitiesWithComponent:function(e,t){var n=[];if(e==null&&t==null)return n;var r=typeof e!="string";for(var i=this.entities.length-1;i>=0;i--){var s=r?this.entities[i].componentById(e):this.entities[i].component(e);s!=null&&(t==null?n.push(this.entities[i]):s.name==t&&n.push(this.entities[i]))}return n},entitiesWithComponents:function(e){var t=[];if(e==null||e.length===undefined||e.length<=0)return t;var n=typeof e[0]!="string";for(var r=this.entities.length-1;r>=0;r--)for(var i=0,s=e.length;i<s;++i){var o=n?this.entities[r].componentById(e[i]):this.entities[r].component(e[i]);o!=null&&(name==null?t.push(this.entities[r]):o.name==name&&t.push(this.entities[r]))}return t},components:function(e,t){var n=[],r=this.entitiesWithComponent(e,t);for(var i=r.length-1;i>=0;i--)n.push(r[i].component(e));return n},createComponent:function(e,t){if(e===undefined||e===null)return null;if(t===undefined||t===null)t="";if(typeof t!="string")return this.log.error("createComponent called with non-string component name."),null;var n=-1,r=IComponent.ensureComponentNamePrefix(e);for(var i in Network.components)if(Network.components[i]===r){n=parseInt(i);break}return n==-1?(this.log.error("createComponent could not find component implementation for '"+e+"'"),null):this.createComponentById(-1,n,t)},createComponentById:function(e,t,n,r){n===undefined&&(n=""),r===null&&(r=undefined);var i=null,s=Scene.registeredComponent(t);if(s!==undefined)try{i=this._createComponentImpl(s,e,t,n)}catch(o){this.log.error("Failed to instantiate registered component "+s.typeName+": "+o),console.error!=null&&console.error(o);return}if(i!=null)r!==undefined&&i.deserializeFromBinary(r);else{var u=Network.components[t];(u===undefined||u===null)&&this.log.warn("Component type name could not be resolved from ID "+t),i=new IComponent(e,t,u,n),i.notImplemented=!0}return i},_createComponentImpl:function(e,t,n,r){return new e.prototype(t,n,e.typeName,r)},createComponentFromBinary:function(e,t){var n=t.readVLE(),r=t.readVLE(),i=t.readStringU8(),s=t.readVLE(),o=t.readBytes();t.readLimitBytes=s;var u=this.createComponentById(n,r,i,t);if(u==null){this.log.error("Failed to create Component with id "+n+" and type id "+r+" from binary data.");return}var a=s-(t.readBytes()-o);return a>0&&t.skipBytes(a),e.addComponent(u)},onTundraMessage:function(e){if(e.id===119){this.handleRigidBodyUpdateMessage(e.ds);return}var t=e.ds.readVLE(),n=e.ds.readVLE();e.id===113?this.handleEditAttributesMessage(n,e.ds):e.id===110?this.handleCreateEntityMessage(n,e.ds):e.id===116?this.handleRemoveEntityMessage(n):e.id===111?this.handleCreateComponentsMessage(n,e.ds):e.id===115?this.handleRemoveComponentsMessage(n,e.ds):e.id===112?this.handleCreateAttributesMessage(n,e.ds):e.id===114&&this.handleRemoveAttributesMessage(n,e.ds)},handleEntityActionMessage:function(e){e.entityAction.entity=this.entityById(e.entityAction.entityId);if(e.entityAction.entity==null){TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to find entity with id "+e.entityAction.entityId+" to execute Entity action on!",!0);return}this._publishEntityAction(e.entityAction)},handleCreateEntityMessage:function(e,t){var n=this.createEntity(e,[],AttributeChange.Replicate,!0,!0);n.temporary=t.readBoolean();var r=0;TundraSDK.framework.client.protocolVersion>=Network.protocolVersion.HierarchicScene&&(r=t.readU32());var i=t.readVLE();for(var s=0;s<i;++s)if(!this.createComponentFromBinary(n,t)){this.log.error("Failed to create Component to a newly created Entity "+e);return}},handleRemoveEntityMessage:function(e){if(this.removeEntity(e))return;TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to find Entity with id "+e+" for removal!")},handleCreateComponentsMessage:function(e,t){var n=this.entityById(e);if(n==null){TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to create Components. Entity with id "+e+" was not found!");return}while(t.bytesLeft()>=3)if(!this.createComponentFromBinary(n,t)){this.log.error("Failed to create Component to a existing Entity "+e);return}},handleRemoveComponentsMessage:function(e,t){var n=this.entityById(e);if(n==null){TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to remove Components. Entity with id "+e+" was not found!");return}while(t.bytesLeft()>=1){var r=t.readVLE();if(n.removeComponent(r))continue;TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to remove Component with id "+r+" from Entity "+e);return}},handleCreateAttributesMessage:function(e,t){var n=this.entityById(e);if(n==null){TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to create Attribute. Entity with id "+e+" was not found!");return}while(t.bytesLeft()>=3){var r=t.readVLE(),i=n.componentById(r);if(i!=null){var s=t.readU8();i.createAttributeFromBinary(s,t)}else if(TundraSDK.framework.client.networkDebugLogging){this.log.error("Failed to create Attribute from Component with id "+r+" from Entity "+e+". Component not found!");return}}},handleRemoveAttributesMessage:function(e,t){var n=this.entityById(e);if(n==null){TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to remove Attribute. Entity with id "+e+" was not found!");return}while(t.bytesLeft()>=2){var r=t.readVLE(),i=n.componentById(r);if(i==null){TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to remove Attribute with component id "+r+". Component not found!");return}if(!i.isDynamic()){this.log.error("Cannot remove Attribute from Component with id "+r+". Component is not of dynamic type.");return}i.removeAttribute(t.readU8())}},handleEditAttributesMessage:function(e,t){var n=this.entityById(e);if(n==null){TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to update Attributes. Entity with id "+e+" was not found!");return}while(t.bytesLeft()>=2){var r=t.readVLE(),i=n.componentById(r);if(i==null){TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to update Attributes with component id "+r+". Component not found!");return}var s=t.readVLE();if(i.notImplemented){t.skipBytes(s);continue}if(t.readBit()===1)for(var o=0;o<i.attributeCount;++o){if(t.readBit()===0)continue;i.deserializeAttributeFromBinary(o,t)}else{var u=t.readU8();for(var a=0;a<u;++a){var f=t.readU8();i.deserializeAttributeFromBinary(f,t)}}}},handleRigidBodyUpdateMessage:function(e){while(e.bitsLeft()>=9){var t=e.readVLE(),n=this.entityById(t),r=n?n.placeable:null,i=r?r.attributes.transform.get():new Transform;n==null&&TundraSDK.framework.client.networkDebugLogging&&this.log.error("Failed to find entity with id "+t+" to apply rigid body update to!");var s=e.readArithmeticEncoded5(8,3,4,3,3,2),o=s[0],u=s[1],a=s[2],f=s[3],l=s[4];o==1?i.setPosition(e.readSignedFixedPoint(11,8),e.readSignedFixedPoint(11,8),e.readSignedFixedPoint(11,8)):o==2&&i.setPosition(e.readFloat32(),e.readFloat32(),e.readFloat32());if(u==1){var c=e.readNormalizedVector2D(8);i.lookAt(new THREE.Vector3(0,0,0),new THREE.Vector3(c.x,0,c.y))}else if(u==2){var h=e.readNormalizedVector3D(9,8);i.lookAt(new THREE.Vector3(0,0,0),new THREE.Vector3(h.x,h.y,h.z))}else if(u==3){var p=e.readBits(10);if(p!=0){var d=p*Math.PI/1023,v=e.readNormalizedVector3D(11,10),m=new THREE.Quaternion;m.setFromAxisAngle(new THREE.Vector3(v.x,v.y,v.z),d),i.setRotation(m)}else i.setRotation(0,0,0)}if(a==1){var g=e.readFloat32();i.setScale(g,g,g)}else a==2&&i.setScale(e.readFloat32(),e.readFloat32(),e.readFloat32());f==1?e.readVector3D(11,10,3,8):f==2&&e.readVector3D(11,10,10,8);if(l==1){var d=e.readBits(10);d!=0&&e.readNormalizedVector3D(11,10)}r&&(o!=0||u!=0||a!=0)&&r.attributes.transform.set(i,AttributeChange.LocalOnly)}}}),AssetCache=Class.$extend({__init__:function(){this.assets={}},get:function(e){return this.assets[e]},set:function(e,t){this.assets[e]=t},remove:function(e){delete this.assets[e]},hasAsset:function(e){return this.get(e)!==undefined},getAssets:function(){var e=[];for(var t in this.assets)e.push(this.assets[t]);return e},forgetAssets:function(){this.assets={}}}),_enableAssetProfiling=!1,_profiling=_enableAssetProfiling?{loaded:0,timeTotal:0,types:["all"]}:undefined,IAsset=Class.$extend({__init__:function(e,t){this.log=TundraLogging.getLogger(t),this.name=e,this.type=t,this.baseRef=e.indexOf("/")!=0?e.substring(0,e.lastIndexOf("/")+1):"",e.indexOf(".zip#")!=-1&&(this.baseRef=e.substring(0,e.lastIndexOf(".zip#")+5)),this.dependencyRefs=[],this.requiresCloning=!1,this.isCloneSource=!1,this.logging=!1},__classvars__:{cloneCounts:{}},numClones:function(){var e=IAsset.cloneCounts[this.name];return e===undefined&&(e=0),e},cloneName:function(e){return this.name+"_clone_"+e},isLoaded:function(){return!1},onDeserializedFromData:function(e,t){return TundraSDK.framework.events.subscribe("IAsset.DeserializedFromData."+this.name,e,t)},onLoaded:function(e,t){return TundraSDK.framework.events.subscribe("IAsset.Loaded."+this.name,e,t)},onDependencyFailed:function(e,t){return TundraSDK.framework.events.subscribe("IAsset.DependencyFailed."+this.name,e,t)},onUnloaded:function(e,t){return TundraSDK.framework.events.subscribe("IAsset.Unloaded."+this.name,e,t)},clone:function(e){if(e===undefined||typeof e!="string"){var t=this.numClones()+1;e=this.cloneName(t),IAsset.cloneCounts[this.name]=t}if(e===undefined||typeof e!="string")return this.log.error("Canno clone() as input parameter 'newAssetName' is not defined!"),null;var n=TundraSDK.framework.asset.getAsset(e);if(n!==undefined&&n!==null)return this.log.error("Cannot clone() asset '"+this.name+"' to new asset '"+e+"', it already exists!"),null;var r=this._cloneImpl(e);return r!==undefined&&r!==null?TundraSDK.framework.asset.cache.set(r.name,r):this.log.error("Failed to create clone '"+e+"'"),r},_cloneImpl:function(e){return this.log.warn("_cloneImpl() not implemented/overridden by this asset type '"+this.type+"'"),null},numDependencies:function(){return this.dependencies().length},numPendingDependencies:function(){return 0},dependencies:function(){return this.dependencyRefs},pendingDependencies:function(){return[]},deserializeFromData:function(e){},unload:function(){},_deserializeFromData:function(e,t){var n=undefined;if(_profiling!==undefined)for(var r=0;r<_profiling.types.length;r++)if(_profiling.types[r]==="all"||_profiling.types[r]===this.type){n=new Date;break}var i=this.deserializeFromData(e,t);i===undefined?i=!0:typeof i!="boolean"&&(this.log.error("deserializeFromData returned non boolean type value: "+i+" for "+this.name+". Assuming loading failed, marking to false. Fix your failure code paths to return 'false'.",!0),i=!1);if(_profiling!==undefined&&n!==undefined){var s=this.name.substring(this.name.lastIndexOf("/")+1),o=new Date-n;_profiling.timeTotal+=o,_profiling.loaded+=i?1:0,console.log("Loaded in "+o+" msec [totals: time spent = "+_profiling.timeTotal+" msec num = "+_profiling.loaded+"] "+s)}return i&&TundraSDK.framework.asset._emitAssetDeserializedFromData(this),i&&this.isLoaded()&&this._emitLoaded(),i},_unload:function(){this.unload(),this._emiUnloaded()},_emitDeserializedFromData:function(){TundraSDK.framework.events.send("IAsset.DeserializedFromData."+this.name,this)},_emitLoaded:function(){TundraSDK.framework.events.send("IAsset.Loaded."+this.name,this)},_emitDependencyFailed:function(e){TundraSDK.framework.events.send("IAsset.DependencyFailed."+this.name,e)},_emiUnloaded:function(){TundraSDK.framework.events.send("IAsset.Unloaded."+this.name,this)}}),AssetTransfer=Class.$extend({__init__:function(e,t,n,r,i){this.log=TundraLogging.getLogger("AssetTransfer"),this.factory=e,this.ref=t,this.proxyRef=n,this.type=r,this.suffix=i,this.requestDataType=undefined,this.requestTimeout=1e4,this.active=!1,this.loading=!1,this.aborted=!1,this.parentAssets=[],this.subscribers=[],this.subscriptions=[]},__classvars__:{completedFired:{},reset:function(){AssetTransfer.completedFired={}},HttpStatus:{CONTINUE:100,SWITCHING_PROTOCOLS:101,OK:200,CREATED:201,ACCEPTED:202,NON_AUTHORITATIVE_INFORMATION:203,NO_CONTENT:204,RESET_CONTENT:205,PARTIAL_CONTENT:206,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,USE_PROXY:305,TEMPORARY_REDIRECT:307,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_TIMEOUT:408,CONFLICT:409,GONE:410,LENGTH_REQUIRED:411,PRECONDITION_FAILED:412,REQUEST_ENTITY_TOO_LARGE:413,REQUEST_URI_TOO_LONG:414,UNSUPPORTED_MEDIA_TYPE:415,REQUEST_RANGE_NOT_SATISFIABLE:416,EXPECTATION_FAILED:417,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505},statusCodeName:function(e){switch(e){case this.HttpStatus.CONTINUE:return"Continue";case this.HttpStatus.SWITCHING_PROTOCOLS:return"Switching Protocols";case this.HttpStatus.OK:return"OK";case this.HttpStatus.CREATED:return"Created";case this.HttpStatus.ACCEPTED:return"Accepted";case this.HttpStatus.NON_AUTHORITATIVE_INFORMATION:return"Non Authoritative Information";case this.HttpStatus.NO_CONTENT:return"No Content";case this.HttpStatus.RESET_CONTENT:return"Reset Content";case this.HttpStatus.PARTIAL_CONTENT:return"Partial Content";case this.HttpStatus.MULTIPLE_CHOICES:return"Multiple Choices";case this.HttpStatus.MOVED_PERMANENTLY:return"Moved Permanently";case this.HttpStatus.FOUND:return"Found";case this.HttpStatus.SEE_OTHER:return"See Other";case this.HttpStatus.NOT_MODIFIED:return"Not Modified";case this.HttpStatus.USE_PROXY:return"Use Proxy";case this.HttpStatus.TEMPORARY_REDIRECT:return"Temporary Redirect";case this.HttpStatus.BAD_REQUEST:return"Bad Request";case this.HttpStatus.UNAUTHORIZED:return"Unauthorized";case this.HttpStatus.PAYMENT_REQUIRED:return"Payment Required";case this.HttpStatus.FORBIDDEN:return"Forbidden";case this.HttpStatus.NOT_FOUND:return"Not Found";case this.HttpStatus.METHOD_NOT_ALLOWED:return"Method Not Allowed";case this.HttpStatus.NOT_ACCEPTABLE:return"Not Acceptable";case this.HttpStatus.PROXY_AUTHENTICATION_REQUIRED:return"Proxy Authentication Required";case this.HttpStatus.REQUEST_TIMEOUT:return"Request Timeout";case this.HttpStatus.CONFLICT:return"Conflict";case this.HttpStatus.GONE:return"Gone";case this.HttpStatus.LENGTH_REQUIRED:return"Length Required";case this.HttpStatus.PRECONDITION_FAILED:return"Precondition Failed";case this.HttpStatus.REQUEST_ENTITY_TOO_LARGE:return"Request Rntity Too Large";case this.HttpStatus.REQUEST_URI_TOO_LONG:return"Request Uri Too Long";case this.HttpStatus.UNSUPPORTED_MEDIA_TYPE:return"Unsupported Media Type";case this.HttpStatus.REQUEST_RANGE_NOT_SATISFIABLE:return"Request Range Not Satisfiable";case this.HttpStatus.EXPECTATION_FAILED:return"Expectation Failed";case this.HttpStatus.INTERNAL_SERVER_ERROR:return"Internal Server Error";case this.HttpStatus.NOT_IMPLEMENTED:return"Not Implemented";case this.HttpStatus.BAD_GATEWAY:return"Bad Gateway";case this.HttpStatus.SERVICE_UNAVAILABLE:return"Service Unavailable";case this.HttpStatus.GATEWAY_TIMEOUT:return"Gateway Timeout";case this.HttpStatus.HTTP_VERSION_NOT_SUPPORTED:return"Http Version Not Supported";case 0:return"";default:return"Unknown HTTP status code "+e}},isHttpSuccess:function(e){switch(e){case this.HttpStatus.OK:case this.HttpStatus.CREATED:case this.HttpStatus.ACCEPTED:case this.HttpStatus.NOT_MODIFIED:return!0;default:return!1}}},toString:function(){return"ref = "+this.ref+" type = "+this.type+" suffix = "+this.suffix+" dataType = "+this.requestDataType},abort:function(){this.aborted=!0},addParentAsset:function(e){if(!(e instanceof IAsset)){this.log.error("addParentAsset called with non IAsset object:",e);return}for(var t=0;t<this.parentAssets.length;t++)if(this.parentAssets[t].name===e.name)return;this.parentAssets.push(e)},onCompleted:function(e,t,n){this.subscribers.push({type:"completed",context:e,callback:t,metadata:n})},onFailed:function(e,t,n){this.subscribers.push({type:"failed",context:e,callback:t,metadata:n})},_detectRequestDataType:function(){var e=this.factory!=null?this.factory.requestDataType(this.suffix):undefined;return typeof e=="string"?e:(this.log.warn("AssetFactory for",this.ref,"failed to return data type. Guessing from known types."),this.type==="Binary"?"arraybuffer":this.type==="Text"&&this.suffix===".xml"||this.suffix===".txml"?"xml":this.type==="Text"&&this.suffix===".html"||this.suffix===".html"?"document":this.type==="Text"&&this.suffix===".json"?"json":this.type==="Text"?"text":undefined)},_send:function(){if(this.active===!0){this.log.error("Transfer is already active, refusing to re-send:",this.ref);return}this.active=!0;if(this.proxyRef!==undefined&&TundraSDK.framework.asset.getHttpProxyResolver()!==undefined){var e=TundraSDK.framework.asset.getHttpProxyResolver().resolveRequestMetadata(this,this.proxyRef);e!==undefined&&(this.requestDataType=typeof e.dataType=="string"?e.dataType:undefined,this.requestTimeout=typeof e.timeout=="number"?e.timeout:this.requestTimeout)}if(this.requestDataType===undefined||this.requestDataType===null||this.requestDataType==="")this.requestDataType=this._detectRequestDataType();if(this.requestDataType!=="arraybuffer"&&this.requestDataType!=="document")$.ajax({type:"GET",timeout:this.requestTimeout,url:this.proxyRef!==undefined?this.proxyRef:this.ref,dataType:this.requestDataType,context:this,success:this._onTransferCompleted,error:this._onTransferFailed});else{var t=new XMLHttpRequest;t.open("GET",this.proxyRef!==undefined?this.proxyRef:this.ref,!0),t.responseType=this.requestDataType,t.timeout=this.requestTimeout,t.addEventListener("load",this._onTransferCompletedBinary.bind(this),!1),t.addEventListener("timeout",this._onTransferFailedBinary.bind(this),!1),t.addEventListener("error",this._onTransferFailedBinary.bind(this),!1),t.send(null)}},_handleHttpErrors:function(e){return AssetTransfer.isHttpSuccess(e)?!1:(TundraSDK.framework.asset.assetTransferFailed(this,"Request failed "+this.ref+": "+e+" "+AssetTransfer.statusCodeName(e)),!0)},_onTransferCompleted:function(e,t,n){if(this.aborted===!0)return;if(this._handleHttpErrors(n.status))return;this._loadAssetFromData(e),n.responseText=null,n.responseXml=null,delete n,n=null,delete e,e=null},_onTransferCompletedBinary:function(e){if(this.aborted===!0)return;var t=e.currentTarget;if(this._handleHttpErrors(t.status))return;this._loadAssetFromData(t.response),t.response=null,delete t,t=null},_onTransferFailed:function(e,t,n){if(this.aborted===!0)return;TundraSDK.framework.asset.assetTransferFailed(this,"Request failed "+this.ref+": "+(e.status!==0?e.status:"Request Timed Out")+" "+AssetTransfer.statusCodeName(e.status)+(typeof t=="string"?" ("+t+")":"")),e.responseText=null,e.responseXml=null,delete e,e=null},_onTransferFailedBinary:function(e){if(this.aborted===!0)return;var t=e.currentTarget;TundraSDK.framework.asset.assetTransferFailed(this,"Request failed "+this.ref+": "+(t.status!==0?t.status:"Request Timed Out")+" "+AssetTransfer.statusCodeName(t.status)),t.response=null,delete t,t=null},_loadAssetFromData:function(e){TundraSDK.framework.asset.removeActiveTransfer(this);var t=TundraSDK.framework.asset.createEmptyAsset(this.ref,this.type);if(t==null){TundraSDK.framework.asset.assetTransferFailed(this,"Failed to create asset of unknown type '"+this.type+"' for '"+this.ref+"'");return}try{this._deserializeFromData(t,e)}catch(n){TundraSDK.framework.asset.assetTransferFailed(this,"Exception while deserializing asset from data: "+n,!0),n.stack!==undefined&&console.error(n.stack),console.log(this)}this.active=!1},_deserializeFromData:function(e,t){var n=e._deserializeFromData(t,this.requestDataType);n?e.isLoaded()?this._assetLoadCompleted(e):(this.loading=!0,this.subscriptions.push(e.onLoaded(this,this._assetLoadCompleted)),this.subscriptions.push(e.onDependencyFailed(this,this._assetDependencyFailed))):TundraSDK.framework.asset.assetTransferFailed(this,"IAsset.deserializeFromData failed loading asset "+this.ref)},_assetLoadCompleted:function(e){this.loading=!1,TundraSDK.framework.asset.assetTransferCompleted(this,e)},_assetDependencyFailed:function(e){this.loading=!1,TundraSDK.framework.asset.assetTransferFailed(this,"Asset request failed: "+this.ref+". Dependency "+e+" could not be loaded.")},_emitCompleted:function(e){for(var t=0;t<this.subscriptions.length;t++)TundraSDK.framework.events.unsubscribe(this.subscriptions[t]);this.subscriptions=[];var n=AssetTransfer.completedFired[e.name];n===undefined&&(n=0);for(var t=0;t<this.subscribers.length;++t)try{var r=this.subscribers[t];if(r.type!=="completed")continue;var i=null;e.requiresCloning&&n>0?i=e.clone():i=e,n++,r.callback.call(r.context!==undefined&&r.context!==null?r.context:this,i,r.metadata)}catch(s){TundraSDK.framework.client.logError("[AssetTransfer]: Completed handler exception: "+s,!0),s.stack!==undefined&&console.error(s.stack)}AssetTransfer.completedFired[e.name]=n,this.subscribers=[]},_emitFailed:function(e){for(var t=0;t<this.subscriptions.length;t++)TundraSDK.framework.events.unsubscribe(this.subscriptions[t]);this.subscriptions=[];for(var t=0;t<this.subscribers.length;++t)try{var n=this.subscribers[t];if(n.type!=="failed")continue;n.callback.call(n.context!==undefined&&n.context!==null?n.context:this,this,e,n.metadata)}catch(r){TundraSDK.framework.client.logError("[AssetTransfer]: Failed handler exception: "+r,!0)}this.subscribers=[]}}),AssetFactory=Class.$extend({__init__:function(e,t,n,r){typeof e!="string"&&console.error("AssetFactory constructor 'assetType' needs to be a string!"),(t===undefined||t===null)&&console.error("AssetFactory constructor 'assetClass' is not a valid object!"),n!==undefined&&Array.isArray(n)?console.error("AssetFactory constructor 'typeExtensions' must be a object mapping suffix to request data type!"):n!==undefined&&typeof n!="object"&&console.error("AssetFactory constructor 'typeExtensions' must be a object mapping suffix to request data type!"),this.assetType=e,this.assetClass=t,this.typeExtensions=n,this.defaultDataType=r},supportedSuffixes:function(){return Object.keys(this.typeExtensions)},requestDataType:function(e){var t=this.typeExtensions[e.toLowerCase()];return typeof t=="string"?t:typeof this.defaultDataType=="string"?this.defaultDataType:undefined},canCreate:function(e){if(this.typeExtensions===undefined||this.typeExtensions===null)return!1;var t=e.toLowerCase(),n=Object.keys(this.typeExtensions);for(var r=0,i=n.length;r<i;++r)if(CoreStringUtils.endsWith(e,n[r]))return!0;return!1},createEmptyAsset:function(e){var t=new this.assetClass(e);return this.emptyAssetCreated(t),t},emptyAssetCreated:function(e){}}),TextAsset=IAsset.$extend({__init__:function(e){this.$super(e,"TextAsset"),this.data=null},isLoaded:function(){return this.data!==null},deserializeFromData:function(e){this.data=e},unload:function(){this.data=null}}),BinaryAsset=IAsset.$extend({__init__:function(e){this.$super(e,"BinaryAsset"),this.data=null},isLoaded:function(){return this.data!==null},deserializeFromData:function(e){this.data=e},unload:function(){this.data=null}}),AssetAPI=Class.$extend({__init__:function(e){this.log=TundraLogging.getLogger("Asset"),this.localStoragePath=e.asset.localStoragePath!=null?e.asset.localStoragePath:"",this.localStoragePath!=""&&!CoreStringUtils.endsWith(this.localStoragePath,"/")&&(this.localStoragePath+="/"),this.cache=new AssetCache,this.factories=[],this.autoProcessTransfers=!0,this.maxActiveTransfers=8,this.maxActiveTransfersPerType={},this.registerAssetFactory(new AssetFactory("Text",TextAsset,{".xml":"xml",".txml":"xml",".html":"document",".htm":"document",".json":"json",".js":"json",".txt":"text"},"text")),this.registerAssetFactory(new AssetFactory("Binary",BinaryAsset,{},"arraybuffer"))},__classvars__:{httpProxyResolver:undefined,setHttpProxyResolver:function(e){this.httpProxyResolver=e}},postInitialize:function(){},setHttpProxyResolver:function(e){return AssetAPI.httpProxyResolver=e},getHttpProxyResolver:function(){return AssetAPI.httpProxyResolver},registerAssetFactory:function(e){if(e instanceof AssetFactory){for(var t=0;t<this.factories.length;++t)if(this.factories[t].assetType===e.assetType)return this.log.error("AssetFactory with type '"+e.assetType+"' already registered:",this.factories[t]),!1;return this.factories.push(e),e.typeExtensions!==undefined&&e.supportedSuffixes().length>0?this.log.debug("Registered factory",e.assetType,e.supportedSuffixes()):this.log.debug("Registered factory",e.assetType),!0}return this.log.error("registerAssetFactory called with a non AssetFactory object:",e),!1},getAssetFactory:function(e,t){if(typeof t=="string"){for(var n=0;n<this.factories.length;n++)if(this.factories[n].assetType===t)return this.factories[n]}else for(var n=0;n<this.factories.length;n++)if(this.factories[n].canCreate(e))return this.factories[n];return null},reset:function(){this.forgetAssets(!0),this.abortTransfers(),this.defaultStorage=null,this.transfers=[],this.readyTransfers=[],this.activeTransfers=[],this.startMonitoring=!1,this.tranferCheckT=0,this.tranferCheckInterval=.1,this.noFactoryErrors={},AssetTransfer.reset()},getLocalAssetPath:function(e){return this.localStoragePath+e},getAsset:function(e){return this.cache.get(e)},abortTransfers:function(){if(this.transfers!==undefined)for(var e=0;e<this.transfers.length;e++)this.transfers[e].abort();if(this.activeTransfers!==undefined)for(var e=0;e<this.activeTransfers.length;e++)this.activeTransfers[e].abort()},forgetAssets:function(e){if(e===undefined||e===null)e=!0;var t=this.cache.getAssets();for(var n=0;n<t.length;n++){var r=t[n];r!=null&&TundraSDK.framework.events.send("AssetAPI.AssetAboutToBeRemoved",r),e&&r!=null&&typeof r.unload=="function"&&(r.requiresCloning=!1,r.isCloneSource=!1,r.unload()),r=null}this.cache.forgetAssets()},update:function(e){if(e!==undefined){this.tranferCheckT+=e;if(this.tranferCheckT<this.tranferCheckInterval)return;this.tranferCheckT=0}this.transfers.length>0&&this.activeTransfers.length<this.maxActiveTransfers?this.autoProcessTransfers===!0&&this.processTransfers():this.transfers.length==0&&this.startMonitoring&&(this.startMonitoring=!1,TundraSDK.framework.client.websocket!==null&&setTimeout(function(){if(this.transfers.length>0)return;this.log.infoC("All asset transfers done"),this.noFactoryErrors={};if(TundraSDK.framework.client.networkDebugLogging===!0){var e={},t=this.cache.getAssets();for(var n=0,r=t.length;n<r;n++){var i=t[n];e[i.type]===undefined?e[i.type]=1:e[i.type]+=1}for(var s in e)this.log.debug("   >> "+s+" : "+e[s])}}.bind(this),500));if(this.readyTransfers.length>0){for(var t=0;t<this.readyTransfers.length;t++){var n=this.readyTransfers[t];n._emitCompleted(this.getAsset(n.ref)),delete n}this.readyTransfers=[]}},handleDefaultStorage:function(e){var t=JSON.parse(e);this.defaultStorage=t.storage},makeDefaultStorageRelativeRef:function(e){return this.defaultStorage==null||typeof this.defaultStorage.src!="string"||!CoreStringUtils.startsWith(e,this.defaultStorage.src)?undefined:e.substring(this.defaultStorage.src.length)},isSupportedAssetRef:function(e){return this.getAssetFactory(e)!==null},isSupportedAssetType:function(e){return this.getAssetFactory(undefined,e)!==null},requestDependencyAsset:function(e,t,n){if(e instanceof IAsset){var r=this.transfers.length,i=this.requestAsset(t,n);if(i==null)return i;i.addParentAsset(e);if(this.transfers.length>r){var s=this.transfers.splice(this.transfers.length-1,1)[0];s.ref!==i.ref&&this.log.error("Something went wrong in injecting transfer to the start of the queue: "+i.ref+" removed from last index: "+s.ref),this.transfers.splice(0,0,s)}if(e!==undefined&&e.dependencyRefs!==undefined){var o=!1;for(var u=e.dependencyRefs.length-1;u>=0;u--){o=e.dependencyRefs[u]===i.ref;if(o)break}o||e.dependencyRefs.push(i.ref)}return i}return this.log.error("requestDependencyAsset called with non IAsset object as 'parentAsset':",e),null},requestAsset:function(e,t){if(CoreStringUtils.startsWith(e,"generated://")||CoreStringUtils.startsWith(e,"local://"))return null;var n=this.getAssetFactory(e,t);if(n===null){var r=this.noFactoryErrors[e];return r===undefined&&(typeof t=="string"?this.log.error("No registered AssetFactory for type '"+t+"':",e):this.log.error("No registered AssetFactory for suffix '"+CoreStringUtils.extension(e)+"':",e),this.noFactoryErrors[e]=!0),null}var i=CoreStringUtils.extension(e),s=n.assetType;CoreStringUtils.startsWith(e,"webtundra://")?e=this.localStoragePath+e.substring(12):CoreStringUtils.startsWith(e,"http")||(this.defaultStorage!=null&&typeof this.defaultStorage.src=="string"?e=this.defaultStorage.src+e:e=this.localStoragePath+e);var o=undefined;CoreStringUtils.startsWith(e,"http")&&AssetAPI.httpProxyResolver!==undefined&&(o=AssetAPI.httpProxyResolver.resolve(e,s,i));var u=null;for(var a=this.readyTransfers.length-1;a>=0;a--){u=this.readyTransfers[a];if(u.ref===e)return u}for(var a=this.transfers.length-1;a>=0;a--){u=this.transfers[a];if(u.ref===e)return u}var f=this.getAsset(e);return f!==undefined&&f!==null?(u=new AssetTransfer(null,e,o,s,i),this.readyTransfers.push(u),u):(u=new AssetTransfer(n,e,o,s,i),this.transfers.push(u),TundraSDK.framework.events.send("AssetAPI.ActiveAssetTransferCountChanged",this.numCurrentTransfers()),u)},processTransfers:function(e){e===undefined&&(e=!0);var t=!0;if(this.transfers.length>0&&this.activeTransfers.length<this.maxActiveTransfers){var n=this.numQueuedTransfersPerType();for(var r=0;r<this.transfers.length;++r){var i=this.transfers[r];if(i===undefined||i===null){this.transfers.splice(0,1);break}if(i.active||i.loading)continue;var s=this.maxAssetTransfersForType(i.type);if(s!==undefined&&typeof s=="number"&&s>0&&this.activeTransfersForType(i.type)>=s&&Object.keys(n).length>1)continue;t=!1,this.startMonitoring=!0,this.activeTransfers.push(i),i._send();break}}e===!0&&!t&&this.transfers.length>0&&this.activeTransfers.length<this.maxActiveTransfers&&this.processTransfers(e)},maxAssetTransfersForType:function(e){return typeof e=="string"?this.maxActiveTransfersPerType[e]:undefined},numQueuedTransfersPerType:function(){var e={};for(var t=0;t<this.transfers.length;t++){if(this.transfers[t].active||this.transfers[t].loading)continue;var n=this.transfers[t].type;e[n]===undefined&&(e[n]=0),e[n]+=1}return e},numQueuedTransfers:function(){var e=0;for(var t=0;t<this.transfers.length;t++)!this.transfers[t].active&&this.transfers[t].loading&&(e+=1);return e},transferState:function(){var e={active:{},loading:{},queued:{}};for(var t=0;t<this.activeTransfers.length;t++){var n=this.activeTransfers[t].type;e.active[n]===undefined&&(e.active[n]=0),e.active[n]+=1}for(var t=0;t<this.transfers.length;t++){if(this.transfers[t].active)continue;var r=this.transfers[t].loading?"loading":"queued",n=this.transfers[t].type;e[r][n]===undefined&&(e[r][n]=0),e[r][n]+=1}return e},activeTransfersForType:function(e){var t=0;for(var n=0;n<this.activeTransfers.length;++n)this.activeTransfers[n].type===e&&t++;return t},removeActiveTransfer:function(e){for(var t=0;t<this.activeTransfers.length;++t)if(this.activeTransfers[t].ref===e.ref){this.activeTransfers.splice(t,1);break}},removeTransfer:function(e){this.removeActiveTransfer(e);for(var t=0;t<this.transfers.length;++t)if(this.transfers[t].ref===e.ref){this.transfers.splice(t,1);break}TundraSDK.framework.events.send("AssetAPI.ActiveAssetTransferCountChanged",this.numCurrentTransfers())},assetTransferCompleted:function(e,t){t.requiresCloning&&(t.isCloneSource=!0),this.getAsset(t.name)===undefined&&this.log.warn("Could not find cache item to update for",t.name,"Did you create the original asset with AssetAPI.createEmptyAsset?"),this.cache.set(t.name,t),this.removeTransfer(e),e._emitCompleted(t),t=null,delete e,e=null},assetTransferFailed:function(e,t){typeof t=="string"&&TundraSDK.framework.client.logError("[AssetAPI]: "+t,!0),this.removeTransfer(e),e._emitFailed(t),delete e,e=null},createEmptyAsset:function(e,t){var n=this.getAssetFactory(undefined,t);if(n!==null){var r=n.createEmptyAsset(e);return this.cache.set(r.name,r),TundraSDK.framework.events.send("AssetAPI.AssetCreated",r),r}return null},numCurrentTransfers:function(){return this.transfers.length},allTransfersCompleted:function(){return this.numCurrentTransfers()===0},onActiveAssetTransferCountChanged:function(e,t){return TundraSDK.framework.events.subscribe("AssetAPI.ActiveAssetTransferCountChanged",e,t)},onAssetCreated:function(e,t){return TundraSDK.framework.events.subscribe("AssetAPI.AssetCreated",e,t)},onAssetDeserializedFromData:function(e,t){return TundraSDK.framework.events.subscribe("AssetAPI.AssetDeserializedFromData",e,t)},_emitAssetDeserializedFromData:function(e){TundraSDK.framework.events.send("AssetAPI.AssetDeserializedFromData",e),e._emitDeserializedFromData()},onAssetAboutToBeRemoved:function(e,t){return TundraSDK.framework.events.subscribe("AssetAPI.AssetAboutToBeRemoved",e,t)}}),InputAPI=Class.$extend({__init__:function(e){var t=this;this.mouse={type:"",x:null,y:null,relativeX:0,relativeY:0,relativeZ:0,rightDown:!1,leftDown:!1,middleDown:!1,targetId:"",targetNodeName:"",originalEvent:null},this.keyboard={type:"",keyCode:0,key:"",repeat:!1,pressed:{},targetId:"",targetNodeName:"",originalEvent:null},this.keys={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},this.keycodes={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},$(document).keydown(function(e){t.onKeyPressInternal(e)}),$(document).keyup(function(e){t.onKeyReleaseInternal(e)})},__classvars__:{plugins:[],registerPlugin:function(e){for(var t=0;t<InputAPI.plugins.length;t++)if(InputAPI.plugins[t].name===e.name){console.error("[InputAPI]: registerPlugin() Name of the plugin needs to be unique. Name",e.name,"already registered");return}InputAPI.plugins.push(e)},getPlugin:function(e){for(var t=0;t<InputAPI.plugins.length;t++)if(InputAPI.plugins[t].name===plugin.name)return InputAPI.plugins[t];return null}},postInitialize:function(){TundraSDK.framework.input.registerMouseEvents(TundraSDK.framework.client.container);for(var e=0;e<InputAPI.plugins.length;e++)try{InputAPI.plugins[e]._start()}catch(t){TundraSDK.framework.client.logError("[InputAPI:] Plugin "+InputAPI.plugins[e].name+" start() threw exception: "+t)}},reset:function(){TundraSDK.framework.events.remove("InputAPI.MouseEvent"),TundraSDK.framework.events.remove("InputAPI.MouseMove"),TundraSDK.framework.events.remove("InputAPI.MouseClick"),TundraSDK.framework.events.remove("InputAPI.MousePress"),TundraSDK.framework.events.remove("InputAPI.MouseRelease"),TundraSDK.framework.events.remove("InputAPI.MouseWheel"),TundraSDK.framework.events.remove("InputAPI.KeyEvent"),TundraSDK.framework.events.remove("InputAPI.KeyPress"),TundraSDK.framework.events.remove("InputAPI.KeyRelease");for(var e=0;e<InputAPI.plugins.length;e++)try{InputAPI.plugins[e].reset()}catch(t){TundraSDK.framework.client.logError("[InputAPI:] Plugin "+InputAPI.plugins[e].name+" reset() threw exception: "+t)}},registerPluginEvent:function(e,t){var n="on"+e;return this[n]!==undefined?(TundraSDK.framework.client.logError("[InputAPI]: Cannot register plugin event "+e+" the handler InputAPI."+n+" is already registered!"),!1):(this[n]=function(e,n){return TundraSDK.framework.events.subscribe(t,e,n)},!0)},supportsEventType:function(e){return typeof this["on"+e]=="function"},registerMouseEvents:function(e){var t=this,n=$(e);n.mousemove(function(e){t.onMouseMoveInternal(e)}),n.mousedown(function(e){t.onMousePressInternal(e)}),n.mouseup(function(e){t.onMouseReleaseInternal(e)}),n.mousewheel(function(e,n,r,i){t.onMouseWheelInternal(e,n,r,i)}),n.bind("contextmenu",function(e){return!1})},onMouseEvent:function(e,t){return TundraSDK.framework.events.subscribe("InputAPI.MouseEvent",e,t)},onMouseMove:function(e,t){return TundraSDK.framework.events.subscribe("InputAPI.MouseMove",e,t)},onMouseClick:function(e,t){return TundraSDK.framework.events.subscribe("InputAPI.MouseClick",e,t)},onMousePress:function(e,t){return TundraSDK.framework.events.subscribe("InputAPI.MousePress",e,t)},onMouseRelease:function(e,t){return TundraSDK.framework.events.subscribe("InputAPI.MouseRelease",e,t)},onMouseWheel:function(e,t){return TundraSDK.framework.events.subscribe("InputAPI.MouseWheel",e,t)},onKeyEvent:function(e,t){return TundraSDK.framework.events.subscribe("InputAPI.KeyEvent",e,t)},onKeyPress:function(e,t){return TundraSDK.framework.events.subscribe("InputAPI.KeyPress",e,t)},onKeyRelease:function(e,t){return TundraSDK.framework.events.subscribe("InputAPI.KeyRelease",e,t)},onMouseMoveInternal:function(e){this.readMouseEvent(e),this.mouse.type="move",TundraSDK.framework.events.send("InputAPI.MouseEvent",this.mouse),TundraSDK.framework.events.send("InputAPI.MouseMove",this.mouse)},onMousePressInternal:function(e){this.readMouseEvent(e),this.mouse.type="press",TundraSDK.framework.events.send("InputAPI.MouseEvent",this.mouse),TundraSDK.framework.events.send("InputAPI.MouseClick",this.mouse),TundraSDK.framework.events.send("InputAPI.MousePress",this.mouse)},onMouseReleaseInternal:function(e){this.readMouseEvent(e),this.mouse.type="release",this.mouse.leftDown=!1,this.mouse.rightDown=!1,this.mouse.middleDown=!1,TundraSDK.framework.events.send("InputAPI.MouseEvent",this.mouse),TundraSDK.framework.events.send("InputAPI.MouseClick",this.mouse),TundraSDK.framework.events.send("InputAPI.MouseRelease",this.mouse)},onMouseWheelInternal:function(e,t,n,r){this.readMouseEvent(e,r),this.mouse.type="wheel",TundraSDK.framework.events.send("InputAPI.MouseEvent",this.mouse),TundraSDK.framework.events.send("InputAPI.MouseWheel",this.mouse)},readMouseEvent:function(e,t){this.mouse.originalEvent=e,e.target!==undefined&&e.target!==null?(this.mouse.targetNodeName=e.target.localName,this.mouse.targetId=e.target.id):(this.mouse.targetNodeName="",this.mouse.targetId=""),this.mouse.x!=null&&(this.mouse.relativeX=e.pageX-this.mouse.x),this.mouse.y!=null&&(this.mouse.relativeY=e.pageY-this.mouse.y),this.mouse.relativeZ=t!=null?t:0,this.mouse.x=e.pageX,this.mouse.y=e.pageY,TundraSDK.browser.isFirefox?(this.mouse.leftDown=e.buttons===1,this.mouse.rightDown=e.buttons===2,this.mouse.middleDown=e.buttons===3):(this.mouse.leftDown=e.which===1,this.mouse.rightDown=e.which===3,this.mouse.middleDown=e.which===2)},onKeyPressInternal:function(e){this.readKeyEvent(e),this.keyboard.type="press",TundraSDK.framework.events.send("InputAPI.KeyEvent",this.keyboard),TundraSDK.framework.events.send("InputAPI.KeyPress",this.keyboard)},onKeyReleaseInternal:function(e){this.readKeyEvent(e),this.keyboard.type="release",TundraSDK.framework.events.send("InputAPI.KeyEvent",this.keyboard),TundraSDK.framework.events.send("InputAPI.KeyRelease",this.keyboard)},readKeyEvent:function(e){this.keyboard.originalEvent=e,e.target!==undefined&&e.target!==null?(this.keyboard.targetNodeName=e.target.localName,this.keyboard.targetId=e.target.id):(this.keyboard.targetNodeName="",this.keyboard.targetId=""),this.keyboard.keyCode=e.which,this.keyboard.key=this.characterForKeyCode(e.which),this.keyboard.repeat=!1,e.type==="keydown"?this.keyboard.pressed[this.keyboard.key]===!0?this.keyboard.repeat=!0:this.keyboard.pressed[this.keyboard.key]=!0:delete this.keyboard.pressed[this.keyboard.key]},characterForKeyCode:function(e){return this.keys[e]?this.keys[e]:this.keycodes[e]?this.keycodes[e]:String.fromCharCode(e).toLowerCase()}});define("lib/jquery.contextmenu",function(){});var UiAPI=Class.$extend({__init__:function(e){this.tabActive=!0,this.buttons=[],this.numContextMenus=0,this.createTaskbar(e.taskbar),this.createConsole(e.console),$("html").css("overflow","hidden"),$("body").css("overflow","hidden"),window.addEventListener("resize",this.onWindowResizeDOM,!1);var t=this;$(window).focus(function(){t.tabActive||(t.tabActive=!0)}),$(window).blur(function(){t.tabActive&&(t.tabActive=!1)}),TundraSDK.framework.client.onConnected(this,this.onConnected),TundraSDK.framework.client.onDisconnected(this,this.onDisconnected)},postInitialize:function(){this.fps=$("<div/>",{id:"webtundra-fps"}),this.fps.css({"background-color":"transparent",position:"absolute",color:"black","font-family":"Arial","font-size":"18pt","font-weight":"bold","z-index":parseInt(this.console!=null?this.console.css("z-index"):"49")+1}),this.fps.width(60),this.fps.height(30),this.fps.fpsFrames=0,this.fps.fpsTime=0,this.fps.alwaysShow=typeof require=="function",this.fps.hide(),this.fps.cachedVisible=!1,this.addWidgetToScene(this.fps),this.onWindowResizeInternal(),TundraSDK.framework.console.registerCommand("clear","Clears the console messages",null,this,this.clearConsole),TundraSDK.framework.console.registerCommand("showFps","Toggles if FPS counter is shown",null,this,function(){this.fps.alwaysShow=!this.fps.alwaysShow,this.fps.alwaysShow?this.fps.cachedVisible||(this.fps.fadeIn(),this.fps.cachedVisible=!0):this.console!=null&&!this.console.is(":visible")&&(this.fps.fadeOut(),this.fps.cachedVisible=!1)})},reset:function(){for(var e=0;e<this.buttons.length;e++)this.buttons[e].remove();this.buttons=[];for(var e=0;e<this.numContextMenus;e++){var t=$("#webtundra-context-menu-"+e);t!=null&&t.remove()}this.numContextMenus=0,this.onWindowResizeInternal()},onConnected:function(){TundraSDK.framework.input.onKeyPress(this,this.onKeyPress),TundraSDK.framework.frame.onUpdate(this,this.onUpdate),this.fps.alwaysShow&&!this.fps.cachedVisible&&(this.fps.fadeIn(),this.fps.cachedVisible=!0)},onDisconnected:function(){this.console!=null&&this.console.is(":visible")&&this.toggleConsole(),this.clearConsole()},createTaskbar:function(e){if(this.taskbar!=null)return;if(e===undefined||e===null)e=!0;this.taskbar=e?$("<div/>"):null;if(this.taskbar==null)return;this.taskbar.attr("id","webtundra-taskbar"),this.taskbar.css({position:"absolute",top:0,padding:0,margin:0,height:30,width:"100%",border:0,"border-top":"1px solid gray","background-color":"rgb(248,248,248)","box-shadow":"inset 0 0 7px gray, 0 0 7px gray, inset 0 0px 0px 0px gray;"}),TundraSDK.browser.isOpera?this.taskbar.css("background-image","-o-linear-gradient(rgb(248,248,248),rgb(190,190,190))"):TundraSDK.browser.isFirefox?this.taskbar.css({"background-image":"-moz-linear-gradient(top, rgb(248,248,248), rgb(190,190,190))","-moz-box-shadow":"inset 0 0 0px gray, 0 0 5px gray"}):(TundraSDK.browser.isChrome||TundraSDK.browser.isSafari)&&this.taskbar.css({"background-image":"-webkit-gradient(linear, left top, left bottom, color-stop(0, rgb(248,248,248)), color-stop(0.8, rgb(190,190,190)))","-webkit-box-shadow":"0 0 7px gray"}),this.addWidgetToScene(this.taskbar),this.taskbar.hide()},createConsole:function(e){if(this.console!=null)return;if(e===undefined||e===null)e=!0;this.console=e?$("<div/>"):null;if(this.console==null)return;this.console.attr("id","webtundra-console"),this.console.css({position:"absolute",height:0,width:"100%","white-space":"pre",margin:0,padding:0,"padding-top":5,"padding-bottom":5,border:0,overflow:"auto","font-family":"Courier New","font-size":"10pt",color:"rgb(50,50,50)","background-color":"rgba(248,248,248, 0.5)","z-index":100}),this.consoleInput=$("<input/>",{id:"webtundra-console-input",type:"text"}),this.consoleInput.data("data",{history:[],index:0}),this.consoleInput.css({position:"absolute",color:"rgb(20,20,20)","background-color":"rgba(248,248,248, 0.8)",border:1,"border-top":"1px solid gray","border-bottom":"1px solid gray","padding-left":5,"font-family":"Courier New","font-size":"10pt",height:20,width:"100%","z-index":100}),this.consoleInput.focus(function(){$(this).css("background-color","white")}).blur(function(){$(this).css("background-color","rgba(248,248,248, 0.8)")}).keydown(function(e){if(e.which==9){var t=TundraSDK.framework.console.commandSuggestion($(this).val());return t!=null&&t!==$(this).val()&&$(this).val(t),e.preventDefault(),!1}if(e.which==38||e.which==40){var n=$(this).data("data");n.index+=e.which==38?1:-1,n.index>=n.history.length&&(n.index=n.history.length-1);var r=n.index>=0?n.history[n.index]:"";return n.index<-1&&(n.index=-1),$(this).val(r),e.preventDefault(),!1}}).keypress(function(e){if(e.which==13){var t=$(this).val();if(t=="")return;return TundraSDK.framework.console.executeCommandRaw(t)&&($(this).data("data").history.unshift(t),$(this).data("data").index=-1),$(this).val(""),e.preventDefault(),!1}}),TundraSDK.browser.isOpera?this.console.css("background-image","-o-linear-gradient(rgba(190,190,190,0.5), rgba(248,248,248,0.5))"):TundraSDK.browser.isFirefox?this.console.css({"background-image":"-moz-linear-gradient(top, rgba(190,190,190,0.5), rgba(248,248,248,0.5))","-moz-box-shadow":"inset 0 0 0px gray, 0 0 5px gray"}):(TundraSDK.browser.isChrome||TundraSDK.browser.isSafari)&&this.console.css({"background-image":"-webkit-gradient(linear, left top, left bottom, color-stop(0, rgba(190,190,190,0.8)), color-stop(0.8, rgba(248,248,248,0.8)))","-webkit-box-shadow":"0 0 7px gray"}),this.addWidgetToScene([this.console,this.consoleInput]),this.console.hide(),this.consoleInput.hide()},onUpdate:function(e){if(!this.fps.cachedVisible)return;this.fps.fpsFrames++,this.fps.fpsTime+=e;if(this.fps.fpsTime>=1){var t=Math.round(this.fps.fpsFrames/this.fps.fpsTime);this.fps.html(t+" <span style='font-size:8pt;color:black;'>FPS</span>"),this.fps.css("color",t>=30?"green":"red"),this.fps.fpsFrames=0,this.fps.fpsTime=0}},clearConsole:function(){this.console!=null&&this.console.empty()},onWindowResize:function(e,t){return TundraSDK.framework.events.subscribe("UiAPI.WindowResize",e,t)},onClearFocus:function(e,t){return TundraSDK.framework.events.subscribe("UiAPI.ClearFocus",e,t)},clearFocus:function(){TundraSDK.framework.events.send("UiAPI.ClearFocus")},addWidgetToScene:function(e){var t=Array.isArray(e)?e:[e],n=!0;for(var r=0;r<t.length;++r){var i=$(t[r]);if(i==null||i==undefined){console.error("[UiAPI]: Invalid input widget could not be added to the scene."),n=!1;continue}var s=i.css("z-index");typeof s=="string"&&(s=parseInt(s));if(isNaN(s)||s==null||s==undefined||typeof s!="number")s=0;s<5&&i.css("z-index",5),TundraSDK.framework.client.container.append(i)}return n},addWebComponentToScene:function(e,t,n,r){(e==null||e.indexOf("-")==-1)&&console.error("[UiAPI]: Web component tag name must contain dash (-).");var i=TundraSDK.framework.asset.requestAsset(t,"Text");i!=null&&i.onCompleted(null,function(t){var i=document.createElement(e);i.innerHTML=t.data,$("body").append(i),typeof n=="function"?n(i):r.call(n,i)})},addAction:function(e,t,n,r){if(this.taskbar==null)return null;n==null&&(n=32);var i=this.buttons.length,s="taskbar-button-"+i,o=$("<div/>",{id:s,title:e!=null?e:""});return(r===undefined||r===!0)&&o.button(),o.tooltip(),o.height(30),o.width(n),o.css({padding:0,margin:0,width:n,"min-width":n,"max-width":n,"background-color":"transparent","border-color":"transparent"}),t!=null&&t!=""&&o.css({"background-image":"url("+t+")","background-repeat":"no-repeat","background-position":"center"}),o.fadeIn(),this.taskbar.append(o),this.buttons.push(o),this.taskbar.is(":visible")||this.taskbar.fadeIn(),this.onWindowResizeInternal(),o},addContextMenu:function(e,t,n,r,i){t===undefined&&(t=!0),n===undefined&&(n=!1);var s="webtundra-context-menu-"+this.numContextMenus;this.numContextMenus++,e=$(e),e.contextMenu(s,{},{disable_native_context_menu:t,leftClick:n,showMenu:r,hideMenu:i});var o=$("#"+s);return o.css({"background-color":"#F2F2F2",border:"1px solid #999999","list-style-type":"none",margin:0,padding:0}),o},addContextMenuItems:function(e,t){t=Array.isArray(t)?t:[t];for(var n=0;n<t.length;n++){var r=t[n],i=$("<li/>"),s=$('<a href="#">'+r.name+"</a>");s.css({"font-family":"Arial","font-size":"12pt","background-color":"#F2F2F2",color:"#333333","text-decoration":"none",display:"block",padding:5}),s.hover(function(){$(this).css({"background-color":"rgb(150,150,150)",color:"rgb(255,255,255)"})},function(){$(this).css({"background-color":"#F2F2F2",color:"#333333"})}),s.data("itemName",r.name),s.on("click",r.callback),i.append(s),e.append(i)}},onKeyPress:function(e){if(this.console!=null&&e.key==="1"&&e.targetNodeName!=="input"){if(this.consoleInput.is(":visible")&&this.consoleInput.is(":focus"))return;this.toggleConsole()}},toggleConsole:function(e){if(this.console==null)return;var t=this.console.is(":visible");if(e===undefined||e===null)e=!t;if(e==t)return;t?this.fps.alwaysShow||this.fps.fadeOut():(this.console.height(0),this.console.show(),this.consoleInput.show(),this.fps.is(":visible")||this.fps.fadeIn());var n=this;this.console.animate({height:t?0:250},{duration:250,easing:"swing",progress:function(){n.onWindowResizeInternal()},complete:t?function(){n.console.scrollTop(0),n.console.hide(),n.consoleInput.trigger("blur"),n.consoleInput.hide(),n.onWindowResizeInternal()}:function(){n.console.animate({scrollTop:n.console.prop("scrollHeight")},350),n.consoleInput.focus(),n.onWindowResizeInternal()}})},onWindowResizeDOM:function(e){TundraSDK.framework.ui.onWindowResizeInternal(e);var t=TundraSDK.framework.client.container;t!=null&&TundraSDK.framework.events.send("UiAPI.WindowResize",t.width(),t.height())},onWindowResizeInternal:function(e){if(this.taskbar!=null){this.taskbar.position({my:"left bottom",at:"left bottom",of:this.taskbar.parent()});if(this.buttons.length>0){var t=0;for(var n=this.buttons.length-1;n>=0;n--)t+=this.buttons[n].width();this.buttons[0].position({my:"left",at:"right-"+t,of:this.taskbar});var r="#"+this.buttons[0].attr("id");for(var n=1;n<this.buttons.length;n++)this.buttons[n].position({my:"left",at:"right",of:r,collision:"fit"}),r=this.buttons[n]}}this.console!=null&&(this.console.is(":visible")&&this.console.position({my:"left top",at:"left top",of:this.console.parent()}),this.consoleInput.is(":visible")&&this.consoleInput.position({my:"left top",at:"left bottom",of:this.console})),this.fps!==undefined&&this.fps.is(":visible")&&this.fps.position({my:"right top",at:"right-20 top",of:TundraSDK.framework.client.container})}}),FrameAPI=Class.$extend({__init__:function(e){this.currentWallClockTime=0,this.currentFrameNumber=0,this.delayedExecutes=[]},_update:function(e){this.currentWallClockTime+=e,TundraSDK.framework.events.send("FrameAPI.Update",e),this._updateDelayedExecutes(e),this.currentFrameNumber++,this.currentFrameNumber<0&&(this.currentFrameNumber=0)},_updateDelayedExecutes:function(e){if(this.delayedExecutes.length===0)return;for(var t=0;t<this.delayedExecutes.length;++t){this.delayedExecutes[t].timeLeft-=e;if(this.delayedExecutes[t].timeLeft<=0){var n=this.delayedExecutes[t];this.delayedExecutes.splice(t,1),t--,this._postDelayedExecute(n)}}},_postDelayedExecute:function(e){try{typeof e.callback!="function"&&typeof e.context=="function"?e.context.call(e.context,e.param):e.callback.call(e.context!=null?e.context:e.callback,e.param)}catch(t){TundraLogging.getLogger("FrameAPI").error("Failed to invoke callback for delayed execute:",t)}},_postUpdate:function(e){TundraSDK.framework.events.send("FrameAPI.PostFrameUpdate",e)},reset:function(){TundraSDK.framework.events.remove("FrameAPI.Update"),TundraSDK.framework.events.remove("FrameAPI.PostFrameUpdate")},wallClockTime:function(){return this.currentWallClockTime},frameNumber:function(){return this.currentFrameNumber},onUpdate:function(e,t){return TundraSDK.framework.events.subscribe("FrameAPI.Update",e,t)},onPostFrameUpdate:function(e,t){return TundraSDK.framework.events.subscribe("FrameAPI.PostFrameUpdate",e,t)},delayedExecute:function(e,t,n,r){if(typeof e!="number"){TundraLogging.getLogger("FrameAPI").error("delayedExecute parameter 'afterSeconds' must be a number!");return}this.delayedExecutes.push({timeLeft:e,context:t,callback:n,param:typeof n!="function"&&r===undefined?n:r})}}),LoginReplyMessage=INetworkMessage.$extend({__init__:function(){this.$super(LoginReplyMessage.id,"LoginReplyMessage"),this.success=!1,this.connectionId=-1,this.replyData="",this.protocolVersion=Network.protocolVersion.Original},__classvars__:{id:101,name:"LoginReplyMessage"},deserialize:function(e){this.success=e.readBoolean(),this.connectionId=e.readVLE(),this.replyData=e.readStringU16(),e.bytesLeft()>=1&&(this.protocolVersion=e.readVLE()),delete e}}),ClientJoinedMessage=INetworkMessage.$extend({__init__:function(){this.$super(ClientJoinedMessage.id,"ClientJoinedMessage"),this.connectionId=-1},__classvars__:{id:102,name:"ClientJoinedMessage"},deserialize:function(e){this.connectionId=e.readVLE(),delete e}}),ClientLeftMessage=INetworkMessage.$extend({__init__:function(){this.$super(ClientLeftMessage.id,"ClientLeftMessage"),this.connectionId=-1},__classvars__:{id:103,name:"ClientLeftMessage"},deserialize:function(e){this.connectionId=e.readVLE(),delete e}}),TundraMessageHandler=INetworkMessageHandler.$extend({__init__:function(){this.$super("TundraMessageHandler")},canHandle:function(e){return e>=101&&e<=103?!0:e===120?!0:e>=110&&e<=116||e==119?!0:!1},handle:function(e,t){var n=TundraSDK.framework.client;if(e>=110&&e<=116||e==119){var r=new INetworkMessage(e);r.deserialize(t),n.scene.onTundraMessage(r)}else if(e===EntityActionMessage.id){var r=new EntityActionMessage;r.deserialize(t),n.scene.handleEntityActionMessage(r)}else if(e===LoginReplyMessage.id){var r=new LoginReplyMessage;r.deserialize(t),r.success?(n.connectionId=r.connectionId,n.protocolVersion=r.protocolVersion,r.loginReplyData!==""&&n.asset.handleDefaultStorage(r.replyData)):(n.log.error("Authentication to server failed: ",r),n.disconnect())}else if(e===ClientJoinedMessage.id){var r=new ClientJoinedMessage;r.deserialize(t)}else if(e===ClientLeftMessage.id){var r=new ClientLeftMessage;r.deserialize(t)}}}),LoginMessage=INetworkMessage.$extend({__init__:function(){this.$super(LoginMessage.id,"LoginMessage")},__classvars__:{id:100,name:"LoginMessage"},serialize:function(e){this.$super(4+DataSerializer.utf8StringByteSize(e)+1),this.ds.writeU16(this.id),this.ds.writeStringU16(e),this.ds.writeVLE(Network.protocolVersion.WebClientRigidBodyMessage)}}),EC_Name=IComponent.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.declareAttribute(0,"name","",Attribute.String),this.declareAttribute(1,"description","",Attribute.String),this.declareAttribute(2,"group","",Attribute.String)},onNameChanged:function(){return this.hasParentEntity()?TundraSDK.framework.events.subscribe("EC_Name.NameChanged."+this.parentEntity.id+"."+this.id,context,callback):(this.log.error("Cannot subscribe onNameChanged, parent entity not set!"),null)},setName:function(e,t){if(e!==this.attributes.name.get()){var n=this.attributes.name.getClone();this.attributes.name.set(e,t),this.hasParentEntity()&&TundraSDK.framework.events.send("EC_Name.NameChanged."+this.parentEntity.id+"."+this.id,e,n),this.hasParentScene()&&this.parentScene._onEntityNameChanged(this.parentEntity,e,n)}},getName:function(){return this.attributes.name.getClone()},setDescription:function(e,t){e!==this.attributes.description.get()&&this.attributes.description.set(e,t)},getDescription:function(){return this.attributes.description.getClone()},setGroup:function(e,t){e!==this.attributes.group.get()&&this.attributes.group.set(e,t)},getGroup:function(){return this.attributes.group.getClone()},update:function(){},attributeChanged:function(e,t,n){}});Scene.registerComponent(26,"EC_Name",EC_Name);var EC_Script=IComponent.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.declareAttribute(0,"scriptRef",[],Attribute.AssetReferenceList),this.declareAttribute(1,"runOnLoad",!1,Attribute.Bool),this.declareAttribute(2,"runMode",EC_Script.RunMode.Both,Attribute.Int),this.declareAttribute(3,"applicationName","",Attribute.String),this.declareAttribute(4,"className","",Attribute.String)},__classvars__:{RunMode:{Both:0,Client:1,Server:2},nativeScriptReplacements:[],registerNativeScriptReplacement:function(e,t){this.nativeScriptReplacements.push({keyword:e,replacement:t})},localScriptReplacement:[],registerLocalScriptReplacement:function(e,t){this.localScriptReplacement.push({keyword:e,replacement:t})}}}),EC_Avatar=IComponent.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.declareAttribute(0,"appearanceRef","",Attribute.AssetReference)}}),EC_DynamicComponent=IComponent.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r)},isDynamic:function(){return!0},hasAttribute:function(e){var t=this.getAttribute(e);return t!==undefined&&t!==null},createAttribute:function(e,t){typeof e=="string"&&(e=Attribute.toTypeId(e));if(e===undefined||e===null)return this.log.error("createAttribute: received invalid type name or id parameter."),!1;if(this.hasAttribute(t))return this.log.error("createAttribute: attribute with name '"+t+"' already exists!"),!1;var n=0;while(n<1e4){if(this.attributeIndexes[n]===undefined)break;n++}return this.declareAttribute(n,t,Attribute.defaultValueForType(e),e),this._attributeAdded(n),!0},removeAttribute:function(e){try{var t=undefined,n=undefined;typeof e=="string"?t=e:typeof e=="number"&&(n=e,t=this.attributeIndexes[e]);if(t===undefined||t===null)return!1;var r=this.attributes[t];if(r===undefined||r===null)return!1;n===undefined&&(n=r.index),this._attributeAboutToBeRemoved(r);if(this[t]!==undefined){var i={};i[t]={get:function(){return undefined},set:function(e){},configurable:!0},Object.defineProperties(this,i)}return r._reset(),r=null,delete this.attributes[t],delete this.attributeIndexes[n],this.attributes[t]=undefined,this.attributeIndexes[n]=undefined,!0}catch(s){console.error("EC_DynamicComponent.removeAttribute:",s)}return!1},onAttributeAdded:function(e,t){return this.hasParentEntity()?TundraSDK.framework.events.subscribe("EC_DynamicComponent.AttributeAdded."+this.parentEntity.id+"."+this.id,e,t):(this.log.error("Cannot subscribe onAttributeAdded, no parent entity!"),null)},_attributeAdded:function(e){typeof e=="number"&&(e=this.attributeByIndex(e)),e!==undefined&&e!==null&&this.hasParentEntity()&&TundraSDK.framework.events.send("EC_DynamicComponent.AttributeAdded."+this.parentEntity.id+"."+this.id,this,e)},onAttributeAboutToBeRemoved:function(e,t){return this.hasParentEntity()?TundraSDK.framework.events.subscribe("EC_DynamicComponent.AttributeAboutToBeRemoved."+this.parentEntity.id+"."+this.id,e,t):(this.log.error("Cannot subscribe onAttributeAboutToBeRemoved, no parent entity!"),null)},_attributeAboutToBeRemoved:function(e){e!==undefined&&e!==null&&this.hasParentEntity()&&TundraSDK.framework.events.send("EC_DynamicComponent.AttributeAboutToBeRemoved."+this.parentEntity.id+"."+this.id,this,e.index,e.name)}});Scene.registerComponent(25,"EC_DynamicComponent",EC_DynamicComponent);var TundraClient=Class.$extend({__init__:function(e){TundraSDK.framework.client=this;if(e===undefined||e===null)e={};if(e.renderSystem===undefined||e.renderSystem===null)e.renderSystem="";if(e.applications===undefined||e.applications===null)e.applications={};if(e.taskbar===undefined||e.taskbar===null)e.taskbar=!0;if(e.console===undefined||e.console===null)e.console=!0;if(e.networkDebugLogging===undefined||e.networkDebugLogging===null)e.networkDebugLogging=!1;if(e.asset===undefined||e.asset===null)e.asset={};e.asset.localStoragePath===undefined&&(e.asset.localStoragePath=""),e.container===undefined||e.container===null?(this.container=$("<div/>"),this.container.attr("id","webtundra-container"),this.container.css({"background-color":"black",position:"absolute","z-index":0,top:0,left:0,padding:0,margin:0,width:"100%",height:"100%"}),$("body").append(this.container)):this.container=$(e.container);if(e.loglevel===undefined||e.loglevel===null)e.loglevel=typeof require=="function"?TundraLogging.Level.DEBUG:TundraLogging.Level.INFO;TundraLogging.setLevel(typeof e.loglevel=="string"?e.loglevel.toUpperCase():e.loglevel),this.log=TundraLogging.getLogger("WebTundra"),this.frame=new FrameAPI(e),TundraSDK.framework.frame=this.frame,this.network=new Network(e),this.network.registerMessageHandler(new TundraMessageHandler),TundraSDK.framework.network=this.network,this.events=new EventAPI(e),TundraSDK.framework.events=this.events,this.console=new ConsoleAPI(e),TundraSDK.framework.console=this.console,this.scene=new Scene(e),TundraSDK.framework.scene=this.scene,this.asset=new AssetAPI(e),TundraSDK.framework.asset=this.asset,this.input=new InputAPI(e),TundraSDK.framework.input=this.input,this.ui=new UiAPI(e),TundraSDK.framework.ui=this.ui,this.renderer=null;if(typeof e.renderSystem=="function")this.renderer=e.renderSystem.register(TundraClient);else if(typeof e.renderSystem=="string"&&e.renderSystem!==""){for(var t=0;t<TundraClient.renderSystems.length;t++)if(CoreStringUtils.trim(TundraClient.renderSystems[t].name).toLowerCase()===CoreStringUtils.trim(e.renderSystem).toLowerCase()){this.renderer=TundraClient.renderSystems[t];break}this.renderer==null&&(this.log.warn("Could not find a requested render system with name '"+e.renderSystem+"'. Picking the first registered system instead!"),TundraClient.renderSystems.length>0&&(this.renderer=TundraClient.renderSystems[0]))}else TundraClient.renderSystems.length>0&&(this.renderer=TundraClient.renderSystems[0]);this.renderer!=null?this.renderer._load(e):this.log.error("Failed to load a render system!"),TundraSDK.framework.renderer=this.renderer,this.domIntegration=null,this.loginProperties={},this.connectionId=0,this.networkDebugLogging=e.networkDebugLogging,this.protocolVersion=Network.protocolVersion.Original,this.observerEntityId=0,this.reset(),this.ui.postInitialize(),this.asset.postInitialize(),this.input.postInitialize(),this.scene.postInitialize(),this.loadPlugins(),this.renderer!=null&&this.renderer.postInitialize(),this.onUpdateInternal(),this.console.registerCommand("disconnect","Disconnects the active server connection",null,this,this.disconnect);for(var n in e.applications)this.runApplication(n,e.applications[n])},__classvars__:{domIntegrations:[],registerDomIntegration:function(e){return e instanceof IDomIntegration?TundraClient.domIntegrations.push(e):console.error!=null&&console.error("[WebTundra]: registerDomIntegration called with object that is not an instance of IDomIntegration!"),e instanceof IDomIntegration},renderSystems:[],registerRenderSystem:function(e){return e instanceof IRenderSystem?TundraClient.renderSystems.push(e):console.error!=null&&console.error("[WebTundra]: registerRenderSystem called with object that is not an instance of IRenderSystem!"),e instanceof IRenderSystem}},loadPlugins:function(){if(this.pluginsLoaded===!0)return;this.pluginsLoaded=!0;for(var e=0;e<TundraSDK.plugins.length;e++)try{this.log.debug("Loading",TundraSDK.plugins[e].name),TundraSDK.plugins[e]._initialize()}catch(t){this.log.error("Failed to initialize "+TundraSDK.plugins[e].name+":",t)}for(var e=0;e<TundraSDK.plugins.length;e++)try{TundraSDK.plugins[e]._postInitialize()}catch(t){this.log.error("Failed to postInitialize "+TundraSDK.plugins[e].name+":",t)}},setDomIntegration:function(e){this.domIntegration!==undefined&&this.domIntegration!==null&&this.domIntegration._unload(),this.domIntegration=e,this.domIntegration._load()},registerCameraApplication:function(e,t){if(!(t instanceof ICameraApplication)){console.error("[WebTundra]: registerCameraApplication called with object that is not an instance of ICameraApplication!");return}for(var n=0;n<this.cameraApplications.length;n++)if(this.cameraApplications[n].name===e){console.error("[WebTundra]: Camera application '"+e+"' already registered!");return}this.cameraApplications.push({name:e,application:t});if(this.cameraApplications.length<=1)return;var r=this;if(this.cameraSwitcherButton!=null){this.ui.addContextMenuItems(this.cameraSwitcherMenu,{name:e,callback:function(){r.activateCameraApplication($(this).data("itemName"))}});return}this.cameraSwitcherButton=this.ui.addAction("Select Camera Mode (Tab)",TundraSDK.framework.asset.getLocalAssetPath("img/icons/icon-camera.png"),40,!1),this.cameraSwitcherMenu=this.ui.addContextMenu(this.cameraSwitcherButton,!0,!0,function(){r.cameraSwitcherButton.tooltip("close")});for(var n=0;n<this.cameraApplications.length;n++)this.ui.addContextMenuItems(this.cameraSwitcherMenu,{name:this.cameraApplications[n].name,callback:function(){r.activateCameraApplication($(this).data("itemName"))}});this.input.onKeyPress(this,function(e){if(e.keyCode===9||e.key==="tab")this.cameraApplicationIndex++,this.cameraApplicationIndex>=this.cameraApplications.length&&(this.cameraApplicationIndex=0),this.activateCameraApplication(this.cameraApplications[this.cameraApplicationIndex].name),e.originalEvent.preventDefault()})},activateCameraApplication:function(e){for(var t=0;t<this.cameraApplications.length;t++)if(this.cameraApplications[t].name===e){this.cameraApplicationIndex=t,this.cameraApplications[t].application._activateCameraApplication();return}},setAuthToken:function(e,t){this.authTokens[e]=t},getAuthToken:function(e){try{return this.authTokens[e]}catch(t){return null}},runApplication:function(e,t){if(Scene.registeredComponent("Script")==null)return this.log.error("runApplication: Cannot run script '"+t+"', Script component not registered."),null;var n=this.scene.createLocalEntity(["Name","Script"]);return n.name=e,n.script.startupApplication=!0,n.script.attributes.runMode.set(EC_Script.RunMode.Client,AttributeChange.LocalOnly),n.script.attributes.runOnLoad.set(!0,AttributeChange.LocalOnly),n.script.attributes.scriptRef.set([t],AttributeChange.LocalOnly),n},onConnected:function(e,t){return TundraSDK.framework.events.subscribe("TundraClient.Connected",e,t)},onConnectionError:function(e,t){return TundraSDK.framework.events.subscribe("TundraClient.ConnectionError",e,t)},onDisconnected:function(e,t){return TundraSDK.framework.events.subscribe("TundraClient.Disconnected",e,t)},onLogInfo:function(e,t){return TundraSDK.framework.events.subscribe("TundraClient.LogInfo",e,t)},onLogWarning:function(e,t){return TundraSDK.framework.events.subscribe("TundraClient.LogWarning",e,t)},onLogError:function(e,t){return TundraSDK.framework.events.subscribe("TundraClient.LogError",e,t)},reset:function(){this.websocket=null,this.loginProperties={},this.connectionId=0,this.authTokens={},this.frame.reset(),this.ui.reset(),this.input.reset(),this.asset.reset(),this.scene.reset(),this.renderer.reset(),this.lastTime=performance.now(),this.observerEntityId=0,this.network.lastObserverSendTime=0,this.cameraApplications=[],this.cameraApplicationIndex=0,this.cameraSwitcherButton=null,this.cameraSwitcherMenu=null},onUpdateInternal:function(){var e=TundraSDK.framework.client;requestAnimationFrame(e.onUpdateInternal);var t=performance.now(),n=t-e.lastTime;frametimeMsec=n,n/=1e3,e.lastTime=t,e.frame._update(n),e.asset.update(n),e.scene.update(n),e.renderer.update(n,frametimeMsec),e.observerEntityId>0&&e.network.updateObserver(t),e.frame._postUpdate(n)},logInfo:function(e,t){if(t===undefined||t==null)t=!1;t&&console.log!=null&&console.log(e),TundraSDK.framework.events.send("TundraClient.LogInfo",e)},logWarning:function(e,t){if(t===undefined||t==null)t=!1;t&&console.warn!=null&&console.warn(e),TundraSDK.framework.events.send("TundraClient.LogWarning",e)},logError:function(e,t){if(t===undefined||t==null)t=!1;t&&console.error!=null&&console.error(e),TundraSDK.framework.events.send("TundraClient.LogError",e)},isConnected:function(){return this.websocket==null?!1:this.websocket.readyState!=3?!0:!1},connect:function(e,t){if(typeof e!="string")return this.log.error("connect() called with non-string 'host'"),{success:!1,reason:"Host not a string"};if("WebSocket"in window)this.websocket=new WebSocket(e);else{if(!("MozWebSocket"in window))return{success:!1,reason:"This browser does not support WebSocket connections"};this.websocket=new MozWebSocket(e)}return this.websocket.binaryType="arraybuffer",this.websocket.onopen=this.onWebSocketConnectionOpened,this.websocket.onerror=this.onWebSocketConnectionError,this.websocket.onclose=this.onWebSocketConnectionClosed,this.websocket.onmessage=this.onWebSocketMessage,this.loginProperties=t!==undefined&&t!==null?t:{},{success:!0}},disconnect:function(){this.websocket!=null&&this.websocket.close(),this.reset()},onWebSocketConnectionOpened:function(e){var t=TundraSDK.framework.client;t.log.infoC("Server connection established");var n=new LoginMessage;n.serialize(JSON.stringify(t.loginProperties)),TundraSDK.framework.network.send(n),t.events.send("TundraClient.Connected")},onWebSocketConnectionError:function(e){var t=TundraSDK.framework.client;t.log.errorC("Failed to connect to",e.target.url),t.events.send("TundraClient.ConnectionError",e)},onWebSocketConnectionClosed:function(e){var t=TundraSDK.framework.client;t.log.infoC("Server connection disconnected"),t.events.send("TundraClient.Disconnected",e),t.reset()},onWebSocketMessage:function(e){var t=TundraSDK.framework.client;typeof e.data!="string"?(TundraSDK.framework.client.network.receive(e.data),e.data=null):t.log.info("Server sent a unexpected string message '"+e.data+"'")}});define("lib/three/CSS3DRenderer",function(){});var RaycastResult=Class.$extend({__init__:function(){this.entity=null,this.component=null,this.pos=new THREE.Vector3(0,0,0),this.normal=new THREE.Vector3(0,0,0),this.submeshIndex=-1,this.faceIndex=-1,this.uv=new THREE.Vector2(0,0),this.distance=-1,this.ray=null,this.execution={error:"",screenPos:new THREE.Vector2(0,0),selectionLayer:-1}},reset:function(){this.entity=null,this.component=null,this.pos.x=0,this.pos.y=0,this.pos.z=0,this.normal.x=0,this.normal.y=0,this.normal.z=0,this.submeshIndex=-1,this.faceIndex=-1,this.uv.x=0,this.uv.y=0,this.distance=-1,this.ray=null,this.execution.error="",this.execution.screenPos.x=0,this.execution.screenPos.y=0,this.execution.selectionLayer=-1},clone:function(){var e=new RaycastResult;return e.entity=this.entity,e.component=this.component,e.pos=this.pos.clone(),e.normal=this.normal.clone(),e.submeshIndex=this.submeshIndex,e.faceIndex=this.faceIndex,e.uv=this.uv.clone(),e.distance=this.distance,e.ray=this.ray.clone(),e.execution={error:this.execution.error,screenPos:this.execution.screenPos.clone(),selectionLayer:this.execution.selectionLayer},e},hasError:function(){return this.execution.error!==""},setError:function(e){this.execution.error=e},executionMatches:function(e,t,n){return this.execution.screenPos.x===e&&this.execution.screenPos.y===t&&this.execution.selectionLayer===n},setExecutionInfo:function(e,t,n){this.execution.screenPos.x=e,this.execution.screenPos.y=t,this.execution.selectionLayer=n},setPosition:function(e){this.pos.x=e.x,this.pos.y=e.y,this.pos.z=e.z}});define("lib/three/OBJLoader",function(){});var ObjMeshAsset=IAsset.$extend({__init__:function(e){this.$super(e,"ObjMeshAsset"),this.requiresCloning=!0,this.mesh=undefined},__classvars__:{Loader:new THREE.OBJLoader},isLoaded:function(){return this.mesh!==undefined&&this.mesh.children.length>0},unload:function(){if(this.requiresCloning&&this.isCloneSource)return;var e=this.numSubmeshes();this.logging&&this.mesh!=null&&e>0&&this.log.debug("unload",this.name),this.mesh!=null&&this.mesh.parent!=null&&this.mesh.parent.remove(this.mesh);for(var t=0;t<e;t++){this.logging&&console.log("  submesh "+t);var n=this.getSubmesh(t);n.geometry!=null&&(this.logging&&console.log("    geometry"),this.isGeometryInUse(n.geometry)===!1?n.geometry.dispose():this.logging&&this.log.debug("      Still in use, not unloading"),n.geometry=null),n.material=null,n=null}this.mesh!=null&&(this.mesh.children=[]),this.mesh=undefined},isGeometryInUse:function(e){if(e.uuid===undefined)return!1;var t=!1;return TundraSDK.framework.renderer.scene.traverse(function(n){if(t===!0||n==null||n.geometry===undefined||!(n.geometry instanceof THREE.BufferGeometry||n.geometry instanceof THREE.Geometry))return;n.geometry.uuid===e.uuid&&(t=!0)}),t},_cloneImpl:function(e){var t=new ObjMeshAsset(e);t.mesh=TundraSDK.framework.renderer.createSceneNode();for(var n=0,r=this.numSubmeshes();n<r;++n){var i=this.getSubmesh(n),s=null;i instanceof THREE.SkinnedMesh?s=new THREE.SkinnedMesh(i.geometry,TundraSDK.framework.renderer.materialWhite,!1):s=new THREE.Mesh(i.geometry,TundraSDK.framework.renderer.materialWhite),s.name=t.name+"_submesh_"+n,s.tundraSubmeshIndex=i.tundraSubmeshIndex,t.mesh.add(s)}return t},getSubmesh:function(e){return this.isLoaded()?this.mesh.children[e]:null},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},deserializeFromData:function(e,t){try{this.mesh=ObjMeshAsset.Loader.parse(e)}catch(n){this.log.error("Failed to load OBJ mesh",this.name,n.toString()),this.mesh=undefined}if(this.mesh===undefined||this.mesh===null)this.mesh=TundraSDK.framework.renderer.createSceneNode();this.mesh.name=this.name,this.mesh.matrixAutoUpdate=!1;for(var r=0;r<this.mesh.children.length;r++)this.mesh.children[r].tundraSubmeshIndex=r,this.mesh.children[r].name=this.name+"_submesh_"+r;return this.isLoaded()}}),ThreeJsonAsset=IAsset.$extend({__init__:function(e){this.$super(e,"ThreeJsonAsset"),this.requiresCloning=!0,this.mesh=undefined},__classvars__:{Loader:new THREE.JSONLoader},isLoaded:function(){return this.mesh!==undefined&&this.mesh.children.length>0},unload:function(){if(this.requiresCloning&&this.isCloneSource)return;var e=this.numSubmeshes();this.logging&&this.mesh!=null&&e>0&&this.log.debug("unload",this.name),this.mesh!=null&&this.mesh.parent!=null&&this.mesh.parent.remove(this.mesh);for(var t=0;t<e;t++){this.logging&&console.log("  submesh "+t);var n=this.getSubmesh(t);n.geometry!=null&&(this.logging&&console.log("    geometry"),this.isGeometryInUse(n.geometry)===!1?n.geometry.dispose():this.logging&&this.log.debug("      Still in use, not unloading"),n.geometry=null),n.material=null,n=null}this.mesh!=null&&(this.mesh.children=[]),this.mesh=undefined},isGeometryInUse:function(e){if(e.uuid===undefined)return!1;var t=!1;return TundraSDK.framework.renderer.scene.traverse(function(n){if(t===!0||n==null||n.geometry===undefined||!(n.geometry instanceof THREE.BufferGeometry||n.geometry instanceof THREE.Geometry))return;n.geometry.uuid===e.uuid&&(t=!0)}),t},_cloneImpl:function(e){var t=new ThreeJsonAsset(e);t.mesh=TundraSDK.framework.renderer.createSceneNode();for(var n=0,r=this.numSubmeshes();n<r;++n){var i=this.getSubmesh(n),s=null;i instanceof THREE.SkinnedMesh?s=new THREE.SkinnedMesh(i.geometry,TundraSDK.framework.renderer.materialWhite,!1):s=new THREE.Mesh(i.geometry,TundraSDK.framework.renderer.materialWhite),s.name=t.name+"_submesh_"+n,s.tundraSubmeshIndex=i.tundraSubmeshIndex,t.mesh.add(s)}return t},getSubmesh:function(e){return this.isLoaded()?this.mesh.children[e]:null},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},deserializeFromData:function(e,t){try{var n=ThreeJsonAsset.Loader.parse(e);if(n!==undefined&&n.geometry!==undefined){var r=undefined;n.materials!==undefined&&(r=n.materials.length===1?n.materials[0]:new THREE.MeshFaceMaterial(n.materials)),this.mesh=TundraSDK.framework.renderer.createSceneNode(),this.mesh.add(new THREE.Mesh(n.geometry,r))}else this.log.error("Parsing failed, three.js didnt return a valid geometry for",this.name)}catch(i){this.log.error("Failed to load JSON mesh",this.name,i.toString()),this.mesh=undefined}if(this.mesh===undefined||this.mesh===null)this.mesh=TundraSDK.framework.renderer.createSceneNode();this.mesh.name=this.name,this.mesh.matrixAutoUpdate=!1;for(var s=0;s<this.mesh.children.length;s++)this.mesh.children[s].tundraSubmeshIndex=s,this.mesh.children[s].name=this.name+"_submesh_"+s;return this.isLoaded()}}),EC_Fog=IComponent.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.declareAttribute(0,"mode",EC_Fog.Type.Linear,Attribute.Int),this.declareAttribute(1,"color",new Color(.707792,.770537,.831373,1),Attribute.Color),this.declareAttribute(2,"startDistance",100,Attribute.Real),this.declareAttribute(3,"endDistance",2e3,Attribute.Real),this.declareAttribute(4,"expDensity",.001,Attribute.Real)},__classvars__:{Type:{NoFog:0,Exponentially:1,ExponentiallySquare:2,Linear:3}}}),EC_Fog_ThreeJs=EC_Fog.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this._activated=!1},__classvars__:{implementationName:"three.js"},reset:function(e){if(!this._activated&&e!==!0)return;this._activated=!1,TundraSDK.framework.renderer.scene.fog=null,TundraSDK.framework.renderer.renderer.setClearColor(0),this._forceMaterialUpdates()},update:function(){if(!this._activated&&TundraSDK.framework.renderer.scene.fog!=null){this.log.warn("Fog is already set, only the first initialized fog will be enabled. Inactivating",this.toString());return}this._forceMaterialUpdates(),this._createFog(this.mode)},_forceMaterialUpdates:function(){var e=TundraSDK.framework.renderer.getAllMeshes();for(var t=0;t<e.length;t++)e[t].material!==undefined&&e[t].material!==null&&(e[t].material.needsUpdate=!0)},_createFog:function(e){this.reset(!0);if(e===EC_Fog.Type.NoFog){this._activated=!0;return}e===EC_Fog.Type.Linear?TundraSDK.framework.renderer.scene.fog=new THREE.Fog(this.color.toThreeColor(),this.startDistance,this.endDistance):TundraSDK.framework.renderer.scene.fog=new THREE.FogExp2(this.color.toThreeColor(),this.expDensity),this._activated=TundraSDK.framework.renderer.scene.fog!=null,this._activated&&TundraSDK.framework.renderer.renderer.setClearColor(TundraSDK.framework.renderer.scene.fog.color)},attributeChanged:function(e,t,n){if(!this._activated)return;e===0?this._createFog(n):e===1?(TundraSDK.framework.renderer.scene.fog.color=n.toThreeColor(),TundraSDK.framework.renderer.renderer.setClearColor(TundraSDK.framework.renderer.scene.fog.color)):e===2?TundraSDK.framework.renderer.scene.fog.near=n:e===3?TundraSDK.framework.renderer.scene.fog.far=n:e===4&&(TundraSDK.framework.renderer.scene.fog.density=n)}}),EC_AnimationController=IComponent.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.declareAttribute(0,"animationState","",Attribute.String),this.declareAttribute(1,"drawDebug",!1,Attribute.Bool)}}),EC_AnimationController_ThreeJs=EC_AnimationController.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r)},__classvars__:{implementationName:"three.js"},getAvailableAnimations:function(){var e=[];return this.parentEntity==null?e:(this.parentEntity.mesh!=null&&this.parentEntity.mesh.skeletonAsset!=null&&(e=this.parentEntity.mesh.skeletonAsset.getAvailableAnimations()),e)},playAnimation:function(e,t,n){if(this.parentEntity==null)return;this.parentEntity.mesh!=null&&this.parentEntity.mesh.skeletonAsset!=null?this.parentEntity.mesh.skeletonAsset.playAnimation(e,t,n):this.log.warn("playAnimation could not find valid skeleton from EC_Mesh.")}}),EC_Camera=IComponent.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.declareAttribute(0,"upVector",new THREE.Vector3(0,1,0),Attribute.Float3),this.declareAttribute(1,"nearPlane",.1,Attribute.Real),this.declareAttribute(2,"farPlane",2e3,Attribute.Real),this.declareAttribute(3,"verticalFov",45,Attribute.Real),this.declareAttribute(4,"aspectRatio","",Attribute.String)}}),EC_Camera_ThreeJs=EC_Camera.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.camera=undefined,this._active=!1,Object.defineProperties(this,{active:{get:function(){return this.isActive()},set:function(e){this.setActive(e)}}}),TundraSDK.framework.ui.onWindowResize(this,this.onWindowResize)},__classvars__:{implementationName:"three.js"},update:function(){this.camera===undefined?this.camera=new THREE.PerspectiveCamera(this.verticalFov,this.aspectRatio(),this.nearPlane,this.farPlane):(this.camera.fov=this.verticalFov,this.camera.aspect=this.aspectRatio(),this.camera.near=this.nearPlane,this.camera.far=this.farPlane,this.camera.updateProjectionMatrix()),this.camera.parent==null&&this.parentEntity!=null&&(this.parentEntity.placeable!=null?this.parentEntity.placeable.addChild(this.camera):this._componentAddedSub=this.parentEntity.onComponentCreated(this,this._onParentEntityComponentCreated))},reset:function(){this.active&&TundraSDK.framework.renderer.setActiveCamera(null),this._componentAddedSub!==undefined&&(TundraSDK.framework.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=undefined)},_onParentEntityComponentCreated:function(e,t){t!=null&&t.typeName==="EC_Placeable"&&(this._componentAddedSub!==undefined&&(TundraSDK.framework.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=undefined),this.camera!=null&&this.camera.parent==null&&t.addChild(this.camera))},onActiveStateChanged:function(e,t){return this.hasParentEntity()?TundraSDK.framework.events.subscribe("EC_Camera.ActiveStateChanged."+this.parentEntity.id+"."+this.id,e,t):(TundraSDK.framework.client.logError("[EC_Camera]: Cannot subscribe onActiveStateChanged, parent entity not set!",!0),null)},_postActiveStateChanged:function(e){TundraSDK.framework.events.send("EC_Camera.ActiveStateChanged."+this.parentEntity.id+"."+this.id,this.parentEntity,this,e)},setActive:function(e){e===undefined&&(e=!0);if(typeof e!="boolean")return;if(this._active===e)return;if(e&&TundraSDK.framework.renderer.activeCamera()&&TundraSDK.framework.renderer.activeCamera()._animating===!0){this.log.warn("Current camera is animating, cannot activate "+this.parentEntity.name);return}this._active=e,this._active&&TundraSDK.framework.renderer.setActiveCamera(this),this._postActiveStateChanged(this._active)},isActive:function(){return this._active},attributeChanged:function(e,t,n){this.update()},aspectRatio:function(){var e=TundraSDK.framework.renderer.windowSize;return e!==undefined&&e.height!==0?e.width/e.height:0},onWindowResize:function(e,t){if(this.camera===undefined)return;this.camera.aspect=e/t,this.camera.updateProjectionMatrix()}}),EC_Mesh=IComponent.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.declareAttribute(0,"nodeTransformation",new Transform,Attribute.Transform),this.declareAttribute(1,"meshRef","",Attribute.AssetReference),this.declareAttribute(2,"skeletonRef","",Attribute.AssetReference),this.declareAttribute(3,"materialRefs","",Attribute.AssetReferenceList),this.declareAttribute(4,"drawDistance",0,Attribute.Real),this.declareAttribute(5,"castShadows",!1,Attribute.Bool)}}),EC_Mesh_ThreeJs=EC_Mesh.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.meshAsset=null,this.skeletonAsset=null,this.materialAssets=[],this.meshRequested=!1,this.skeletonRequested=!1,this.materialsRequested=!1,this._loadsEmitted={mesh:!1}},__classvars__:{implementationName:"three.js"},reset:function(){TundraSDK.framework.events.remove("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded"),TundraSDK.framework.events.remove("EC_Mesh."+this.parentEntity.id+"."+this.id+".SkeletonLoaded"),TundraSDK.framework.events.remove("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialLoaded"),this.resetMesh(),this.resetMaterials(),this._componentAddedSub!==undefined&&(TundraSDK.framework.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=undefined)},attributeChanged:function(e,t,n){if(e===0)this.update();else if(e===1)this.resetMesh(),this.update();else if(e===2)this.update();else if(e===3)this.resetMaterials(),this.update();else if(e!==4&&e===5){if(this.meshAsset==null)return;for(var r=0,i=this.meshAsset.numSubmeshes();r<i;++r){var s=this.meshAsset.getSubmesh(r);if(s===undefined||s===null)continue;s.castShadow=n}}},update:function(){if(this.meshAsset==null&&!this.meshRequested){var e=this.attributes.meshRef.get();if(e!=null&&e!=""){var t=undefined;if(CoreStringUtils.endsWith(e,".json",!0)||CoreStringUtils.endsWith(e,".js",!0))t="ThreeJsonMesh";this.meshRequested=!0;var n=TundraSDK.framework.asset.requestAsset(e,t);n!=null&&n.onCompleted(this,this._meshAssetLoaded)}}if(this.materialAssets.length===0&&!this.materialsRequested){var r=this.attributes.materialRefs.get();for(var i=0;i<r.length;i++){this.materialsRequested=!0;var s=r[i];if(typeof s=="string"&&s!==""){var o=this.meshAsset!=null?this.meshAsset.getSubmesh(i):undefined;if(o!=undefined&&o.material!=null&&o.material.name===s)continue;var n=TundraSDK.framework.asset.requestAsset(s);n!=null&&(n.onCompleted(this,this._materialAssetLoaded,i),n.onFailed(this,this._materialAssetFailed,i),this.materialAssets[i]=n)}}}if(this.meshAsset==null||!this.meshAsset.isLoaded())return;if(this.allMaterialsLoaded()){if(this.skeletonAsset==null&&!this.skeletonRequested){var u=this.attributes.skeletonRef.get();if(u!=null&&u!=""){this.skeletonRequested=!0;var n=TundraSDK.framework.asset.requestAsset(u);if(n!=null){n.onCompleted(this,this._skeletonAssetLoaded);return}}}var r=this.attributes.materialRefs.get(),a=this.meshAsset.numSubmeshes();for(var i=0;i<a;++i){var o=this.meshAsset.getSubmesh(i);if(o===undefined||o===null)continue;var s=r[i];if(o.material!=null&&o.material.name===s)continue;var f=this.materialAssets[i];f instanceof IAsset||f instanceof THREE.Material?o.material=f instanceof IAsset?f.material:f:o.material=TundraSDK.framework.renderer.materialWhite,o.receiveShadow=o.material.hasTundraShadowShader!==undefined&&o.material.hasTundraShadowShader===!0,o.castShadow=this.castShadows}this.materialAssets.length>a&&this.log.warnC("Too many materials for target mesh "+this.meshAsset.name+". Materials: "+this.materialAssets.length+" Submeshes: "+a+" In entity: "+this.parentEntity.id+" "+this.parentEntity.name)}this.meshAsset.mesh.parent==null&&(this.parentEntity.placeable!=null?this._onParentEntityComponentCreated(this.parentEntity,this.parentEntity.placeable):this._componentAddedSub=this.parentEntity.onComponentCreated(this,this._onParentEntityComponentCreated)),TundraSDK.framework.renderer.updateSceneNode(this.meshAsset.mesh,this.nodeTransformation),this.skeletonAsset!=null&&this.skeletonAsset.attach(this.meshAsset)},_onParentEntityComponentCreated:function(e,t){t!=null&&t.typeName==="EC_Placeable"&&(this._componentAddedSub!==undefined&&(TundraSDK.framework.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=undefined),t.sceneNode!=null?this._onParentPlaceableNodeCreated(t,t.sceneNode):this._placeableNodeCreatedSub=t.onSceneNodeCreated(this,this._onParentPlaceableNodeCreated))},_onParentPlaceableNodeCreated:function(e,t){this._placeableNodeCreatedSub!==undefined&&(TundraSDK.framework.events.unsubscribe(this._placeableNodeCreatedSub),this._placeableNodeCreatedSub=undefined);if(this.meshAsset!=null&&this.meshAsset.mesh!=null){var n=this.meshAsset.mesh.parent==null;e.addChild(this.meshAsset.mesh),n&&this._loadsEmitted.mesh===!1&&(this._loadsEmitted.mesh=!0,TundraSDK.framework.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded",this.parentEntity,this,this.meshAsset))}else this.log.error("Mesh not ready but placeable is?!")},resetMesh:function(){if(this.meshAsset!=null){var e=this.parentEntity.getComponent("EC_Placeable");e!=null&&e.sceneNode!=null&&e.sceneNode.remove(this.meshAsset.mesh),this.meshAsset.unload()}this.meshAsset=null,this.meshRequested=!1},resetMaterials:function(){this.materialAssets=[],this.materialsRequested=!1},setMesh:function(e,t){return typeof e!="string"?(this.log.errorC("setMesh must be called with a string ref, called with:",e),!1):this.attributes.meshRef.set(e,t)},setMaterial:function(e,t,n){if(typeof e=="string"&&typeof t=="number"){var r=this.attributes.materialRefs.get();for(var i=r.length;i<t;++i)r.push("");return r[t]=e,this.attributes.materialRefs.set(r,n)}return this.log.errorC("setMaterial must be called single string ref and material index as the second parameter, called with:",e,t),!1},setMaterials:function(e,t){return Array.isArray(e)?this.attributes.materialRefs.set(e,t):(this.log.errorC("setMaterials must be called with Array parameter, called with:",e),!1)},onMeshLoaded:function(e,t){return this.hasParentEntity()?TundraSDK.framework.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded",e,t):(this.log.error("Cannot subscribe onMeshLoaded, parent entity not set!"),null)},onSkeletonLoaded:function(e,t){return this.hasParentEntity()?TundraSDK.framework.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".SkeletonLoaded",e,t):(this.log.error("Cannot subscribe onSkeletonLoaded, parent entity not set!"),null)},onMaterialLoaded:function(e,t){return this.hasParentEntity()?TundraSDK.framework.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialLoaded",e,t):(this.log.error("Cannot subscribe onMaterialLoaded, parent entity not set!"),null)},_meshAssetLoaded:function(e){if(!this.hasParentEntity())return;this.meshAsset=e;if(this.meshAsset.mesh!=null){this.meshAsset.mesh.tundraEntityId=this.parentEntity.id;for(var t=0,n=this.meshAsset.numSubmeshes();t<n;t++){var r=this.meshAsset.getSubmesh(t);r!=null&&(r.tundraEntityId=this.parentEntity.id)}}this.update(),this.meshAsset.mesh.parent!=null&&this._loadsEmitted.mesh===!1&&(this._loadsEmitted.mesh=!0,TundraSDK.framework.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded",this.parentEntity,this,this.meshAsset))},_skeletonAssetLoaded:function(e,t){if(!this.hasParentEntity())return;this.skeletonAsset=e,this.update(),TundraSDK.framework.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".SkeletonLoaded",this.parentEntity,this,this.skeletonAsset)},_materialAssetLoaded:function(e,t){if(!this.hasParentEntity())return;e!==undefined&&t!==undefined&&(this.materialAssets[t]=e);if(!this.allMaterialsLoaded())return;this.update();for(var n=0;n<this.materialAssets.length;++n){var r=this.materialAssets[n];r instanceof IAsset&&r.isLoaded()&&TundraSDK.framework.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialLoaded",this.parentEntity,this,n,r)}},_materialAssetFailed:function(e,t,n){this._materialAssetLoaded(TundraSDK.framework.renderer.materialLoadError,n)},allMaterialsLoaded:function(){for(var e=0;e<this.materialAssets.length;++e){var t=this.materialAssets[e];if(t===undefined||t===null)continue;if(t instanceof THREE.Material)continue;if(t instanceof AssetTransfer)return!1;if(!(t instanceof IAsset))return!1}return!0},numMaterialsLoading:function(){var e=0;for(var t=0;t<this.materialAssets.length;++t){var n=this.materialAssets[t];if(n===undefined||n===null)continue;n instanceof AssetTransfer&&e++,n instanceof IAsset&&!n.isLoaded()&&e++}return e}}),EC_Placeable=IComponent.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.declareAttribute(0,"transform",new Transform,Attribute.Transform),this.declareAttribute(1,"drawDebug",!1,Attribute.Bool),this.declareAttribute(2,"visible",!0,Attribute.Bool),this.declareAttribute(3,"selectionLayer",1,Attribute.Int),this.declareAttribute(4,"parentRef","",Attribute.EntityReference),this.declareAttribute(5,"parentBone","",Attribute.String)}}),EC_Placeable_ThreeJs=EC_Placeable.$extend({__init__:function(e,t,n,r){this.$super(e,t,n,r),this.sceneNode=null,this._pendingChildren=[]},__classvars__:{implementationName:"three.js"},reset:function(){if(this.sceneNode!=null){TundraSDK.framework.events.send("EC_Placeable."+this.parentEntity.id+"."+this.id+".AboutToBeDestroyed",this,this.sceneNode);var e=this.sceneNode.parent;e!==undefined&&e!==null&&e.remove(this.sceneNode)}this.sceneNode=null},update:function(){var e=TundraSDK.framework.renderer;if(this.sceneNode==null){this.sceneNode=e.createSceneNode(),this.sceneNode.name=this.parentEntity.name,this.sceneNode.tundraEntityId=this.parentEntity.id,this.sceneNode.tundraComponentId=this.id,this._setVisible(this.attributes.visible.get()),e.scene.add(this.sceneNode),this.checkParent(),e.updateSceneNode(this.sceneNode,this.transform);for(var t=0;t<this._pendingChildren.length;t++)this.addChild(this._pendingChildren[t]);this._pendingChildren=[],TundraSDK.framework.events.send("EC_Placeable."+this.parentEntity.id+"."+this.id+".SceneNodeCreated",this,this.sceneNode);return}this.checkParent(),e.updateSceneNode(this.sceneNode,this.transform)},attributeChanged:function(e,t,n){switch(e){case 0:this.sceneNode!=null&&TundraSDK.framework.client.renderer.updateSceneNode(this.sceneNode,n);break;case 1:break;case 2:this._setVisible(n);break;case 3:break;case 4:this.checkParent();break;case 5:break;default:}},onSceneNodeCreated:function(e,t){return this.hasParentEntity()?TundraSDK.framework.events.subscribe("EC_Placeable."+this.parentEntity.id+"."+this.id+".SceneNodeCreated",e,t):(this.log.error("Cannot subscribe onSceneNodeCreated, parent entity not set!"),null)},onAboutToBeDestroyed:function(e,t){return this.hasParentEntity()?TundraSDK.framework.events.subscribe("EC_Placeable."+this.parentEntity.id+"."+this.id+".AboutToBeDestroyed",e,t):(this.log.error("Cannot subscribe onAboutToBeDestroyed, parent entity not set!"),null)},addChild:function(e){if(e===undefined||e===null)return;if(e instanceof EC_Placeable){this.addChild(e.sceneNode);return}this.sceneNode!=null?(this.sceneNode.add(e),this.updateVisibility(),e.updateMatrix()):this._pendingChildren.push(e)},_applyParentChain:function(e,t){var n=this.sceneNode.parent;while(n!==null&&n!==undefined&&n instanceof THREE.Scene==0)e instanceof THREE.Vector3?e.add(n[t]):e instanceof THREE.Quaternion&&e.multiply(n[t].clone().normalize()),n=n.parent},distanceTo:function(e){var t=e instanceof THREE.Vector3?e:undefined;if(t===undefined){var n=e instanceof Entity?e.placeable:e instanceof EC_Placeable?e:undefined;n!=null&&(t=n.worldPosition())}return t!==undefined?this.worldPosition().distanceTo(t):undefined},position:function(){return this.attributes.transform.get().pos.clone()},setPosition:function(e,t,n,r){var i=this.attributes.transform.get();i.setPosition(e,t,n);var s=typeof e!="number"?t:r;return this.attributes.transform.set(i,s)},worldPosition:function(){if(this.sceneNode==null)return null;var e=this.sceneNode.position.clone();return this._applyParentChain(e,"position"),e},setWorldPosition:function(e){var t=this.attributes.transform.get(),n=this.parentRef!==""?this.transform.pos.clone():new THREE.Vector3(0,0,0);t.pos=e.sub(n),this.attributes.transform.set(t)},scale:function(){return this.attributes.transform.get().scale.clone()},setScale:function(e,t,n,r){var i=this.attributes.transform.get();i.setScale(e,t,n);var s=typeof e!="number"?t:r;return this.attributes.transform.set(i,s)},rotation:function(){return this.attributes.transform.get().rot.clone()},setRotation:function(e,t,n,r){var i=this.attributes.transform.get();i.setRotation(e,t,n);var s=typeof e!="number"?t:r;return this.attributes.transform.set(i,s)},checkParent:function(){if(this.sceneNode==null||this.parentEntity==null||this.parentScene==null)return;this._componentAddedSub!==undefined&&(TundraSDK.framework.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=undefined);if(this.parentRef!==""){var e=null;e=this.parentScene.entityByName(this.parentRef);if(e==null){var t=parseInt(this.parentRef);isNaN(t)||(e=this.parentScene.entityById(t))}if(e!=null){if(e.placeable!=null){e.placeable.addChild(this);return}this._componentAddedSub=e.onComponentCreated(this,this._onParentPlaceableEntityComponentCreated)}}this.removeParent()},removeParent:function(){if(this.sceneNode==null||this.parentEntity==null||this.parentScene==null)return;this.sceneNode.parent!==undefined&&this.sceneNode.parent!==null&&this.sceneNode.parent!==TundraSDK.framework.renderer.scene&&(TundraSDK.framework.renderer.scene.add(this.sceneNode),TundraSDK.framework.client.renderer.updateSceneNode(this.sceneNode,this.transform))},_onParentPlaceableEntityComponentCreated:function(e,t){t!=null&&t.typeName==="EC_Placeable"&&this.checkParent()},updateVisibility:function(){this._setVisible(this.attributes.visible.get())},_setVisible:function(e){if(this.sceneNode==null)return;this.sceneNode.traverse(function(t){if(t instanceof THREE.PerspectiveCamera)return;if(e&&t.tundraEntityId!==undefined){var n=TundraSDK.framework.scene.entityById(t.tundraEntityId),r=n!=null?t.tundraComponentId!==undefined?n.componentById(t.tundraComponentId):n.placeable:null;if(r!=null&&!r.visible)return}t.visible=e})},lookAt:function(e){var t=this.attributes.transform.get();e instanceof THREE.Vector3?t.lookAt(this.worldPosition(),e):t.lookAt(this.worldPosition(),e.placeable.worldPosition()),this.transform=t},orientation:function(){return this.attributes.transform.get().orientation()},worldOrientation:function(){if(this.sceneNode==null)return null;var e=this.sceneNode.quaternion.clone();return this._applyParentChain(e,"quaternion"),e.normalize()},worldTransform:function(){var e=this.transform.clone();return e.pos=this.worldPosition(),e},setWorldTransform:function(e){var t=this.attributes.transform.get(),n=this.parentRef!==""?this.transform.pos.clone():new THREE.Vector3(0,0,0);t=e,t.pos.add(n),this.attributes.transform.set(t)}}),ThreeJsRenderer=IRenderSystem.$extend({__init__:function(){this.$super("three.js"),this.log=TundraLogging.getLogger("ThreeJsRenderer")},load:function(e){this.windowSize={width:TundraSDK.framework.client.container.width(),height:TundraSDK.framework.client.container.height()};try{this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setSize(this.windowSize.width,this.windowSize.height),this.renderer.sortObjects=!0,this.renderer.physicallyBasedShading=!0}catch(t){this.renderer=null,this.log.error("Failed to initialize WebGL rendering, aborting startup:",t);return}this.setupShadows({enabled:!0,softShadows:!0,drawDebug:!1,clip:{near:50,far:1e3},textureSize:{width:2048,height:2048},bounds:{right:30,left:-30,top:20,bottom:-20}}),this.cssRenderer=null,this.cssRendererScene=null,this.scene=null,this.activeCameraComponent=null,this.camera=null,this.projector=new THREE.Projector,parseInt(THREE.REVISION)>68&&(this.projector.pickingRay=this._threeProjectorPickingRay.bind(this.projector)),this.raycaster=new THREE.Raycaster,this.raycastResult=new RaycastResult,this.raycastResult._raycastVector=new THREE.Vector3(0,0,0),this.raycastFromResult=new RaycastResult,this.meshes=[],this.axisX=new THREE.Vector3(1,0,0),this.axisY=new THREE.Vector3(0,1,0),this.axisZ=new THREE.Vector3(0,0,1),TundraSDK.framework.client.container.append(this.renderer.domElement),window.addEventListener("resize",this.onWindowResize,!1),this.materialWhite=new THREE.MeshPhongMaterial({color:this.convertColor("rgb(240,240,240)"),wireframe:!1}),this.materialWhite.name="tundra.MaterialLibrary.SolidWhite",this.materialLoadError=new THREE.MeshPhongMaterial({color:this.convertColor("rgb(240,50,50)"),wireframe:!1}),this.materialLoadError.name="tundra.MaterialLibrary.LoadError",this.registerAssetFactories(),this.registerComponents()},postInitialize:function(){this._sceneObjects={},this._meshLoadedSubs={},this._trackingKey="",TundraSDK.framework.scene.onComponentCreated(this,this.onSceneComponentCreated),TundraSDK.framework.scene.onComponentRemoved(this,this.onSceneComponentRemoved)},unload:function(){},onSceneComponentCreated:function(e,t){t.typeId===17&&(this._trackingKey=e.id+"."+t.id,this._meshLoadedSubs[this._trackingKey]=t.onMeshLoaded(this,this.onSceneMeshLoaded))},onSceneComponentRemoved:function(e,t){if(t.typeId!==17)return;this._trackingKey=e.id+"."+t.id,this._sceneObjects[this._trackingKey]!==undefined&&delete this._sceneObjects[this._trackingKey]},onSceneMeshLoaded:function(e,t,n){this._trackingKey=e.id+"."+t.id,this._sceneObjects[this._trackingKey]=[];for(var r=0,i=n.numSubmeshes();r<i;++r){var s=n.getSubmesh(r);s!==undefined&&s!==null&&this._sceneObjects[this._trackingKey].push(s)}this._meshLoadedSubs[this._trackingKey]!==undefined&&(TundraSDK.framework.events.unsubscribe(this._meshLoadedSubs[this._trackingKey]),delete this._meshLoadedSubs[this._trackingKey])},_getAllObjects:function(){var e=[];for(var t in this._sceneObjects)e=e.concat(this._sceneObjects[t]);return e},registerAssetFactories:function(){TundraSDK.framework.asset.registerAssetFactory(new AssetFactory("ThreeJsonMesh",ThreeJsonAsset,{".3geo":"json",".json":"json",".js":"json"},"json")),TundraSDK.framework.asset.registerAssetFactory(new AssetFactory("ObjMesh",ObjMeshAsset,{".obj":"text"}))},registerComponents:function(){Scene.registerComponent(9,"EC_Fog",EC_Fog_ThreeJs),Scene.registerComponent(14,"EC_AnimationController",EC_AnimationController_ThreeJs),Scene.registerComponent(15,"EC_Camera",EC_Camera_ThreeJs),Scene.registerComponent(17,"EC_Mesh",EC_Mesh_ThreeJs),Scene.registerComponent(20,"EC_Placeable",EC_Placeable_ThreeJs)},getCssRenderer:function(){if(this.cssRenderer==null){this.cssRenderer=new THREE.CSS3DRenderer,this.cssRenderer.setSize(this.windowSize.width,this.windowSize.height);var e=$(this.cssRenderer.domElement),t=$(this.renderer.domElement);e.css({"background-color":"transparent",position:"absolute",top:0,margin:0,padding:0,"z-index":1}),t.css({"background-color":"transparent",position:"absolute",top:0,margin:0,padding:0,"z-index":1}),TundraSDK.framework.client.container.append(e),e.append(t)}return this.cssRenderer},getCssRendererScene:function(){return this.cssRenderer==null&&this.getCssRenderer(),this.cssRendererScene==null&&(this.cssRendererScene=new THREE.Scene),this.cssRendererScene},onWindowResize:function(e){var t=TundraSDK.framework.client.renderer;t.windowSize={width:TundraSDK.framework.client.container.width(),height:TundraSDK.framework.client.container.height()},t.renderer.setSize(t.windowSize.width,t.windowSize.height),t.cssRenderer!=null&&t.cssRenderer.setSize(t.windowSize.width,t.windowSize.height),t.camera!==undefined&&t.camera!==null&&(t.camera.aspect=t.windowSize.width/t.windowSize.height,t.camera.updateProjectionMatrix())},reset:function(){if(this.scene!=null){while(this.scene.children.length>0){var e=this.scene.children[0];e instanceof THREE.Mesh&&(this.log.debug(e.name),e.material!=null&&(e.material instanceof THREE.MeshBasicMaterial?(e.material.map!=null&&(this.log.debug("  map"),e.material.map.dispose(),e.material.map=null),e.material.lightMap!=null&&(this.log.debug("  lightMap"),e.material.lightMap.dispose(),e.material.lightMap=null),e.material.specularMap!=null&&(this.log.debug("  specularMap"),e.material.specularMap.dispose(),e.material.specularMap=null),e.material.envMap!=null&&(this.log.debug("  envMap"),e.material.envMap.dispose(),e.material.envMap=null)):e.material instanceof THREE.ShaderMaterial&&e.material.uniforms!=null&&(e.material.uniforms["tCube"]!=null&&e.material.uniforms["tCube"].value!=null&&(this.log.debug("  uniform tCube"),e.material.uniforms.tCube.value.dispose(),e.material.uniforms.tCube.value=null),e.material.uniforms["map"]!=null&&e.material.uniforms["map"].value!=null&&(this.log.debug("  uniform map"),e.material.uniforms.map.value.dispose(),e.material.uniforms.map.value=null),e.material.uniforms["normalMap"]!=null&&e.material.uniforms["normalMap"].value!=null&&(this.log.debug("  uniform normalMap"),e.material.uniforms.normalMap.value.dispose(),e.material.uniforms.normalMap.value=null)),this.log.debug("  material"),e.material.dispose(),e.material=null),e.geometry!=null&&(this.log.debug("  geometry"),e.geometry.dispose(),e.geometry=null)),this.scene.remove(e),e=null}delete this.scene,this.scene=null}this.scene=new THREE.Scene,this.ambientLight=this.createLight("ambient"),this.ambientLight.color=this.defaultSceneAmbientLightColor().toThreeColor(),this.scene.add(this.ambientLight)},setupShadows:function(e){if(this.renderer==null||e===undefined)return;this.shadowSettings===undefined&&(this.shadowSettings={},this.shadowSettings.shadowCastingLights=0),e.enabled!==undefined&&(this.shadowSettings.enabled=e.enabled),e.softShadows!==undefined&&(this.shadowSettings.softShadows=e.softShadows),e.textureSize!==undefined&&(this.shadowSettings.textureSize=e.textureSize),e.clip!==undefined&&(this.shadowSettings.clip=e.clip),e.bounds!==undefined&&(this.shadowSettings.bounds=e.bounds),e.drawDebug!==undefined&&(this.shadowSettings.drawDebug=e.drawDebug),this.renderer.shadowMapEnabled=this.shadowSettings.enabled===!0&&this.shadowSettings.shadowCastingLights>0,this.renderer.shadowMapType=this.shadowSettings.softShadows===!0?THREE.PCFSoftShadowMap:THREE.PCFShadowMap,this.renderer.shadowMapDebug=this.shadowSettings.drawDebug,TundraSDK.framework.events.send("ThreeJsRenderer.ShadowSettingsChanged",this.shadowSettings)},shadowCastingLightsChanged:function(){this.shadowSettings.shadowCastingLights=0;for(var e=0,t=this.scene.__lights.length;e<t;e++){var n=this.scene.__lights[e];if(!n.castShadow)continue;n instanceof THREE.SpotLight&&this.shadowSettings.shadowCastingLights++,n instanceof THREE.DirectionalLight&&!n.shadowCascade&&this.shadowSettings.shadowCastingLights++}this.setupShadows({enabled:this.shadowSettings.enabled});var r=this._getAllObjects();for(var i=0,s=r.length;i<s;i++)r[i]!=null&&r[i].material!==undefined&&r[i].material!==null&&(r[i].material.needsUpdate=!0)},onShadowSettingsChanged:function(e,t){return TundraSDK.framework.events.subscribe("ThreeJsRenderer.ShadowSettingsChanged",e,t)},defaultSceneAmbientLightColor:function(){return new Color(.364,.364,.364,1)},getAllMeshes:function(){if(this.meshes.length==0){var e=TundraSDK.framework.client.scene.components("Mesh");for(var t=0;t<e.length;++t){var n=e[t];if(n.meshAsset!=null&&n.meshAsset.mesh!=null)for(var r=0;r<n.meshAsset.numSubmeshes();++r)this.meshes.push(n.meshAsset.getSubmesh(r))}}return this.meshes},update:function(e,t){this.raycastResult.reset(),this.meshes.length>0&&(this.meshes=[]),THREE.AnimationHandler.update(t),this.render()},render:function(){if(this.scene===undefined||this.scene===null)return;if(this.camera===undefined||this.camera===null)return;this.renderer.render(this.scene,this.camera);if(this.cssRenderer!=null&&this.cssRendererScene!=null){var e=TundraSDK.framework.scene.components("EC_WebBrowser");for(var t=0,n=e.length;t<n;t++)e[t].updateCssObjectTransform();this.cssRenderer.render(this.cssRendererScene,this.camera)}},raycastAllFrom:function(e,t,n,r,i,s){return this.raycastFrom(e,t,n,r,i,s,!0)},raycastFrom:function(e,t,n,r,i,s,o){n=typeof n=="number"?n:1,i=typeof i=="boolean"?i:!1,s=typeof s=="boolean"?s:!1,o=typeof o=="boolean"?o:!1,this.raycastFromResult.reset(),this.raycastFromResult.setExecutionInfo(-1,-1,n),this.raycastFromResult.origin===undefined&&(this.raycastFromResult.origin=new THREE.Vector3),this.raycastFromResult.origin.copy(e),this.raycastFromResult.direction===undefined&&(this.raycastFromResult.direction=new THREE.Vector3),this.raycastFromResult.direction.copy(t),r===undefined&&(r=this._getAllObjects());if(r.length===0)return this.raycastFromResult;this.raycaster.set(e,t);var u=this.raycaster.intersectObjects(r,s);return this._raycastResults(this.raycaster,u,this.raycastFromResult,n,i,o)},raycastAll:function(e,t,n,r,i,s){return this.raycast(e,t,n,r,i,s,!0)},raycast:function(e,t,n,r,i,s,o){e=typeof e=="number"?e:TundraSDK.framework.input.mouse.x,t=typeof t=="number"?t:TundraSDK.framework.input.mouse.y,n=typeof n=="number"?n:1,i=typeof i=="boolean"?i:!1,s=typeof s=="boolean"?s:!1,o=typeof o=="boolean"?o:!1;var u=!1;this.raycastResult._ignoreECModel!==undefined&&this.raycastResult._ignoreECModel!==i?u=!0:this.raycastResult._all!==undefined&&this.raycastResult._all!==o&&(u=!0);if(!u&&r===undefined&&!this.raycastResult.hasError()&&this.raycastResult.executionMatches(e,t,n))return this.raycastResult;this.raycastResult.reset();if(this.camera===undefined||this.camera===null)return this.raycastResult.setError("No active rendering camera set"),this.raycastResult;if(typeof n!="number")return this.raycastResult.setError("given selectionLayer is not a number"),this.raycastResult;if(typeof e!="number"||typeof t!="number")return this.raycastResult.setError("given x and/or y is not a number"),this.raycastResult;if(e>this.windowSize.width||t>this.windowSize.height)return this.raycastResult.setError("x and/or y screen position out of bounds"),this.raycastResult;r===undefined&&(r=this._getAllObjects());if(r.length===0)return this.raycastResult;this.raycastResult.setExecutionInfo(e,t,n),this.raycastResult._ignoreECModel=i,this.raycastResult._all=o,this.raycastResult._raycastVector.x=e/this.windowSize.width*2-1,this.raycastResult._raycastVector.y=-(t/this.windowSize.height)*2+1,this.raycastResult._raycastVector.z=0;var a=this.projector.pickingRay(this.raycastResult._raycastVector,this.camera),f=a.intersectObjects(r,s);return this._raycastResults(a,f,this.raycastResult,n,i,o)},_threeProjectorPickingRay:function(e,t){e.z=-1;var n=new THREE.Vector3(e.x,e.y,1);return e.unproject(t),n.unproject(t),n.sub(e).normalize(),new THREE.Raycaster(e,n)},_raycastResults:function(e,t,n,r,i,s){var o=s?[]:undefined;for(var u=0,a=t.length;u<a;++u){var f=t[u];if(f.object instanceof THREE.Mesh||f.object instanceof THREE.SkinnedMesh)if(!i&&f.object.parent!=null&&f.object.parent.tundraEntityId!=null){var l=TundraSDK.framework.scene.entityById(f.object.parent.tundraEntityId);if(l!=null){if(l.placeable!=null){if(!l.placeable.visible)continue;if(l.placeable.selectionLayer!==r)continue}n.setPosition(f.point),n.distance=f.distance,n.faceIndex=f.faceIndex,n.ray=e.ray.clone(),f.object.tundraSubmeshIndex!==undefined&&(n.submeshIndex=f.object.tundraSubmeshIndex),n.entity=l,n.component=l.getComponent("EC_Mesh");if(o===undefined)break;o.push(n.clone())}}else if(i){n.setPosition(f.point),n.distance=f.distance,n.faceIndex=f.faceIndex,n.ray=e.ray.clone();if(o===undefined)break;o.push(n.clone())}}return o!==undefined?o:n},createLight:function(e,t,n,r){t!==undefined&&(t=this.convertColor(t)),n===undefined&&(n=1),r===undefined&&(r=0);var i=null;return e=="point"?i=new THREE.PointLight(t,n,r):e=="directional"?i=new THREE.DirectionalLight(t,n,r):e=="spot"?i=new THREE.SpotLight(t,n,r,!0):e=="ambient"&&(i=new THREE.AmbientLight(t)),i},convertColor:function(e){if(e===undefined)return undefined;if(e.substr(0,1)==="#")return e;var t=/(.*?)rgb\((\d+),(\d+),(\d+)\)/.exec(e),n=parseInt(t[2]),r=parseInt(t[3]),i=parseInt(t[4]);return i|r<<8|n<<16},onActiveCameraChanged:function(e,t){return TundraSDK.framework.events.subscribe("ThreeJsRenderer.ActiveCameraChanged",e,t)},setActiveCamera:function(e){if(e===null)return this.activeCameraComponent!==undefined&&this.activeCameraComponent!==null&&(this.activeCameraComponent.active=!1),this.camera=null,this.activeCameraComponent=null,!0;if(e instanceof EC_Camera_ThreeJs){var t=undefined;return this.activeCameraComponent!==undefined&&this.activeCameraComponent!==null&&(this.activeCameraComponent.active=!1,t=this.activeCameraComponent),this.camera=e.camera,this.activeCameraComponent=e,this.activeCameraComponent.active=!0,TundraSDK.framework.events.send("ThreeJsRenderer.ActiveCameraChanged",this.activeCameraComponent,t),t=undefined,!0}return this.log.error("[ThreeJsRenderer]: setActiveCamera called with non EC_Camera_ThreeJs component!",e),!1},activeCamera:function(){return this.activeCameraComponent},activeCameraEntity:function(){return this.activeCameraComponent!=null?this.activeCameraComponent.parentEntity:null},createSceneNode:function(){var e=new THREE.Object3D;return e.matrixAutoUpdate=!1,e},updateSceneNode:function(e,t){if(e==null)return;e.matrixAutoUpdate===!0&&(e.matrixAutoUpdate=!1),e.position.x=t.pos.x,e.position.y=t.pos.y,e.position.z=t.pos.z,e.quaternion=t.orientation(),e.scale.x=t.scale.x,e.scale.y=t.scale.y,e.scale.z=t.scale.z;if(e.scale.x<1e-7||e.scale.y<1e-7||e.scale.z<1e-7)this.log.warn("Fixing negative/zero scale",e.scale.toString(),"for object",e.name),e.scale.x<1e-7&&(e.scale.x=1e-7),e.scale.y<1e-7&&(e.scale.y=1e-7),e.scale.z<1e-7&&(e.scale.z=1e-7);e.updateMatrix()}});THREE.Box2.prototype.toString=function(){return"(min: "+this.min+" max: "+this.max+")"},THREE.Box3.prototype.toString=function(){return"(min: "+this.min+" max: "+this.max+")"},THREE.Color.prototype.toString=function(){return"("+this.r+", "+this.g+", "+this.b+")"},THREE.Euler.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+" "+this.order+")"},THREE.Vector2.prototype.toString=function(){return"("+this.x+", "+this.y+")"},THREE.Vector3.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"},THREE.Vector4.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+", "+ +this.w+")"},THREE.Quaternion.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+", "+this.w+")"},THREE.Matrix3.prototype.toString=function(){var e=this.elements;return"("+e[0]+", "+e[3]+", "+e[6]+") "+"("+e[1]+", "+e[4]+", "+e[7]+") "+"("+e[2]+", "+e[5]+", "+e[8]+")"},THREE.Matrix4.prototype.toString=function(){var e=this.elements;return"("+e[0]+", "+e[4]+", "+e[8]+", "+e[12]+") "+"("+e[1]+", "+e[5]+", "+e[9]+", "+e[13]+") "+"("+e[2]+", "+e[6]+", "+e[10]+" ,"+e[14]+") "+"("+e[3]+", "+e[7]+", "+e[11]+" ,"+e[15]+")"};

var tundra = tundra || {};

tundra.createWebTundraClient = function(params) {
    if (params === undefined || params === null)
        params = {};
    if (params.renderSystem === undefined)
        params.renderSystem = ThreeJsRenderer;

    // Instantiate the client
    tundra.client = new TundraClient(params);
    tundra.TundraSDK = TundraSDK;

    return tundra.client;
}

